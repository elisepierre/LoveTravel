<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Love Travel ‚úàÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #ff4b6e; --secondary: #4a90e2; --bg: #f4f7f6; --card-bg: #ffffff; --text: #2c3e50; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background-color: var(--bg); color: var(--text); padding-top: 110px; padding-bottom: 80px; }
        
        /* HEADER AVEC AVION */
        #flight-header { position: fixed; top: 0; left: 0; width: 100%; background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; padding: 10px 15px; z-index: 1000; box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3); border-bottom: 4px solid white; }
        .header-top { display: flex; justify-content: space-between; font-size: 0.75rem; text-transform: uppercase; opacity: 0.9; margin-bottom: 5px; }
        .countdown-main { font-size: 1rem; font-weight: 700; text-align: center; margin-bottom: 5px; }
        .progress-track { background: rgba(255,255,255,0.3); height: 6px; border-radius: 10px; position: relative; margin-top: 5px;}
        .progress-fill { background: #fff; height: 100%; width: 0%; border-radius: 10px; transition: width 1s ease; }
        .plane-icon { position: absolute; top: -7px; font-size: 14px; transition: left 1s ease; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); transform: rotate(90deg); }

        .container { max-width: 600px; margin: 0 auto; padding: 0 15px; }
        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-title { font-size: 1rem; font-weight: 700; color: var(--secondary); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px;}

        /* IDENTIT√â */
        .identity-selector { text-align: center; margin-bottom: 20px; background: white; padding: 10px; border-radius: 15px; margin-top: -10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .identity-btn { padding: 8px 20px; border: 1px solid var(--secondary); background: transparent; border-radius: 20px; margin: 0 5px; cursor: pointer; font-size: 0.9rem;}
        .identity-btn.active { background: var(--secondary); color: white; font-weight: bold; box-shadow: 0 2px 5px rgba(74, 144, 226, 0.4); }

        /* MOOD */
        .mood-display { display: flex; justify-content: space-between; text-align: center; margin-bottom: 15px; }
        .mood-box { flex: 1; }
        .mood-avatar { font-size: 3rem; margin-bottom: 5px; transition: transform 0.2s; }
        .mood-label { font-size: 0.7rem; color: #888; letter-spacing: 1px; font-weight: bold;}
        .mood-controls { display: flex; gap: 15px; justify-content: center; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .mood-opt { font-size: 1.8rem; cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .mood-opt:hover { opacity: 1; transform: scale(1.2); }

        /* LIVRES */
        .book-item { background: #f9f9f9; padding: 12px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--secondary); }
        .book-title { font-weight: 700; font-size: 0.95rem; color: #333; }
        .book-prog { font-size: 0.75rem; color: #777; margin-top: 4px; }
        .btn-del { background: #ff4b6e; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;}
        .input-group { display: flex; gap: 8px; margin-bottom: 15px; }
        .input-field { flex: 1; padding: 12px; border: 1px solid #eee; background: #f8f8f8; border-radius: 12px; font-size: 1rem; }
        .btn-add { background: var(--secondary); color: white; border: none; border-radius: 12px; padding: 0 20px; font-weight: bold; cursor: pointer; }

        /* PLAYLIST */
        .playlist-container iframe { border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* BISOU BUTTON */
        #bisou-btn { position: fixed; bottom: 25px; right: 25px; width: 75px; height: 75px; border-radius: 50%; background: var(--primary); color: white; border: none; font-size: 32px; box-shadow: 0 8px 25px rgba(255, 75, 110, 0.5); cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; animation: pulse 2s infinite; }
        #bisou-btn:active { transform: scale(0.9); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 75, 110, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0); } }

        /* NOTIF POPUP */
        #notif { position: fixed; top: 130px; left: 50%; transform: translateX(-50%) translateY(-20px); background: white; padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 2000; display: none; font-weight: bold; color: var(--primary); width: 90%; max-width: 300px; text-align: center; opacity: 0; transition: 0.3s; border: 2px solid var(--primary); }
        #notif.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>

    <div id="notif">üíã Bisou re√ßu de Ta√Øwan !</div>

    <header id="flight-header">
        <div class="header-top">
            <span>üá´üá∑ Clermont</span>
            <span>‚úàÔ∏è Love Travel</span>
            <span>Taoyuan üáπüáº</span>
        </div>
        <div class="countdown-main" id="countdown">Calcul du vol...</div>
        <div class="progress-track">
            <div class="progress-fill" id="prog-fill"></div>
            <div class="plane-icon" id="plane" style="left:0">‚úàÔ∏è</div>
        </div>
    </header>

    <div class="container">
        
        <div class="identity-selector">
            <p style="font-size: 0.8rem; color:#888; margin: 5px 0 10px;">Qui utilise ce t√©l√©phone ?</p>
            <button class="identity-btn" id="btn-user-fr" onclick="setUser('fr')">Moi (France)</button>
            <button class="identity-btn" id="btn-user-tw" onclick="setUser('tw')">Lui (Ta√Øwan)</button>
        </div>

        <div class="card">
            <div class="card-title">üå°Ô∏è M√©t√©o des C≈ìurs</div>
            <div class="mood-display">
                <div class="mood-box">
                    <div class="mood-avatar" id="mood-display-fr">‚è≥</div>
                    <div class="mood-label">FRANCE</div>
                </div>
                <div style="width: 1px; background: #eee; margin: 0 10px;"></div>
                <div class="mood-box">
                    <div class="mood-avatar" id="mood-display-tw">‚è≥</div>
                    <div class="mood-label">TA√èWAN</div>
                </div>
            </div>
            <p style="text-align: center; font-size: 0.75rem; color:#aaa; margin-top:5px;">Comment te sens-tu maintenant ?</p>
            <div class="mood-controls">
                <span class="mood-opt" onclick="updateMood('ü•∞')">ü•∞</span>
                <span class="mood-opt" onclick="updateMood('üò¥')">üò¥</span>
                <span class="mood-opt" onclick="updateMood('üò≠')">üò≠</span>
                <span class="mood-opt" onclick="updateMood('ü•µ')">ü•µ</span>
                <span class="mood-opt" onclick="updateMood('üçú')">üçú</span>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üìö Biblioth√®que Partag√©e</div>
            <div class="input-group">
                <input type="text" id="book-input" class="input-field" placeholder="Titre du livre...">
                <button onclick="addBook()" class="btn-add">+</button>
            </div>
            <div id="book-list">
                <div style="text-align:center; color:#ccc; padding: 20px;">Chargement des livres...</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üéß Musique de bord</div>
            <div class="playlist-container">
                <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M?utm_source=generator" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
            </div>
        </div>
        
    </div>

    <button id="bisou-btn" onclick="sendBisou()">üíã</button>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- 1. CONFIGURATION (Tes cl√©s sont ici !) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7ZNlC1ILS9-W3bgxWogUA6ak4c29a4Ns",
            authDomain: "lovetravel-35285.firebaseapp.com",
            projectId: "lovetravel-35285",
            storageBucket: "lovetravel-35285.firebasestorage.app",
            messagingSenderId: "189902268760",
            appId: "1:189902268760:web:b461ce15d8c396be479d2d"
        };

        // Initialisation
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. GESTION UTILISATEUR ---
        let currentUser = localStorage.getItem('userRole') || 'fr'; // D√©faut FR
        updateIdentityUI();

        function setUser(role) {
            currentUser = role;
            localStorage.setItem('userRole', role);
            updateIdentityUI();
            alert("R√¥le enregistr√© : " + (role === 'fr' ? "France üá´üá∑" : "Ta√Øwan üáπüáº"));
        }

        function updateIdentityUI() {
            document.getElementById('btn-user-fr').classList.remove('active');
            document.getElementById('btn-user-tw').classList.remove('active');
            document.getElementById('btn-user-' + currentUser).classList.add('active');
        }

        // --- 3. SYNCHRO HUMEUR (Moods) ---
        // On √©coute la base de donn√©es
        db.collection("status").doc("moods").onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                document.getElementById("mood-display-fr").innerText = data.fr || "üò∂";
                document.getElementById("mood-display-tw").innerText = data.tw || "üò∂";
            } else {
                // Cr√©ation initiale si le document n'existe pas encore
                db.collection("status").doc("moods").set({ fr: "‚ù§Ô∏è", tw: "‚ù§Ô∏è" });
            }
        });

        function updateMood(emoji) {
            db.collection("status").doc("moods").set({
                [currentUser]: emoji
            }, { merge: true });
            
            // Petit retour visuel imm√©diat
            const targetId = currentUser === 'fr' ? 'mood-display-fr' : 'mood-display-tw';
            document.getElementById(targetId).style.transform = "scale(1.5)";
            setTimeout(() => document.getElementById(targetId).style.transform = "scale(1)", 200);
        }

        // --- 4. SYNCHRO LIVRES ---
        db.collection("books").orderBy("created", "desc").onSnapshot((snapshot) => {
            const list = document.getElementById("book-list");
            list.innerHTML = "";
            
            if (snapshot.empty) {
                list.innerHTML = "<div style='text-align:center; color:#ccc; padding:10px;'>Aucun livre pour l'instant. Ajoutez-en un !</div>";
            }

            snapshot.forEach((doc) => {
                const book = doc.data();
                // On d√©termine qui a ajout√© le livre pour l'affichage
                const addedByLabel = book.by === 'fr' ? 'üá´üá∑ Elle' : 'üáπüáº Lui';
                
                list.innerHTML += `
                    <div class="book-item">
                        <div>
                            <div class="book-title">${book.title}</div>
                            <div class="book-prog">Ajout√© par ${addedByLabel}</div>
                        </div>
                        <button class="btn-del" onclick="deleteBook('${doc.id}')">‚úï</button>
                    </div>`;
            });
        });

        function addBook() {
            const input = document.getElementById("book-input");
            if (!input.value) return;
            
            db.collection("books").add({
                title: input.value,
                by: currentUser,
                created: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                console.log("Livre ajout√© !");
            }).catch((error) => {
                console.error("Erreur ajout livre: ", error);
                alert("Erreur : V√©rifie que ta base de donn√©es est bien en mode 'Test' dans la console Firebase.");
            });
            
            input.value = "";
        }

        function deleteBook(id) {
            if(confirm("Voulez-vous vraiment supprimer ce livre de la liste commune ?")) {
                db.collection("books").doc(id).delete();
            }
        }

        // --- 5. SYNCHRO BISOU (Temps r√©el) ---
        db.collection("actions").orderBy("timestamp", "desc").limit(1).onSnapshot((snapshot) => {
            if(!snapshot.empty) {
                const action = snapshot.docs[0].data();
                const now = Date.now();
                
                // Si le bisou a moins de 5 secondes et vient de l'autre personne
                if (now - action.timestamp < 5000 && action.from !== currentUser) {
                    showBisouNotif(action.from);
                }
            }
        });

        function sendBisou() {
            // Animation bouton
            const btn = document.getElementById('bisou-btn');
            btn.style.transform = "scale(1.3)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
            
            // Envoi Database
            db.collection("actions").add({
                type: 'bisou',
                from: currentUser,
                timestamp: Date.now()
            });
            
            // Feedback local
            const notif = document.getElementById("notif");
            notif.innerText = "üíã Bisou envoy√© !";
            notif.style.display = "block";
            setTimeout(() => notif.classList.add("show"), 10);
            setTimeout(() => {
                notif.classList.remove("show");
                setTimeout(() => notif.style.display = "none", 300);
            }, 2000);
        }

        function showBisouNotif(fromWho) {
            const notif = document.getElementById("notif");
            const senderName = fromWho === 'fr' ? "France" : "Ta√Øwan";
            notif.innerHTML = `üíã <b>${senderName}</b> t'envoie un bisou !`;
            
            notif.style.display = "block";
            setTimeout(() => notif.classList.add("show"), 10);
            
            // Vibration
            if(navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
            
            setTimeout(() => {
                notif.classList.remove("show");
                setTimeout(() => notif.style.display = "none", 300);
            }, 4000);
        }

        // --- 6. COMPTE √Ä REBOURS ---
        const startDate = new Date("2026-02-14T00:00:00").getTime();
        const endDate = new Date("2026-07-10T00:00:00").getTime();

        function updateCountdown() {
            const now = new Date().getTime();
            const total = endDate - startDate;
            const current = now - startDate;
            
            // Barre de progression
            let percent = 0;
            if (now > startDate) {
                percent = (current / total) * 100;
            }
            if (percent < 0) percent = 0; if (percent > 100) percent = 100;

            document.getElementById("prog-fill").style.width = percent + "%";
            
            // Position Avion
            // On s'assure que l'avion ne d√©passe pas de la barre (limite min/max)
            const planePos = Math.min(Math.max(percent, 0), 100);
            document.getElementById("plane").style.left = `calc(${planePos}% - 14px)`;

            // Texte
            const dist = endDate - now;
            const days = Math.floor(dist / (1000 * 60 * 60 * 24));
            const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            const display = document.getElementById("countdown");
            if (now < startDate) display.innerText = "En attente du 14 F√©vrier... ‚è≥";
            else if (dist < 0) display.innerText = "Retrouvailles ! ‚ù§Ô∏è";
            else display.innerText = `${days} jours et ${hours}h restants`;
        }
        
        setInterval(updateCountdown, 1000);
        updateCountdown();

    </script>
</body>
</html>
