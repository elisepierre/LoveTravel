<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Love Travel">
    <meta name="theme-color" content="#fff0f3">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    <link rel="icon" type="image/jpeg" href="icon.jpg">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <title>Love Travel ‚úàÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Pacifico&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --pink: #ff9eb5; --pink-dark: #ff4b6e;
            --blue: #8ecae6; --blue-dark: #219ebc;
            --bg-body: #fffbf0; --bg-card: #ffffff;
            --text-main: #4a4a4a; --text-sub: #888888;
            --border: #eeeeee; --input-bg: #fafafa;
            --shadow: rgba(0,0,0,0.05); --dot-pattern: #ffe4e1;
            --voyage-border: linear-gradient(135deg, var(--blue), var(--pink));
            --p-shadow: rgba(0,0,0,0.2);
            /* UNO PASTEL */
            --uno-red: #ffadad; --uno-blue: #a0c4ff; --uno-green: #caffbf; --uno-yellow: #fdffb6; --uno-black: #555;
        }
        body.dark-mode {
            --bg-body: #121212; --bg-card: #1e1e1e;
            --text-main: #e0e0e0; --text-sub: #aaaaaa;
            --border: #333333; --input-bg: #2c2c2c;
            --shadow: rgba(0,0,0,0.5); --dot-pattern: rgba(255,255,255,0.05);
            --p-shadow: rgba(0,0,0,0.5);
        }
        
        /* THEME FESTIF */
        body.birthday-theme {
            background-color: #fffdf5;
            background-image: radial-gradient(#ff9eb5 2px, transparent 2px), radial-gradient(#8ecae6 2px, transparent 2px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        body.dark-mode.birthday-theme {
            background-color: #151010;
            background-image: radial-gradient(#ff4b6e 2px, transparent 2px), radial-gradient(#219ebc 2px, transparent 2px);
        }

        /* THEME ST VALENTIN */
        body.love-theme {
            background-color: #fff0f5; /* Rose tr√®s p√¢l */
            /* Motif coeurs (SVG encod√© ou simple radial gradient simul√©) */
            background-image: radial-gradient(circle, #ffbcd9 20%, transparent 20%), radial-gradient(circle, #ffbcd9 20%, transparent 20%);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
        }
        body.dark-mode.love-theme {
            background-color: #2d0a12;
            background-image: radial-gradient(circle, #800020 20%, transparent 20%), radial-gradient(circle, #800020 20%, transparent 20%);
        }

        /* MODE DODO */
        body.is-sleeping::after {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 20, 0.4); /* Filtre nuit */
            pointer-events: none; z-index: 9990;
            backdrop-filter: grayscale(0.5);
            transition: 0.5s;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background-color: var(--bg-body); background-image: radial-gradient(var(--dot-pattern) 1px, transparent 1px); background-size: 20px 20px; color: var(--text-main); padding-bottom: 120px; transition: background 0.3s, color 0.3s; }
        
        header { display: flex; flex-direction: column; align-items: center; padding: 20px 20px 10px 20px; margin-bottom: 10px; }
        .header-top { display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .header-btn { background: var(--bg-card); border: 1px solid var(--border); width: 45px; height: 45px; border-radius: 50%; color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; box-shadow: 0 4px 10px var(--shadow); transition: 0.2s; }
        .app-title { font-family: 'Pacifico', cursive; font-size: 2.2rem; margin: 0; background: linear-gradient(to right, var(--blue-dark), var(--pink-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 0px rgba(255,255,255,0.2)); padding: 0 10px; line-height: 1.3; }
        
        .bd-subtitle { 
            font-family: 'Dancing Script', cursive; font-size: 1.3rem; color: var(--pink-dark); 
            margin-top: 5px; display: none; font-weight: bold; background: var(--bg-card); 
            padding: 5px 20px; border-radius: 20px; box-shadow: 0 4px 10px var(--shadow); 
            border: 1px solid var(--pink); transform: rotate(-2deg); z-index: 10; text-align: center;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        
        .card { background: var(--bg-card); border-radius: 25px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 25px var(--shadow); border: 1px solid var(--border); transition: 0.3s; overflow: hidden; }
        .card.voyage-card { padding: 25px 20px; }
        
        .card-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px dashed var(--border); padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px; cursor: pointer; user-select: none; }
        .card-title.toggleable::after { content: '‚ñº'; font-size: 0.8rem; color: var(--text-sub); transition: transform 0.3s ease; }
        .card-title.closed::after { transform: rotate(-90deg); }
        .card-title.closed { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }

        /* VOYAGE */
        .journey-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .place-name { display: block; font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--text-sub); margin-bottom: 5px; }
        .place-time { display: block; font-size: 1.6rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .place-weather { font-size: 0.8rem; color: var(--text-sub); margin-top: 5px; display: block; }
        .path-line { border-top: 2px dashed var(--text-sub); opacity: 0.3; width: 100%; position: relative; top: -10px; }
        .plane-icon { font-size: 1.5rem; position: relative; top: -24px; color: var(--text-main); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

        /* INDICATEUR ONLINE */
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-right: 5px; transition:0.3s; vertical-align: middle; }
        .status-dot.online { background: #2ecc71 !important; box-shadow: 0 0 10px #2ecc71; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* COMPTEUR */
        .countdown-compact { background: var(--input-bg); border-radius: 15px; padding: 15px; text-align: center; border: 1px solid var(--border); }
        .compact-title { font-size: 0.75rem; color: var(--text-sub); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .compact-counter { display: flex; align-items: baseline; justify-content: center; gap: 8px; color: var(--text-main); }
        .big-num { font-size: 2.2rem; font-weight: 800; color: var(--pink-dark); line-height: 1; }
        .unit { font-size: 1rem; font-weight: bold; color: var(--pink-dark); text-transform: uppercase; }
        .small-time { font-size: 1rem; font-weight: 600; color: var(--text-main); }
        .progress-container-modern { margin-top: 15px; position: relative; }
        .dates-row { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: bold; color: var(--text-sub); margin-bottom: 5px; }
        .prog-bar-mini { height: 8px; background: var(--border); border-radius: 10px; position: relative; width: 100%; }
        .prog-fill-mini { height: 100%; background: linear-gradient(90deg, var(--blue), var(--pink)); border-radius: 10px; width: 0%; transition: width 1s ease; }
        .prog-heart { position: absolute; top: -6px; font-size: 14px; transform: translateX(-50%); transition: left 1s ease; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }

        /* MOODS */
        
        /* 1. Le Conteneur Global */
        .mood-container {
            display: flex;
            justify-content: space-between;
            /* On aligne tout en haut pour que les t√™tes soient au m√™me niveau */
            align-items: flex-start; 
            gap: 5px;
            margin-bottom: 20px;
            position: relative;
        }
        
        /* 2. Les Colonnes Personnages (Th√©o / Elise) */
        .mood-person {
            flex: 1;           /* Prend la place dispo */
            min-width: 0;      /* MAGIE : Permet au texte de r√©tr√©cir sans casser la page */
            display: flex;
            flex-direction: column;
            align-items: center; /* Centre l'image et le texte horizontalement */
        }
        
        /* 3. La Zone Image (Hauteur fixe pour alignement parfait) */
        .avatar-frame {
            height: 130px; /* On fixe la hauteur pour que le rond soit centr√© par rapport √† √ßa */
            width: 100%;
            display: flex;
            align-items: flex-end; /* L'image se pose au bas du cadre */
            justify-content: center;
            margin-bottom: -15px; /* Permet √† la bulle de chevaucher un peu */
            z-index: 1;
        }
        
        .avatar-img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
        }
        
        /* 4. La Bulle de Texte (Encadr√© citation) */
        .mood-msg {
            position: relative;
            z-index: 10; /* IMPORTANT : Passe DEVANT l'image et le reste */
            
            background: var(--bg-card);
            padding: 8px 12px;
            border-radius: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            
            font-size: 0.8rem;
            font-style: italic;
            color: var(--text-main);
            text-align: center;
            line-height: 1.3;
            
            /* Gestion des textes longs */
            width: auto;
            max-width: 110%; /* Peut d√©passer un tout petit peu */
            min-width: 80px; /* Taille min pour ne pas dispara√Ætre */
            margin-top: 10px; /* Espace sous l'avatar */
        }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .mood-btn { background: var(--input-bg); border: 1px solid var(--border); border-radius: 15px; padding: 10px; text-align: center; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .mood-btn:active { transform: scale(0.95); }

        /* ELEMENTS COMMUNS */
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-field { flex: 1; min-width: 120px; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Outfit'; outline: none; background: var(--input-bg); color: var(--text-main); }
        .btn-action { background: var(--blue-dark); color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: bold; cursor: pointer; height: 45px; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; background: var(--text-sub); }

        /* JEUX */
        /* Ajout pour l'indicateur de jeu en cours */
        /* Pastille par d√©faut (Grise = Inactif) */
        .game-indicator {
            display: block;
            width: 8px; 
            height: 8px;
            background-color: #dcdcdc; /* Gris clair */
            border-radius: 50%;
            /* On enl√®ve opacity: 0 pour qu'elle soit toujours visible */
            opacity: 1; 
            transition: all 0.3s ease;
            flex-shrink: 0;
            border: 1px solid transparent; /* Pour √©viter un l√©ger d√©calage au changement de couleur */
        }
        
        /* Quand le jeu est actif (Vert + Animation) */
        .game-btn.is-running .game-indicator {
            background-color: #2ecc71; /* Vert */
            box-shadow: 0 0 5px #2ecc71;
            animation: pulse-dot 2s infinite;
        }
        
        /* L'animation reste la m√™me */
        @keyframes pulse-dot {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.95); opacity: 0.8; }
        }
        .game-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .game-btn { 
            flex: 1; 
            padding: 12px 5px; /* Un peu moins de padding lat√©ral pour laisser de la place */
            border-radius: 15px; 
            border: 1px solid var(--border); 
            background: var(--bg-card); 
            color: var(--text-main); 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s; 
            font-size: 0.9rem;
            box-shadow: 0 4px 5px rgba(0,0,0,0.05);
            
            /* --- CORRECTION ALIGNEMENT --- */
            display: flex;              /* Active le mode Flexbox */
            justify-content: center;    /* Centre tout horizontalement */
            align-items: center;        /* Centre tout verticalement */
            gap: 8px;                   /* Espace propre entre le texte et le point */
            white-space: nowrap;        /* Interdit le retour √† la ligne */
        }
        .game-btn:active { transform:scale(0.95); }
        .game-btn.active-game { border: 2px solid var(--pink-dark); background: #fff0f5; color: var(--pink-dark); }
        
        .game-block { display: none; background: var(--input-bg); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 20px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }
        .game-title-text { font-weight: 800; text-transform: uppercase; color: var(--text-main); display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .game-close-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-sub); }
        
        .score-pill { background: var(--bg-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: var(--pink-dark); }
        .status-msg { text-align: center; font-style: italic; color: var(--text-sub); margin: 10px 0; font-size: 0.9rem; min-height: 20px; }

        .history-box { margin-top: 15px; max-height: 100px; overflow-y: auto; font-size: 0.75rem; border-top: 1px solid var(--border); padding-top: 10px; }
        .hist-row { display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--text-sub); }
        .hist-win { color: #2ecc71; font-weight: bold; }
        .hist-loose { color: #e74c3c; font-weight: bold; }

        #pendu-canvas { display: block; margin: 0 auto; border-bottom: 2px solid var(--text-main); margin-bottom: 10px; width: 200px; height: 150px; }
        .pendu-word { font-size: 1.5rem; letter-spacing: 5px; font-weight: bold; margin: 15px 0; color: var(--text-main); text-align: center; }
        .keyboard { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
        .key-btn { width: 30px; height: 35px; border: 1px solid var(--border); border-radius: 5px; background: white; cursor: pointer; font-weight: bold; color: #333; }
        .key-btn:disabled { opacity: 0.3; background: #ddd; }
        
        .p4-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: #34495e; padding: 10px; border-radius: 10px; max-width: 300px; margin: 0 auto; }
        .p4-cell { aspect-ratio: 1/1; background: var(--bg-body); border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); transition: 0.2s; }
        .p4-cell.p1 { background: var(--blue); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .p4-cell.p2 { background: var(--pink); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }

        /* UNO */
        .uno-board { text-align: center; }
        .uno-top-info { display: flex; justify-content: center; gap: 15px; align-items: center; margin-bottom: 15px; font-size: 0.8rem; font-weight: bold; color: var(--text-sub); }
        .uno-table { background: rgba(0,0,0,0.03); border-radius: 20px; padding: 20px; min-height: 150px; display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .uno-card { width: 60px; height: 90px; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-weight: 800; font-size: 1.2rem; color: #555; text-shadow: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; user-select: none; border: 2px solid white; position: relative; transition:0.2s; }
        .uno-card:active { transform:scale(1.1); }
        .uno-card.red { background: var(--uno-red); }
        .uno-card.blue { background: var(--uno-blue); }
        .uno-card.green { background: var(--uno-green); }
        .uno-card.yellow { background: var(--uno-yellow); }
        .uno-card.black { background: var(--uno-black); color:white; }
        .uno-card.back { background: #333; background-image: repeating-linear-gradient(45deg, #444 0, #444 10px, #333 10px, #333 20px); color:transparent; }
        .uno-hand { display: flex; overflow-x: auto; padding: 10px; gap: 5px; min-height: 110px; background: rgba(255,255,255,0.5); border-radius: 15px; }
        
        /* UNO COLOR PICKER */
        #uno-color-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9000; justify-content:center; align-items:center; }
        .color-picker-box { background:white; padding:20px; border-radius:15px; text-align:center; }
        .cp-options { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:15px; }
        .cp-circle { width:60px; height:60px; border-radius:50%; cursor:pointer; border:2px solid #ddd; }

        /* PETIT BAC - ESTH√âTIQUE CORRIG√â */
        .bac-letter-sticky { 
            background: linear-gradient(135deg, var(--blue), var(--pink)); 
            color: white; padding: 8px 20px; 
            border-radius: 30px; display: inline-block; font-weight: 800; 
            margin-bottom: 15px; position: sticky; top: 0; z-index: 5; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-size: 1.1rem;
        }
        
        .bac-row { margin-bottom: 12px; text-align: left; }
        .bac-label { 
            font-size: 0.75rem; color: var(--pink-dark); 
            font-weight: 800; display: block; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 1px;
        }
        .bac-input { 
            width: 100%; padding: 12px; border: 2px solid var(--border); 
            border-radius: 12px; background: white; font-family: 'Outfit'; 
            transition: 0.2s; font-size: 1rem; color: var(--text-main);
        }
        .bac-input:focus { border-color: var(--pink); outline: none; }
        
        /* Correction Design */
        .review-item { 
            background: white; border: 1px solid var(--border); 
            padding: 15px; margin-bottom: 10px; border-radius: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .review-ans { font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin: 5px 0 10px 0; }
        .review-btns { display: flex; gap: 8px; justify-content: center; }
        .r-btn { 
            flex: 1; border: 1px solid #eee; padding: 10px; border-radius: 10px; 
            cursor: pointer; font-size: 0.9rem; font-weight: bold; color: var(--text-sub);
            background: var(--input-bg); transition: 0.2s;
        }
        
        /* COULEURS FORC√âES AVEC !IMPORTANT */
        .r-btn-0.selected { background: #ff7675 !important; color: white !important; border-color: #ff7675 !important; } /* Rouge */
        .r-btn-1.selected { background: var(--blue) !important; color: white !important; border-color: var(--blue) !important; } /* Bleu */
        .r-btn-2.selected { background: #55efc4 !important; color: white !important; border-color: #55efc4 !important; } /* Vert */

        /* TABLEAU R√âSULTATS PETIT BAC */
        .bac-res-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .bac-res-header { background: var(--pink-dark); color: white; font-weight: bold; }
        .bac-res-header th { padding: 8px; }
        .bac-res-row { border-bottom: 1px solid var(--border); }
        .bac-res-row td { padding: 8px 4px; vertical-align: middle; }
        .bac-res-cat { font-weight: 800; color: var(--blue-dark); font-size: 0.7rem; text-transform: uppercase; width: 20%; }
        .bac-res-ans { color: var(--text-main); line-height: 1.2; }
        .bac-badge { 
            display: inline-block; padding: 2px 6px; border-radius: 10px; 
            font-size: 0.7rem; font-weight: bold; color: white; margin-left: 4px;
        }
        .bg-0 { background: #ff7675; } /* Rouge */
        .bg-1 { background: var(--blue); } /* Bleu */
        .bg-2 { background: #55efc4; color: #333; } /* Vert */

        /* --- FIX DARK MODE PETIT BAC --- */
        /* --- FIX CONTRASTE PETIT BAC DARK MODE --- */
        body.dark-mode .review-item {
            background-color: #2d2d2d !important; /* Gris fonc√© */
            border: 1px solid #444 !important;
            box-shadow: none;
        }
        
        body.dark-mode .bac-label {
            color: #ff9eb5; /* Rose clair pour les cat√©gories */
        }
        
        body.dark-mode .review-ans {
            color: white !important; /* R√©ponse en blanc pur */
            text-shadow: 0 1px 2px black;
        }
        
        /* On am√©liore aussi les boutons de vote (0, 1, 2) en sombre */
        body.dark-mode .r-btn {
            background-color: #383838;
            color: #aaa;
            border-color: #555;
        }

        /* FIX PETIT BAC - SAISIE DARK MODE */
        body.dark-mode .bac-input {
            background-color: var(--input-bg); /* Fond gris fonc√© (#2c2c2c) */
            color: white !important;           /* Texte Blanc pur */
            border-color: #555;                /* Bordure plus discr√®te */
        }
        
        /* Optionnel : Couleur du texte d'aide (placeholder) */
        body.dark-mode .bac-input::placeholder {
            color: #777;
        }
        
        /* LETTRES */
        .mailbox-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .mailbox-tab { flex: 1; padding: 10px; text-align: center; border-radius: 12px; font-size: 0.8rem; font-weight: bold; cursor: pointer; opacity: 0.5; transition: 0.3s; color: var(--text-main); border: 1px solid var(--border); }
        .mailbox-tab.active { opacity: 1; color: white; border: none; box-shadow: 0 4px 10px var(--shadow); }
        .envelope-item { background: var(--input-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; align-items: center; cursor: pointer; transition: 0.3s; border-left: 5px solid #ccc; margin-bottom: 10px; }
        .envelope-item.unread { border-left-color: var(--pink-dark); background: rgba(255, 75, 110, 0.1); }
        #letter-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .real-letter { background: #fffdf0; width: 100%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column; padding: 30px; border-radius: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; background-image: radial-gradient(#e0e0e0 1px, transparent 1px); background-size: 20px 20px; transform: rotate(-1deg); }
        .real-letter h2 { font-family: 'Pacifico', cursive; margin-top: 0; color: var(--pink-dark); margin-right: 30px; flex-shrink: 0; }
        #modal-letter-content { font-family: 'Dancing Script', cursive; font-size: 1.6rem; line-height: 1.6; color: #333; white-space: pre-wrap; overflow-y: auto; flex: 1; padding-right: 10px; margin-bottom: 20px; }
        .letter-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: #aaa; background: none; border: none; cursor: pointer; z-index: 10; }
        .letter-stamp { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; border: 2px double #d4af37; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #d4af37; font-size: 0.7rem; font-weight: bold; transform: rotate(-15deg); opacity: 0.7; text-align: center; pointer-events: none; }

        /* GALERIE */
        .polaroid-container { display: flex; justify-content: space-around; }
        .polaroid { background: white; padding: 10px 10px 30px 10px; position: relative; box-shadow: 0 5px 15px var(--p-shadow); transform: rotate(-2deg); width: 45%; text-align: center; cursor: pointer; transition: 0.3s; border-radius:0; }
        .polaroid:nth-child(2) { transform: rotate(3deg); }
        .polaroid:active { transform: scale(1.05) rotate(0deg); z-index: 10; }
        .polaroid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; margin-bottom: 5px; }
        .polaroid-label { font-family: 'Dancing Script', cursive; font-size: 1.2rem; color: #555; }
        .add-photo-btn { display: none; margin-top: 5px; font-size: 0.7rem; color: #888; border: 1px dashed #ccc; padding: 5px; border-radius: 5px; }
        .photo-date { font-size: 0.7rem; color: #888; margin-top: 5px; display: block; text-align: center; font-weight: bold; }

        /* MODAL GALERIE */
        #gallery-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; padding: 20px; overflow-y:auto; }
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 7000; justify-content: center; align-items: center; padding: 0; }
        #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-header { display: flex; justify-content: space-between; color: white; margin-bottom: 20px; align-items: center; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .modal-img { width: 100%; border-radius: 5px; cursor: zoom-in; transition: 0.2s; }
        .modal-img:hover { opacity: 0.8; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; background: none; border: none; cursor: pointer; }

        /* --- STYLE PROJETS (Bucket List) --- */

        /* 1. LES ONGLETS (Distance vs R√©el) */
        .todo-tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        
        .todo-tab { 
            flex: 1; 
            padding: 10px; 
            text-align: center; 
            border-radius: 12px; 
            font-size: 0.85rem; 
            font-weight: 800; 
            cursor: pointer; 
            border: 1px solid var(--border); 
            color: var(--text-sub); 
            background: var(--input-bg);
            transition: all 0.3s ease; 
        }
        
        /* Onglet Actif : Distance (Bleu) */
        .todo-tab.tab-dist.active { 
            background: var(--blue); 
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(142, 202, 230, 0.4); 
            transform: translateY(-2px);
        }
        
        /* Onglet Actif : R√©el (Rose) */
        .todo-tab.tab-real.active { 
            background: var(--pink-dark); 
            color: white; 
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(255, 75, 110, 0.4); 
            transform: translateY(-2px);
        }
        
        /* 2. LA BARRE DE PROGRESSION ADAPTATIVE */
        /* Par d√©faut c'est bleu, mais si on est dans 'real' √ßa devient rose */
        .progress-dist .book-progress-bar { background: var(--blue); }
        .progress-real .book-progress-bar { background: var(--pink-dark); }
        
        /* 3. LE S√âLECTEUR D'IC√îNES */
        .cat-selector { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 10px; 
            justify-content: space-between; 
        }
        
        .cat-option {
            width: 40px; height: 40px; 
            border-radius: 12px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; 
            cursor: pointer; 
            border: 2px solid transparent;
            background: white; 
            transition: 0.2s; 
            opacity: 0.6; 
            filter: grayscale(100%);
        }
        
        .cat-option:hover { transform: scale(1.1); }
        
        /* Quand s√©lectionn√© : couleur vive + bordure */
        .cat-option.selected { 
            opacity: 1; 
            filter: grayscale(0%);
            border-color: var(--c); /* Variable couleur d√©finie en HTML */
            background: var(--input-bg);
            transform: translateY(-3px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* 4. LES ITEMS DE LA LISTE (Style Ticket) */
        .todo-item {
            display: flex; 
            align-items: center; 
            background: white; 
            padding: 12px 15px; 
            margin-bottom: 10px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); 
            transition: 0.3s;
            position: relative; 
            overflow: hidden;
        }
        
        /* La petite barre de couleur √† gauche */
        .todo-item::before {
            content: ""; 
            position: absolute; 
            left: 0; top: 0; bottom: 0; 
            width: 6px;
            background: var(--cat-color, #ccc); /* Couleur dynamique */
        }
        
        .todo-check { 
            width: 22px; height: 22px; 
            margin-right: 15px; 
            accent-color: var(--cat-color, var(--pink)); /* La checkbox prend la couleur de la cat */
            cursor: pointer; 
            z-index: 2; 
        }
        
        .todo-content { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
        }
        
        .todo-text { 
            font-size: 0.95rem; 
            color: var(--text-main); 
            font-weight: 600; 
            transition: 0.3s; 
        }
        
        .todo-cat-icon { 
            font-size: 0.8rem; 
            margin-right: 6px; 
            vertical-align: middle;
        }
        
        /* √âtat Termin√© (Barr√©) */
        .todo-text.done { 
            text-decoration: line-through; 
            color: var(--text-sub); 
            opacity: 0.7; 
        }
        
        .todo-item.done { 
            background: var(--input-bg); 
            border-color: transparent; 
            box-shadow: none; 
            opacity: 0.8;
        }
        
        /* Bouton Supprimer */
        .todo-del { 
            background: none; 
            border: none; 
            color: #ffadad; 
            cursor: pointer; 
            font-size: 1.1rem; 
            opacity: 0.4; 
            padding: 5px; 
            transition: 0.2s; 
            margin-left: 10px;
        }
        .todo-del:hover { opacity: 1; transform: scale(1.1); color: #e74c3c; }
        
        /* 5. ADAPTATION DARK MODE */
        body.dark-mode .cat-option { background: #333; }
        body.dark-mode .todo-item { background: #2a2a2a; border-color: #444; }
        body.dark-mode .todo-item.done { background: #1f1f1f; }
        body.dark-mode .todo-tab { background: #2c2c2c; }
        
        .book-item { background: var(--input-bg); padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border); }
        .book-title { font-weight: 800; font-size: 1rem; color: var(--text-main); margin-bottom: 5px; display:flex; justify-content:space-between; }
        .book-total-pages { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 10px; font-weight: 500; }
        .user-row { display: flex; flex-direction: column; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 10px; }
        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .user-inputs { display: flex; align-items: center; gap: 10px; width: 100%; }
        .page-input { width: 50px; padding: 4px; border-radius: 6px; border: 1px solid var(--border); text-align: center; font-weight: bold; font-size: 0.9rem; background: var(--bg-card); color: var(--text-main); }
        .star-rating { display: flex; gap: 1px; }
        .star { cursor: pointer; font-size: 1.1rem; color: #ddd; transition: 0.2s; }
        .star.filled { color: #ffb84d; }
        .star-reset { font-size: 0.7rem; color: var(--text-sub); cursor: pointer; margin-left: 5px; padding: 2px;}
        .book-progress-track { flex: 1; height: 6px; background: var(--border); border-radius: 4px; overflow: hidden; margin-left: 10px; }
        .book-progress-bar { height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 4px; }

       /* 5. Le Widget Cycle Central */
        #cycle-widget {
            width: 65px; 
            height: 65px;
            flex-shrink: 0;
            
            /* CENTRAGE VERTICAL PAR RAPPORT AUX AVATARS */
            /* L'avatar fait 130px de haut. Pour centrer le rond (65px) :
               (130 - 65) / 2 = ~32px de marge en haut */
            margin-top: 32px; 
            
            position: relative;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            background: var(--bg-card);
            transition: transform 0.1s;
            z-index: 5;
        }
        
        #cycle-widget:active { transform: scale(0.9); }
        
        /* L'ANNEAU (G√©r√© par Conic Gradient en JS) */
        #cycle-ring {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: 50%;
            z-index: 1;
            /* Par d√©faut (sera √©cras√© par le JS) */
            background: conic-gradient(var(--border) 0%, var(--border) 100%); 
            transition: background 0.5s ease;
        }
        
        /* LE CENTRE BLANC (Pour faire l'effet anneau) */
        #cycle-content {
            position: absolute;
            top: 4px; left: 4px; right: 4px; bottom: 4px; /* √âpaisseur de l'anneau = 4px */
            background: var(--bg-card); /* Couleur de fond de la carte */
            border-radius: 50%;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--text-main);
        }
        
        #cycle-day {
            font-size: 1rem;
            font-weight: 800;
            line-height: 1;
        }
        
        #cycle-icon {
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        /* COULEURS DES JOURS SP√âCIAUX (Texte) */
        .cycle-red-text { color: #ff4b6e; } /* Rose/Rouge r√®gles */
        .cycle-normal-text { color: var(--text-sub); } /* Gris normal */
        
        /* RESPONSIVE : Si l'√©cran est petit, on ajuste un peu */
        @media (max-width: 360px) {
            #cycle-widget { width: 60px; height: 60px; }
            #cycle-day { font-size: 0.9rem; }
        }

        /* --- ADAPTATION DARK MODE (Widget Cycle) --- */

        /* 1. Profondeur du widget */
        body.dark-mode #cycle-widget {
            background: var(--bg-card); /* Reste gris fonc√© (#1e1e1e) */
            box-shadow: 0 8px 20px rgba(0,0,0,0.6); /* Ombre plus intense pour l'effet flottant */
        }
        
        /* 2. Le centre du widget */
        body.dark-mode #cycle-content {
            background: var(--bg-card); 
        }
        
        /* 3. Texte "Jours R√®gles" (Effet N√©on) */
        body.dark-mode .cycle-red-text {
            color: #ff8fa3; /* Rose plus lumineux pour ressortir sur le noir */
            text-shadow: 0 0 10px rgba(255, 75, 110, 0.5); /* Lueur diffuse */
        }
        
        /* 4. Texte "Jours Normaux" */
        body.dark-mode .cycle-normal-text {
            color: #777; /* Gris sombre discret pour ne pas √©blouir */
        }
        
        /* FOOTER & UTILS */
        .app-footer { text-align: center; padding: 20px; margin-top: 30px; opacity: 1; }
        .footer-content {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background: var(--bg-card);
            padding: 10px 25px;
            border-radius: 30px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid var(--border);
        }
        .footer-logo { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .spotify-link { display: inline-flex; align-items: center; justify-content: center; }
        .spotify-icon { width: 35px; height: 35px; transition: 0.2s; }
        .spotify-icon:active { transform: scale(0.9); }

        /* FAB */
        #bisou-btn { position: fixed; bottom: 30px; right: 25px; width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--pink), var(--pink-dark)); color: white; border: none; font-size: 30px; box-shadow: 0 10px 25px rgba(255, 75, 110, 0.4); cursor: pointer; z-index: 1000; animation: pulse 3s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0.6); } 70% { box-shadow: 0 0 0 15px rgba(255, 75, 110, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0); } }
        #notif { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 10px 20px; border-radius: 30px; z-index: 9999; transition: 0.3s; display:flex; align-items:center; gap:10px; }
        #notif.show { transform: translateX(-50%) translateY(0); }
        .hidden { display: none; }

        /* --- STYLES OVERLAY (V59) --- */
        #bd-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 99999;
            flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        .bd-title { font-family: 'Pacifico', cursive; font-size: 2.5rem; color: #ffeb3b; margin-bottom: 20px; animation: bounce 2s infinite; }
        
        /* GATEAU */
        .cake-container { position: relative; width: 220px; height: 200px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; margin-bottom: 50px; }
        .cake-base { width: 100%; height: 80px; background: linear-gradient(to bottom, #f8a5c2, #f78fb3); border-radius: 10px; position: relative; display: flex; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 1; }
        .cake-layer { width: 110%; height: 20px; background: #fff; border-radius: 10px; position: absolute; top: -10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .candles-row { display: flex; gap: 30px; position: relative; z-index: 2; margin-bottom: -10px; }
        .candle-wrapper { position: relative; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; }
        .candle-wrapper:active { transform: scale(0.95); }
        .candle-num { font-size: 5rem; font-weight: 800; color: #ffeb3b; text-shadow: 0 5px 0 #e1b12c; font-family: 'Outfit'; -webkit-text-stroke: 2px #333; line-height: 1; }
        
        /* FIX BOUGIE V59: Opacity + Scale pour assurer que √ßa "s'√©teint" visuellement sans casser le layout */
        .flame { 
            width: 20px; height: 35px; background: radial-gradient(white, yellow, orange, red); 
            border-radius: 50% 50% 20% 20%; margin-bottom: 5px; 
            animation: flicker 0.5s infinite alternate; box-shadow: 0 0 20px orange; 
            opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s;
        }
        .smoke { width: 8px; height: 8px; background: rgba(200,200,200,0.8); border-radius: 50%; position: absolute; top: 10px; opacity: 0; pointer-events: none; }
        
        .candle-wrapper.blown-out .flame { 
            opacity: 0 !important; 
            visibility: hidden !important; /* Garde la place mais rend invisible */
            transform: scale(0) !important; 
            animation: none !important; /* Coupe l'animation de la flamme */
            transition: none !important; /* Disparition imm√©diate */
        }
        .candle-wrapper.blown-out .smoke { animation: puff 1.5s forwards; }

        /* OEUF DE PAQUES */
        #easter-egg-container { display:none; flex-direction:column; align-items:center; }
        .easter-egg { font-size: 100px; cursor: pointer; transition: 0.2s; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); user-select:none; }
        .crack-1 { transform: rotate(10deg); }
        .crack-2 { transform: rotate(-10deg) scale(1.1); }
        .crack-3 { animation: hatch 0.5s forwards; font-size: 120px; }

        /* ANIMATION COEUR ST VALENTIN */
        .big-heart {
            font-size: 100px;
            cursor: pointer;
            user-select: none;
            filter: drop-shadow(0 0 20px rgba(255, 20, 147, 0.5));
            animation: heartbeat 1.2s infinite;
            transition: transform 0.1s;
        }
        .big-heart:active {
            transform: scale(0.9); /* Effet d'appui */
        }
        
        @keyframes heartbeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.15); }
            30% { transform: scale(1); }
            45% { transform: scale(1.15); }
            60% { transform: scale(1); }
            100% { transform: scale(1); }
        }
        
        @keyframes hatch { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

        @keyframes flicker { 0% { transform: scale(1); opacity: 0.9; } 100% { transform: scale(1.1); opacity: 1; } }
        @keyframes puff { 0% { opacity: 0.8; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-40px) scale(3); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .bd-msg { font-size: 1.1rem; opacity: 0.8; margin-top: 20px; font-style: italic; max-width: 80%; line-height: 1.5; }
        .btn-enter { margin-top: 30px; background: white; color: #333; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; font-size: 1.2rem; cursor: pointer; display: none; animation: slideUp 0.5s; box-shadow: 0 0 20px white; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* EFFETS M√âT√âO SUR LA CARTE VOYAGE */
        /* --- CORRECTIF M√âT√âO & AVION --- */

        /* 1. On restaure la zone centrale (Ligne + Avion) */
        .journey-visual {
            flex: 1; /* Reprend toute la largeur disponible */
            text-align: center;
            position: relative;
            padding: 0 10px;
            overflow: visible; /* L'avion peut d√©passer si besoin */
            
            /* On annule le "rond" qui cachait l'avion */
            width: auto; height: auto; 
            border-radius: 0; margin: 0; 
            background: none;
        }
        
        /* --- CORRECTIF M√âT√âO V2 (Pluie Cin√©matographique) --- */

        /* La colonne Pays (France / Taiwan) */
        .journey-col {
            position: relative;
            border-radius: 12px;
            padding: 8px 5px; /* Un peu plus d'espace */
            transition: background 0.5s ease;
            overflow: hidden; /* La pluie ne d√©passe pas du cadre */
        }
        
        /* On s'assure que le texte reste TOUJOURS au-dessus des effets */
        .journey-col span {
            position: relative;
            z-index: 2; /* Texte au premier plan */
            text-shadow: 0 1px 2px rgba(255,255,255,0.8); /* Petit halo blanc pour lisibilit√© */
        }
        body.dark-mode .journey-col span {
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        
        /* --- EFFET NUIT --- */
        .journey-col.is-night {
            background: linear-gradient(to bottom, rgba(20, 30, 48, 0.05), rgba(20, 30, 48, 0.15));
        }
        body.dark-mode .journey-col.is-night {
            background: linear-gradient(to bottom, rgba(10, 20, 40, 0.5), rgba(10, 20, 40, 0.8));
            border: 1px solid rgba(255,255,255,0.05);
        }
        
        /* --- EFFET PLUIE (Nouvelle version) --- */
        .journey-col.is-rain {
            /* Fond l√©g√®rement gris/bleu pour l'ambiance */
            background: linear-gradient(to bottom, rgba(200, 214, 229, 0.3), rgba(131, 149, 167, 0.3));
        }
        body.dark-mode .journey-col.is-rain {
            background: linear-gradient(to bottom, rgba(50, 60, 70, 0.6), rgba(30, 40, 50, 0.6));
        }
        
        /* L'animation de pluie (Calque au fond) */
        .journey-col.is-rain::before {
            content: "";
            position: absolute;
            top: -100%; left: -50%; 
            width: 200%; height: 200%;
            z-index: 1; /* Derri√®re le texte */
            
            /* On dessine des traits fins avec un d√©grad√© r√©p√©t√© */
            background: repeating-linear-gradient(
                170deg,             /* Angle de chute */
                transparent,
                transparent 20px,   /* Espace entre les gouttes */
                rgba(52, 152, 219, 0.2) 20px, /* Couleur goutte (bleu l√©ger) */
                rgba(52, 152, 219, 0.2) 21px  /* √âpaisseur goutte (1px) */
            );
            
            animation: rainFall 0.8s linear infinite;
            pointer-events: none; /* On peut cliquer √† travers */
        }
        
        @keyframes rainFall {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); } /* D√©filement continu */
        }
        /* Nuit */
        .weather-night { background: #001d3d; border-radius: 50%; }
        .weather-night .plane-icon { color: white; text-shadow: 0 0 5px yellow; }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

    </style>
</head>
<body>

    <div id="bd-overlay">
        <div class="bd-title" id="bd-title-text">Joyeux Anniversaire !</div>
        
        <div class="cake-container" id="cake-mode-container">
            <div class="candles-row" id="candles-area"></div>
            <div class="cake-base"><div class="cake-layer"></div></div>
        </div>

        <div id="easter-egg-container">
            <div class="easter-egg" id="easter-egg" onclick="crackEgg()">ü•ö</div>
        </div>

        <div id="love-container" style="display:none; flex-direction:column; align-items:center;">
            <div class="big-heart" onclick="clickHeart()">‚ù§Ô∏è</div>
        </div>

        <div class="bd-msg" id="overlay-msg">Fais un v≈ìu et souffle (clique) sur les bougies ! üïØÔ∏è</div>
        <button class="btn-enter" onclick="enterSpecialApp()">üéÅ Entrer dans l'app</button>
    </div>

    <div id="notif">üíã Bisou re√ßu !</div>

    <div id="letter-modal" style="display:none;"><div class="real-letter"><button class="letter-close" onclick="closeLetter()">‚úï</button><h2 id="modal-letter-title"></h2><p id="modal-letter-content"></p><div class="letter-stamp">POSTE<br>AMOUR</div></div></div>
    <div id="gallery-modal"><div class="modal-header"><h2 style="color:white;font-family:'Outfit'">Galerie</h2><button onclick="closeGallery()" style="background:none;border:none;color:white;font-size:2rem;">‚úï</button></div><div class="modal-grid" id="modal-grid"></div></div>
    <div id="lightbox" onclick="closeLightbox()"><button class="lightbox-close">‚úï</button><img id="lightbox-img" src=""></div>
    
    <div id="uno-color-modal"><div class="color-picker-box"><h3>Choisis une couleur</h3><div class="cp-options"><div class="cp-circle" style="background:var(--uno-red)" onclick="chooseUnoColor('red')"></div><div class="cp-circle" style="background:var(--uno-blue)" onclick="chooseUnoColor('blue')"></div><div class="cp-circle" style="background:var(--uno-green)" onclick="chooseUnoColor('green')"></div><div class="cp-circle" style="background:var(--uno-yellow)" onclick="chooseUnoColor('yellow')"></div></div></div></div>

    <header>
        <div class="header-top">
            <button class="header-btn" id="user-toggle-btn" onclick="switchUser()">üáπüáº</button>
            <h1 class="app-title">Love Travel</h1>
            <button class="header-btn" onclick="toggleTheme()">üåó</button>
        </div>
        <div id="bd-subtitle" class="bd-subtitle"></div>
    </header>

    <div class="container">

        <div class="card voyage-card" id="card-voyage">
            <div class="card-content">
                <div class="journey-row">
                    <div class="journey-col"><span class="place-name"><span id="dot-fr" class="status-dot"></span> France</span><span class="place-time" id="clock-fr">--:--</span><span class="place-weather" id="weather-fr">--¬∞C</span></div>
                    <div class="journey-visual"><div class="plane-icon">‚úàÔ∏è</div><div class="path-line"></div></div>
                    <div class="journey-col"><span class="place-name"><span id="dot-tw" class="status-dot"></span> Ta√Øwan</span><span class="place-time" id="clock-tw">--:--</span><span class="place-weather" id="weather-tw">--¬∞C</span></div>
                </div>
                <div class="countdown-compact">
                    <div id="countdown-title" class="compact-title">D√âPART DANS</div>
                    <div class="compact-counter"><span id="days-count" class="big-num">--</span> <span class="unit" id="days-unit">JOURS</span><span class="separator">‚Ä¢</span><span id="sub-count" class="small-time">-- h et -- min</span></div>
                    <div class="progress-container-modern">
                        <div class="dates-row"><span>14 F√©v</span><span>05 Juil</span></div>
                        <div class="prog-bar-mini">
                            <div class="prog-fill-mini" id="prog-fill"></div>
                            <div class="prog-heart" id="prog-heart">ü©∑</div>
                        </div>
                    </div>
                </div> </div> </div> <div class="card" id="card-mood">
            <div class="card-title toggleable" onclick="toggleCard(this)">
                <div style="display:flex; align-items:center; gap:10px;"><span>‚òÅÔ∏è</span> Nos Moods</div>
            </div>
            <div class="card-content">
                <div class="mood-container">
                    <div class="mood-person">
                        <div class="avatar-frame"><img src="" id="mood-img-fr" class="avatar-img"></div>
                        <div class="mood-msg" id="mood-msg-fr">...</div>
                    </div>
                
                    <div id="cycle-widget" onclick="editCycle()">
                        <div id="cycle-ring"></div> <div id="cycle-content">
                            <div id="cycle-day">J-1</div>
                            <div id="cycle-icon">üå∏</div>
                        </div>
                    </div>
                
                    <div class="mood-person">
                        <div class="avatar-frame"><img src="" id="mood-img-tw" class="avatar-img"></div>
                        <div class="mood-msg" id="mood-msg-tw">...</div>
                    </div>
                </div>
                <div class="mood-grid">
                    <div class="mood-btn" onclick="updateMood('ü•∞', 'Tu me manques !', 0)">ü•∞</div>
                    <div class="mood-btn" onclick="updateMood('ü§ì', 'Je suis en cours', 1)">ü§ì</div>
                    <div class="mood-btn" onclick="updateMood('üò¥', 'Zzz Zzz', 2)">üò¥</div>
                    <div class="mood-btn" onclick="updateMood('üòã', 'Je mangeee !', 3)">üòã</div>
                    <div class="mood-btn" onclick="updateMood('ü•µ', 'Envie de toi...', 4)">ü•µ</div>
                    <div class="mood-btn" onclick="customMood()" style="color:var(--pink);">‚úèÔ∏è</div>
                </div>
            </div>
        </div>

        <div class="card" id="card-letter">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üíå</span> Bo√Æte aux Lettres</div></div>
            <div class="card-content">
                <div class="mailbox-tabs"><div class="mailbox-tab active" id="tab-inbox" style="background:var(--pink);color:white;" onclick="showTab('inbox')">Re√ßus</div><div class="mailbox-tab" id="tab-sent" style="background:transparent;color:var(--text-main);" onclick="showTab('sent')">Envoy√©s</div></div>
                <div class="input-group"><input type="text" id="letter-title" class="input-field" placeholder="Ouvrir quand..."><input type="date" id="letter-unlock-date" class="input-field" style="width:130px; font-size:0.75rem;" title="Date d'ouverture"><button onclick="addLetter()" class="btn-action" style="background:var(--pink-dark)">+</button></div>
                <textarea id="letter-content" class="input-field" placeholder="Ecris ta lettre ici..." style="width:100%;height:80px;resize:none;margin-bottom:15px;"></textarea>
                <div id="list-inbox" class="letter-list"></div><div id="list-sent" class="letter-list hidden"></div>
            </div>
        </div>

        <div class="card" id="card-album">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üì∏</span> Nos Albums</div></div>
            <div class="card-content">
                <div class="polaroid-container">
                    <div class="polaroid" onclick="openGallery('fr')"><img id="polaroid-img-fr" class="polaroid-img"><div class="polaroid-label">Th√©o</div><div id="btn-add-fr" class="add-photo-btn" onclick="event.stopPropagation();document.getElementById('file-fr').click()">+ Ajouter photo</div><input type="file" id="file-fr" accept="image/*" onchange="handlePhotoUpload(this,'fr')" style="display:none;"></div>
                    <div class="polaroid" onclick="openGallery('tw')"><img id="polaroid-img-tw" class="polaroid-img"><div class="polaroid-label">Elise</div><div id="btn-add-tw" class="add-photo-btn" onclick="event.stopPropagation();document.getElementById('file-tw').click()">+ Ajouter photo</div><input type="file" id="file-tw" accept="image/*" onchange="handlePhotoUpload(this,'tw')" style="display:none;"></div>
                </div>
            </div>
        </div>

        <div class="card" id="card-todo">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üìù</span> Nos Projets</div></div>
            <div class="card-content">
    
                <div class="todo-tabs">
                    <div class="todo-tab tab-dist active" id="t-tab-dist" onclick="switchTodoTab('dist')">üì° √Ä Distance</div>
                    <div class="todo-tab tab-real" id="t-tab-real" onclick="switchTodoTab('real')">‚úàÔ∏è Retrouvailles</div>
                </div>
            
                <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:bold; color:var(--text-sub); margin-bottom:5px;">
                    <span id="prog-label">R√©alisations √† distance</span>
                    <span id="todo-percent">0%</span>
                </div>
                <div class="book-progress-track" id="prog-track" style="margin-bottom:20px;">
                    <div id="todo-progress-bar" class="book-progress-bar" style="width:0%;"></div>
                </div>
            
                <div style="background:var(--input-bg); padding:15px; border-radius:15px; border:1px solid var(--border); margin-bottom:15px;">
                    <div style="font-size:0.8rem; font-weight:bold; color:var(--text-sub); margin-bottom:10px;">Nouvelle id√©e :</div>
                    
                    <div class="cat-selector" id="todo-cat-selector">
                        </div>
            
                    <div class="input-group" style="margin-bottom:0;">
                        <input type="text" id="todo-input" class="input-field" placeholder="Qu'on fait ensemble..." style="background:white;">
                        <button onclick="addTodo()" class="btn-action" style="width:50px;">+</button>
                    </div>
                </div>
            
                <div id="todo-list"></div>
            </div>
        </div>

        <div class="card" id="card-books">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üìö</span> Lectures Communes</div></div>
            <div class="card-content"><div class="input-group"><input type="text" id="book-title" class="input-field" placeholder="Titre..."><input type="number" id="book-pages" class="input-field" style="width:80px;" placeholder="Total P."><button onclick="addBook()" class="btn-action">+</button></div><div id="book-list"></div></div>
        </div>

        <div class="card" id="card-games">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üéÆ</span> Salle de Jeux</div></div>
            <div class="card-content">
                
                <div class="game-selector">
                    <button id="btn-pendu" onclick="toggleGame('pendu')" class="game-btn">
                        Pendu <span class="game-indicator"></span>
                    </button>
                    <button id="btn-p4" onclick="toggleGame('p4')" class="game-btn">
                        P4 <span class="game-indicator"></span>
                    </button>
                    <button id="btn-uno" onclick="toggleGame('uno')" class="game-btn">
                        Uno <span class="game-indicator"></span>
                    </button>
                    <button id="btn-bac" onclick="toggleGame('bac')" class="game-btn">
                        Bac <span class="game-indicator"></span>
                    </button>
                </div>
                
                <div id="pendu-box" class="game-block"><div class="game-header"><div class="game-title-text">Pendu</div><button class="game-close-btn" onclick="toggleGame('pendu')">‚úï</button></div><canvas id="pendu-canvas" width="200" height="150"></canvas><div id="pendu-word-display" class="pendu-word">_ _ _ _ _</div><div id="pendu-status" class="status-msg">En attente...</div><div id="pendu-setup" style="margin-top:10px;"><input type="text" id="pendu-secret" class="input-field" placeholder="Mot secret (sans accent)"><button onclick="startPendu()" class="btn-action" style="width:100%;margin-top:5px;">Lancer</button></div><div id="pendu-restart-area" style="display:none;margin-top:10px;"><button onclick="startPenduSetup()" class="btn-action" style="background:var(--blue-dark);width:100%;">Rejouer</button></div><div id="pendu-keyboard" class="keyboard" style="display:none;"></div><div class="history-box" id="pendu-history-list"></div></div>
                
                <div id="p4-box" class="game-block"><div class="game-header"><div class="game-title-text">Puissance 4</div><button class="game-close-btn" onclick="toggleGame('p4')">‚úï</button></div><div id="p4-status" class="status-msg">En attente...</div><button id="p4-restart-btn" onclick="initP4()" class="btn-action" style="width:100%;margin-bottom:10px;background:var(--blue-dark);" disabled>Nouvelle Partie</button><div class="p4-grid" id="p4-grid"></div><div class="history-box" id="p4-history-list"></div></div>

                <div id="uno-box" class="game-block">
                    <div class="game-header"><div class="game-title-text">UNO</div><button class="game-close-btn" onclick="toggleGame('uno')">‚úï</button></div>
                    <div id="uno-status" class="status-msg">Bienvenue au Uno !</div>
                    <div class="uno-board">
                        <div class="uno-top-info"><span id="uno-opponent-name">Adversaire</span> : <span id="uno-opponent-count">0</span> cartes</div>
                        <div class="uno-table">
                            <div class="uno-card back" onclick="drawUnoCard()" title="Piocher">UNO</div>
                            <div id="uno-discard-pile"></div>
                        </div>
                        <div class="uno-hand" id="uno-player-hand"></div>
                    </div>
                    <button id="uno-restart-btn" onclick="initUno()" class="btn-action" style="width:100%;margin-top:10px;background:var(--blue-dark);" disabled>Nouvelle Partie</button>
                    <div class="history-box" id="uno-history-list"></div>
                </div>

               <div id="bac-box" class="game-block">
                    <div class="game-header">
                        <div class="game-title-text">Petit Bac</div>
                        <button class="game-close-btn" onclick="toggleGame('bac')">‚úï</button>
                    </div>
                
                    <div id="bac-lobby" style="text-align:center; padding: 20px 0;"></div>
                
                    <div id="bac-game" style="display:none;">
                        <div class="bac-letter-sticky" id="bac-current-letter">?</div>
                        <div id="bac-inputs"></div>
                        <div style="display:flex; gap:10px; margin-top:15px; padding-bottom:15px;">
                            <button onclick="bacTryFinish()" class="btn-action" style="flex:1; background:var(--blue-dark);">Termin√© !</button>
                            <button onclick="bacVoteSkip()" id="bac-btn-skip" class="btn-action" style="flex:1; background:#e67e22;">On passe ?</button>
                        </div>
                    </div>
                
                    <div id="bac-review" style="display:none;">
                        <div id="bac-review-list"></div>
                        <div id="bac-review-actions" style="margin-top:20px;"></div>
                    </div>
                
                    <div id="bac-finished" style="display:none; text-align:center; padding:10px 0;">
                        <div style="font-size:3rem; margin-bottom:5px;" id="bac-winner-icon">üèÜ</div>
                        <div style="font-size:1.4rem; font-weight:800; color:var(--text-main);" id="bac-winner-text">Gagnant</div>
                        <div style="font-size:1rem; color:var(--text-sub); margin-bottom:15px;" id="bac-score-text">Score</div>
                        <div id="bac-results-table-container" style="margin-bottom:20px;"></div>
                        <button onclick="bacReset()" class="btn-action" style="width:100%; background: linear-gradient(to right, var(--blue-dark), var(--pink-dark)); box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                            Fin de partie
                        </button>
                    </div>
                
                    <div class="history-box" id="bac-history-list" style="margin-top:20px; padding-top:10px; border-top:1px solid #eee;"></div>
                </div>
            </div>
        </div>
        
        <div class="app-footer">
            <div class="footer-content">
                <img src="icon.jpg" class="footer-logo">
                <a href="https://open.spotify.com/playlist/20Gmofuoy7FuEydcKOhpOH?si=SRo1hgXVRZCn-jymg_k18A&pi=-AZabbkXR3Ocj" target="_blank" class="spotify-link">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg" class="spotify-icon">
                </a>
            </div>
            <div style="font-size:0.7rem;color:var(--text-sub);margin-top:10px;">Love Travel v79 ‚Ä¢ janvier 2026</div>
        </div>
    </div>

    <button id="bisou-btn" onclick="sendBisou()">üíã</button>

    <div id="upload-choice-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:var(--bg-card); padding:25px; border-radius:20px; width:85%; max-width:320px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.3); border:1px solid var(--border);">
            <div style="font-size:3rem; margin-bottom:10px;">ü´£</div>
            <h3 style="font-family:'Pacifico'; margin:0 0 10px 0; color:var(--text-main);">Cacher cette photo ?</h3>
            <p style="font-size:0.9rem; color:var(--text-sub); margin-bottom:25px; line-height:1.4;">Veux-tu activer le <b>Mode Grattage</b> pour en faire une surprise ? üéÅ</p>
            
            <div style="display:flex; gap:10px; flex-direction:column;">
                <button onclick="confirmUpload(true)" class="btn-action" style="background:var(--pink-dark); width:100%; box-shadow:0 4px 10px rgba(255, 75, 110, 0.3);">
                    Oui, c'est une surprise ! üéÅ
                </button>
                <button onclick="confirmUpload(false)" class="btn-action" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border); width:100%;">
                    Non, photo normale üì∑
                </button>
            </div>
            <button onclick="cancelUpload()" style="margin-top:15px; background:none; border:none; color:var(--text-sub); text-decoration:underline; cursor:pointer;">Annuler</button>
        </div>
    </div>

    <div id="scratch-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
        <div style="color:white; font-family:'Pacifico'; font-size:1.5rem; margin-bottom:15px; animation:bounce 2s infinite;">Gratte pour d√©couvrir ! ‚ú®</div>
        <div style="position:relative; width:300px; height:300px; border-radius:15px; overflow:hidden; box-shadow:0 0 30px rgba(255,255,255,0.2);">
            <img id="scratch-img-target" src="" style="width:100%; height:100%; object-fit:cover;">
            <canvas id="scratch-canvas" width="300" height="300" style="position:absolute; top:0; left:0; touch-action:none; cursor:crosshair;"></canvas>
        </div>
        <button onclick="document.getElementById('scratch-modal').style.display='none'" style="margin-top:30px; padding:12px 30px; border-radius:30px; border:none; background:white; font-weight:bold; color:#333; cursor:pointer;">Annuler</button>
        <div id="custom-alert" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; justify-content:center; align-items:center; backdrop-filter:blur(3px);">
            <div style="background:var(--bg-card); padding:25px; border-radius:25px; width:85%; max-width:300px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.3); border:1px solid var(--border); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                <div id="alert-icon" style="font-size:3rem; margin-bottom:10px;">‚ú®</div>
                <h3 id="alert-title" style="font-family:'Pacifico'; margin:0 0 10px 0; color:var(--text-main); font-size:1.4rem;">Titre</h3>
                <p id="alert-msg" style="font-size:0.95rem; color:var(--text-sub); margin-bottom:20px; line-height:1.4;">Message ici...</p>
                <button onclick="document.getElementById('custom-alert').style.display='none'" class="btn-action" style="width:100%; border-radius:20px; background:var(--blue-dark); box-shadow:0 4px 10px rgba(0,0,0,0.1);">C'est not√© !</button>
            </div>
        </div>
        
        <div id="cycle-edit-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
            <div style="background:var(--bg-card); padding:25px; border-radius:25px; width:85%; max-width:320px; text-align:center; position:relative; border:1px solid var(--border);">
                <button onclick="document.getElementById('cycle-edit-modal').style.display='none'" style="position:absolute; top:15px; right:15px; background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-sub);">‚úï</button>
                
                <div style="font-size:3rem; margin-bottom:5px;">üå∏</div>
                <h3 style="font-family:'Pacifico'; margin:0 0 15px 0; color:var(--pink-dark);">Mon Cycle</h3>
                <p style="font-size:0.9rem; color:var(--text-sub); margin-bottom:20px;">Si le calcul est d√©cal√©, entre le jour actuel (1 √† 28) pour corriger.</p>
                
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                    <button onclick="adjustCycleInput(-1)" style="width:40px; height:40px; border-radius:50%; border:1px solid var(--border); background:var(--input-bg); font-weight:bold; font-size:1.2rem;">-</button>
                    <input type="number" id="cycle-input-val" value="1" min="1" max="28" style="width:60px; text-align:center; font-size:1.5rem; border:none; background:transparent; font-weight:800; color:var(--text-main); font-family:'Outfit';">
                    <button onclick="adjustCycleInput(1)" style="width:40px; height:40px; border-radius:50%; border:1px solid var(--border); background:var(--input-bg); font-weight:bold; font-size:1.2rem;">+</button>
                </div>
        
                <button onclick="saveCycleChange()" class="btn-action" style="width:100%; background:linear-gradient(135deg, var(--pink), var(--pink-dark)); border-radius:20px;">Valider la correction</button>
                
                <div style="margin-top:15px; font-size:0.8rem; color:var(--text-sub); cursor:pointer; text-decoration:underline;" onclick="resetCycleFull()">C'est le 1er jour de mes r√®gles (J-1)</div>
            </div>
        </div>
    </div>
    

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, orderBy, limit, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA7ZNlC1ILS9-W3bgxWogUA6ak4c29a4Ns", authDomain: "lovetravel-35285.firebaseapp.com", projectId: "lovetravel-35285", storageBucket: "lovetravel-35285.firebasestorage.app", messagingSenderId: "189902268760", appId: "1:189902268760:web:b461ce15d8c396be479d2d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GESTION EVENEMENTS (V59) ---
        const events = [
            { d: 7, m: 3, type: 'bday', name: "Th√©o", age: 21 },
            { d: 24, m: 4, type: 'bday', name: "Elise", age: 24 },
            { d: 6, m: 4, type: 'easter' },
            { d: 14, m: 2, type: 'love' }, 
            
            { d: 1, m: 5, type: 'holiday', title: "F√™te du travail üåø" },
            { d: 8, m: 5, type: 'holiday', title: "Victoire 1945 üá´üá∑" },
            { d: 14, m: 5, type: 'holiday', title: "Jeudi de l‚ÄôAscension ‚ú®" },
            { d: 25, m: 5, type: 'holiday', title: "Lundi de Pentec√¥te üïäÔ∏è" }
        ];

        let activeEvent = null;
        let candlesBlown = 0;
        let eggClicks = 0;

        function checkEvents() {
            const today = new Date();
            const d = today.getDate();
            const m = today.getMonth() + 1; 
            
            activeEvent = events.find(e => e.d === d && e.m === m);
            
            if (activeEvent) {
                if(activeEvent.type === 'holiday') {
                    const sub = document.getElementById('bd-subtitle');
                    sub.style.display = "block";
                    sub.innerText = activeEvent.title;
                } else {
                    initOverlayMode();
                }
            }
        }

        function initOverlayMode() {
            const overlay = document.getElementById('bd-overlay');
            overlay.style.display = "flex";
            const title = document.getElementById('bd-title-text');
            const msg = document.getElementById('overlay-msg');
            const cakeBox = document.getElementById('cake-mode-container');
            const eggBox = document.getElementById('easter-egg-container');

            if (activeEvent.type === 'bday') {
                title.innerText = "Joyeux Anniversaire " + activeEvent.name + " !";
                msg.innerText = "Fais un v≈ìu et souffle (clique) sur les bougies ! üïØÔ∏è";
                cakeBox.style.display = 'flex';
                document.getElementById('love-container').style.display = 'none';
                eggBox.style.display = 'none';
                
                const ageStr = activeEvent.age.toString(); 
                const area = document.getElementById('candles-area');
                area.innerHTML = "";
                for(let i=0; i<ageStr.length; i++) {
                    const digit = ageStr[i];
                    const wrapper = document.createElement('div');
                    wrapper.className = 'candle-wrapper';
                    wrapper.id = 'candle-' + i;
                    wrapper.onclick = () => blowCandle(i);
                    wrapper.innerHTML = `<div class="smoke"></div><div class="flame"></div><div class="candle-num">${digit}</div>`;
                    area.appendChild(wrapper);
                }
                
            } else if (activeEvent.type === 'love') {
                // CONFIGURATION ST VALENTIN
                title.innerText = "Joyeuse Saint-Valentin !";
                msg.innerText = "Touche mon c≈ìur pour sentir mon amour... ‚ù§Ô∏è";
                
                // On cache les autres √©l√©ments
                cakeBox.style.display = 'none';
                eggBox.style.display = 'none';
                
                // On affiche le coeur
                document.getElementById('love-container').style.display = 'flex';

            } else if (activeEvent.type === 'easter') {
                title.innerText = "Joyeuses P√¢ques !";
                msg.innerText = "Tapote l'≈ìuf pour d√©couvrir la surprise...";
                cakeBox.style.display = 'none';
                document.getElementById('love-container').style.display = 'none';
                eggBox.style.display = 'flex';
                eggClicks = 0;
            }
        }

        window.blowCandle = function(index) {
            const c = document.getElementById('candle-' + index);
            if(c.classList.contains('blown-out')) return;

            c.classList.add('blown-out');
            candlesBlown++;

            if(candlesBlown >= activeEvent.age.toString().length) {
                setTimeout(celebrate, 500);
            }
        }

        window.crackEgg = function() {
            const egg = document.getElementById('easter-egg');
            eggClicks++;
            
            if(eggClicks === 1) egg.className = "easter-egg crack-1";
            else if(eggClicks === 2) egg.className = "easter-egg crack-2";
            else if(eggClicks === 3) {
                egg.className = "easter-egg crack-3";
                setTimeout(() => {
                    egg.innerText = "üê∞";
                    document.getElementById('overlay-msg').innerText = "Joyeuses P√¢ques mes amours !";
                    celebrate();
                }, 300);
            }
        }

        window.clickHeart = function() {
            // Audio (optionnel, le m√™me que pour l'anniv)
            const audio = new Audio("https://actions.google.com/sounds/v1/crowds/crowd_cheering.ogg");
            audio.volume = 0.3;
            audio.play().catch(e=>{});
        
            // Confettis en forme de COEUR (si possible) ou juste rouge/rose
            var duration = 2000;
            var end = Date.now() + duration;
        
            (function frame() {
                // Lance des confettis rouges et roses
                confetti({
                    particleCount: 10,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ff0000', '#ff69b4', '#ffffff'],
                    zIndex: 200000
                });
                confetti({
                    particleCount: 10,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#ff0000', '#ff69b4', '#ffffff'],
                    zIndex: 200000
                });
        
                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        
            // Change le message et affiche le bouton
            document.getElementById('overlay-msg').innerText = "Je t'aime !";
            document.querySelector('.btn-enter').style.display = "block";
        }

        function celebrate() {
            const audio = new Audio("https://actions.google.com/sounds/v1/crowds/crowd_cheering.ogg");
            audio.volume = 0.5;
            audio.play().catch(e=>console.log("Audio autoplay bloqu√©"));

            var duration = 3000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5, angle: 60, spread: 55, origin: { x: 0 },
                    colors: ['#ff9eb5', '#8ecae6', '#ffeb3b'], zIndex: 200000
                });
                confetti({
                    particleCount: 5, angle: 120, spread: 55, origin: { x: 1 },
                    colors: ['#ff9eb5', '#8ecae6', '#ffeb3b'], zIndex: 200000
                });

                if (Date.now() < end) requestAnimationFrame(frame);
            }());

            document.querySelector('.btn-enter').style.display = "block";
        }

        window.enterSpecialApp = function() {
            document.getElementById('bd-overlay').style.display = "none";
            document.body.classList.add('birthday-theme');
            const sub = document.getElementById('bd-subtitle');
            sub.style.display = "block";
            
            if (activeEvent.type === 'bday') {
                sub.innerText = `Les ${activeEvent.age} ans de ${activeEvent.name} ‚ù§Ô∏è`;
            } else if (activeEvent.type === 'love') {
                document.body.classList.add('love-theme');
                sub.innerText = "Bonne St. Valentin üåπ";
            } else if (activeEvent.type === 'easter') {
                sub.innerText = "Joyeuses P√¢ques üê∞";
            }
        }

        checkEvents();

        // --- BASICS ---
        let currentUser = localStorage.getItem('userRole') || 'tw';
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        window.toggleTheme = function() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        window.switchUser = function() { currentUser = (currentUser === 'tw') ? 'fr' : 'tw'; localStorage.setItem('userRole', currentUser); alert(currentUser==='fr'?"Th√©o üá´üá∑":"Elise üáπüáº"); updateIdentityUI(); updateMailboxView(); }
        
        function updateIdentityUI() { 
            document.getElementById('user-toggle-btn').innerText = currentUser === 'tw' ? 'üáπüáº' : 'üá´üá∑';
            document.getElementById('btn-add-fr').style.display = currentUser === 'fr' ? 'block' : 'none';
            document.getElementById('btn-add-tw').style.display = currentUser === 'tw' ? 'block' : 'none';
        }
        updateIdentityUI();

        function getMoodImage(role, outfitId) {
            const today = new Date();
            const d = today.getDate();
            const m = today.getMonth() + 1;
            let suffix = "";
            if (d === 14 && m === 2) suffix = "_love";
            else if (d === 6 && m === 4) suffix = "_easter";
            else if (d === 7 && m === 3 && role === 'fr') suffix = "_hb";
            else if (d === 24 && m === 4 && role === 'tw') suffix = "_hb";
            return `MOOD/${role === 'fr' ? 'theo' : 'elise'}_${outfitId}${suffix}.png`;
        }

        // Remplace ton onSnapshot "moods" actuel par celui-ci :
        let opponentIsSleeping = false; // Variable globale
        
        onSnapshot(doc(db, "status", "moods"), (doc) => {
            if (doc.exists()) {
                const d = doc.data();
                document.getElementById("mood-img-fr").src = getMoodImage('fr', d.fr_outfit || 0);
                document.getElementById("mood-img-tw").src = getMoodImage('tw', d.tw_outfit || 0);
                document.getElementById("mood-msg-fr").innerText = d.fr_text || "";
                document.getElementById("mood-msg-tw").innerText = d.tw_text || "";
        
                // GESTION MODE DODO
                const myOutfit = currentUser === 'fr' ? d.fr_outfit : d.tw_outfit;
                const oppOutfit = currentUser === 'fr' ? d.tw_outfit : d.fr_outfit;
                
                // 1. Si JE dors (Mood 2), mon √©cran s'assombrit
                if (myOutfit === 2) document.body.classList.add('is-sleeping');
                else document.body.classList.remove('is-sleeping');
        
                // 2. On note si l'autre dort (pour le bouton bisou)
                opponentIsSleeping = (oppOutfit === 2);
            }
        });
        
        // Remplace ta fonction sendBisou par celle-ci :
        window.sendBisou = function() {
            if (opponentIsSleeping) {
                alert("Chut... ü§´ L'autre dort !");
                return; // On annule le bisou
            }
            addDoc(collection(db, "actions"), { type: 'bisou', from: currentUser, timestamp: serverTimestamp() });
            sendNtfy(`üíã Bisou envoy√© ! (${getCurrentTime(currentUser)})`, "kiss,heart", "high");
            const n = document.getElementById("notif"); n.classList.add("show"); setTimeout(()=>n.classList.remove("show"),3000);
            if(navigator.vibrate) navigator.vibrate(200); 
        }

        window.toggleCard = function(header) {
            if(header.parentElement.id === 'card-voyage') return;
            const content = header.nextElementSibling;
            const isClosed = content.style.display === "none";
            content.style.display = isClosed ? "block" : "none";
            header.classList.toggle("closed", !isClosed);
            localStorage.setItem('card_' + header.parentElement.id, isClosed ? 'open' : 'closed');
        }
        document.querySelectorAll('.card[id]').forEach(c => { if(c.id!=='card-voyage' && localStorage.getItem('card_'+c.id)==='closed') { c.querySelector('.card-content').style.display='none'; c.querySelector('.card-title').classList.add('closed'); }});

        window.deleteTodo = function(id) { deleteDoc(doc(db,"todos",id)); }
        window.deleteBook = function(id) { if(confirm("Supprimer ?")) deleteDoc(doc(db,"books",id)); }
        window.deletePhoto = async function(id) { if(confirm("Supprimer ?")) { document.getElementById(`photo-${id}`)?.remove(); await deleteDoc(doc(db,"photos",id)); } }
        window.deleteLetter = function(id, e) { e.stopPropagation(); if(confirm("Supprimer ?")) deleteDoc(doc(db,"letters",id)); }

        window.toggleGame = function(game) {
            const ids = ['pendu', 'p4', 'uno', 'bac'];
            
            ids.forEach(id => {
                const box = document.getElementById(id + '-box');
                const btn = document.getElementById('btn-' + id);
                
                if (id === game) {
                    // Bascule : si ouvert on ferme, si ferm√© on ouvre
                    const isOpen = box.style.display === 'block';
                    box.style.display = isOpen ? 'none' : 'block';
                    
                    // Gestion visuelle du bouton "Actif" (onglet ouvert)
                    if (!isOpen) btn.classList.add('active-game');
                    else btn.classList.remove('active-game');
                    
                } else {
                    // Ferme les autres
                    box.style.display = 'none';
                    btn.classList.remove('active-game');
                }
            });
        }

        // --- GAMES LOGIC ---
        let activePendu = null;
        onSnapshot(doc(db, "games", "pendu_active"), (s) => { activePendu = s.exists() ? s.data() : { state:'setup' }; renderPendu(activePendu); });
        // --- HISTORIQUE PENDU (Color√©) ---
        onSnapshot(query(collection(db, "games_pendu_history"), orderBy("timestamp", "desc"), limit(50)), (s) => {
            const list = document.getElementById('pendu-history-list'); 
            list.innerHTML = "";
            s.forEach(d => { 
                const h = d.data(); 
                const dateStr = h.timestamp ? new Date(h.timestamp.toDate()).toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'}) : ""; 
                const resClass = h.result === 'win' ? 'hist-win' : 'hist-loose'; 
                
                // Logique couleur
                const setterName = h.setter === 'fr' ? 'Th√©o' : 'Elise';
                const setterColor = h.setter === 'fr' ? 'var(--blue)' : 'var(--pink)';
                
                list.innerHTML += `
                <div class="hist-row">
                    <span>${dateStr} - <b style="color:${setterColor}">${setterName}</b> : <b>${h.word}</b></span>
                    <span class="${resClass}">${h.result==='win'?'Trouv√©':'Rat√©'}</span>
                </div>`; 
            });
        });
        function renderPendu(game) {
            document.getElementById('btn-pendu').classList.toggle('is-running', game.state === 'playing');
            const ctx = document.getElementById('pendu-canvas').getContext('2d');
            const status = document.getElementById('pendu-status');
            const mainColor = getComputedStyle(document.body).getPropertyValue('--blue-dark');
            const pinkColor = getComputedStyle(document.body).getPropertyValue('--pink-dark');
        
            // 1. DESSIN DU PENDU
            ctx.clearRect(0, 0, 200, 150);
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.strokeStyle = mainColor;
            if (game.mistakes > 0) { ctx.moveTo(20, 140); ctx.lineTo(180, 140); }
            if (game.mistakes > 1) { ctx.moveTo(50, 140); ctx.lineTo(50, 20); }
            if (game.mistakes > 2) { ctx.lineTo(130, 20); }
            if (game.mistakes > 3) { ctx.moveTo(130, 20); ctx.lineTo(130, 40); }
            ctx.stroke();
        
            ctx.beginPath();
            ctx.strokeStyle = pinkColor;
            if (game.mistakes > 4) { ctx.beginPath(); ctx.arc(130, 55, 15, 0, Math.PI * 2); ctx.stroke(); }
            if (game.mistakes > 5) { ctx.beginPath(); ctx.moveTo(130, 70); ctx.lineTo(130, 110); ctx.stroke(); }
        
            ctx.beginPath();
            if (game.mistakes > 6) { ctx.moveTo(130, 80); ctx.lineTo(110, 95); }
            if (game.mistakes > 7) { ctx.moveTo(130, 80); ctx.lineTo(150, 95); }
            if (game.mistakes > 8) { ctx.moveTo(130, 110); ctx.lineTo(115, 135); }
            if (game.mistakes > 9) { ctx.moveTo(130, 110); ctx.lineTo(145, 135); }
            ctx.stroke();
        
            if (game.mistakes > 10) { ctx.font = "14px Arial"; ctx.fillStyle = pinkColor; ctx.textAlign = "center"; ctx.fillText("x x", 130, 60); }
        
            // 2. GESTION DES ETATS (IDLE / SETUP / PLAYING / FIN)
            const restartArea = document.getElementById('pendu-restart-area');
            const setupArea = document.getElementById('pendu-setup');
            const keyboard = document.getElementById('pendu-keyboard');
            const canvas = document.getElementById('pendu-canvas');
            const wordDisplay = document.getElementById('pendu-word-display');
        
            // CAS 1 : IDLE (Jeu non commenc√© ou fini nettoy√©)
            if (!game.state || game.state === 'idle') {
                status.innerText = "Pr√™t pour une partie ?";
                canvas.style.display = 'none';
                wordDisplay.style.display = 'none';
                setupArea.style.display = 'none';
                keyboard.style.display = 'none';
                
                restartArea.style.display = 'block';
                restartArea.innerHTML = `<button onclick="startPenduSetup()" class="btn-action" style="background:var(--blue-dark);width:100%;">Lancer</button>`;
                return;
            }
        
            // On r√©affiche les √©l√©ments de base si on n'est pas en idle
            canvas.style.display = 'block';
            wordDisplay.style.display = 'block';
        
            // CAS 2 : SETUP (Choix du mot)
            if (game.state === 'setup') {
                status.innerText = "En attente d'un mot...";
                setupArea.style.display = 'block'; // On affiche l'input
                keyboard.style.display = 'none';
                restartArea.style.display = 'none';
                wordDisplay.innerText = "???";
            } 
            // CAS 3 : JEU EN COURS OU TERMINE
            else {
                setupArea.style.display = 'none'; // On cache l'input
                
                // Affichage du mot avec les tirets
                let d = "";
                for (let c of game.word) d += (game.guessed.includes(c) ? c : "_") + " ";
                wordDisplay.innerText = d;
        
                const isCreator = game.creator === currentUser;
        
                if (game.state === 'playing') {
                    status.innerText = isCreator ? "L'autre devine..." : "Devine !";
                    keyboard.style.display = 'flex';
                    restartArea.style.display = 'none';
                    
                    // G√©n√©ration du clavier
                    let k = "";
                    "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(l => {
                        const disabled = isCreator || game.guessed.includes(l) ? "disabled" : "";
                        k += `<button class="key-btn" onclick="playPenduMove('${l}')" ${disabled}>${l}</button>`;
                    });
                    keyboard.innerHTML = k;
                } else {
                    // GAGN√â OU PERDU
                    status.innerText = game.state === 'win' ? "GAGN√â ! üéâ" : ("PERDU... Le mot √©tait : " + game.word);
                    keyboard.style.display = 'none';
                    restartArea.style.display = 'block';
                    restartArea.innerHTML = `<button onclick="finishPendu()" class="btn-action" style="background:var(--pink-dark);width:100%;">Fin de partie</button>`;
                }
            }
        }
            
        window.startPendu=function(){const w=document.getElementById('pendu-secret').value.toUpperCase().trim(); if(w) setDoc(doc(db,"games","pendu_active"),{state:'playing',word:w,guessed:[],mistakes:0, creator:currentUser});}
        window.startPenduSetup=function(){ setDoc(doc(db,"games","pendu_active"),{state:'setup',word:"",guessed:[],mistakes:0, creator:""}); }
        window.playPenduMove=async function(l){ if(!activePendu||activePendu.state!=='playing')return; const ng=[...activePendu.guessed,l]; let nm=activePendu.mistakes; if(!activePendu.word.includes(l))nm++; let ns='playing'; let save=false; if(nm>=11) { ns='loose'; save=true; } else if(activePendu.word.split('').every(c=>ng.includes(c))) { ns='win'; save=true; } await updateDoc(doc(db,"games","pendu_active"),{guessed:ng,mistakes:nm,state:ns}); if(save) addDoc(collection(db, "games_pendu_history"), { word: activePendu.word, setter: activePendu.creator, result: ns, timestamp: serverTimestamp() }); }
        window.finishPendu = function() {
            updateDoc(doc(db,"games","pendu_active"), { state: 'idle', word: "", guessed: [] });
        }
        
        let activeP4 = null;
        onSnapshot(doc(db, "games", "p4_active"), (s) => { activeP4 = s.exists() ? s.data() : null; if(activeP4) renderP4(activeP4); else document.getElementById('p4-status').innerText = "Aucune partie en cours"; });
        // --- HISTORIQUE P4 (Color√©) ---
        onSnapshot(query(collection(db, "games_p4_history"), orderBy("timestamp", "desc"), limit(50)), (s) => { 
            const list = document.getElementById('p4-history-list'); 
            list.innerHTML = ""; 
            s.forEach(d => { 
                const h = d.data(); 
                const dateStr = h.timestamp ? new Date(h.timestamp.toDate()).toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'}) : ""; 
                
                // Logique couleur
                const winName = h.winner === 'fr' ? 'Th√©o' : 'Elise';
                const winColor = h.winner === 'fr' ? 'var(--blue)' : 'var(--pink)';
        
                list.innerHTML += `
                <div class="hist-row">
                    <span>${dateStr} - <b style="color:${winColor}">${winName}</b></span>
                    <span>en ${h.moves} coups</span>
                </div>`; 
            }); 
        });
        window.initP4 = function() { 
            setDoc(doc(db, "games", "p4_active"), { 
                board: Array(42).fill(0), 
                turn: currentUser, 
                winner: null, 
                moves: 0, 
                status: 'playing' 
            }); 
        }
        function renderP4(game) { 
            document.getElementById('btn-p4').classList.toggle('is-running', game.status === 'playing');
            const grid = document.getElementById('p4-grid'); 
            const statusEl = document.getElementById('p4-status'); 
            const btn = document.getElementById('p4-restart-btn'); 
            
            grid.innerHTML = ""; 
        
            // CAS 1 : Partie pas commenc√©e ou "Fin de partie" cliqu√©e
            if (!game.status || game.status === 'idle') {
                statusEl.innerText = "Pr√™t pour une partie ?";
                grid.style.display = 'none'; // Cache la grille
                btn.innerText = "Lancer";
                btn.onclick = initP4;
                btn.disabled = false; 
                btn.style.opacity = "1";
                return; 
            }
        
            // CAS 2 : Partie en cours ou Termin√©e (Affichage grille)
            grid.style.display = 'grid'; // Affiche la grille
            for(let i=0; i<42; i++) { 
                const c=document.createElement('div'); 
                c.className="p4-cell "+(game.board[i]===1?'p1':(game.board[i]===2?'p2':'')); 
                c.onclick=()=>playP4(i%7); 
                grid.appendChild(c); 
            }
        
            // Gestion de la victoire et du bouton
            if(game.winner) { 
                statusEl.innerText = game.winner === 'fr' ? "üèÜ BRAVO TH√âO !" : "üèÜ BRAVO ELISE !"; 
                btn.innerText = "Fin de partie"; // Changement de texte
                btn.onclick = finishP4; // Nouvelle action
                btn.disabled = false; 
                btn.style.opacity = "1"; 
                
                // Petit ajout : update le status en 'finished' si ce n'est pas fait
                if(game.status !== 'finished') updateDoc(doc(db,"games","p4_active"), {status: 'finished'});
            } else { 
                statusEl.innerText = (game.turn === 'fr' ? "Au tour de Th√©o (Bleu)" : "Au tour d'Elise (Rose)"); 
                btn.innerText = "Partie en cours...";
                btn.disabled = true; 
                btn.style.opacity = "0.5"; 
            } 
        }
        window.playP4 = async function(col) { if(!activeP4||activeP4.winner) return; if(activeP4.turn !== currentUser) { alert("Attends ton tour !"); return; } let board=[...activeP4.board]; let row=5; while(row>=0){ if(board[row*7+col]===0){ board[row*7+col]=(currentUser==='fr'?1:2); break; } row--; } if(row<0) return; const checkWin=b=>{for(let r=0;r<6;r++)for(let c=0;c<4;c++){let i=r*7+c;if(b[i]&&b[i]==b[i+1]&&b[i]==b[i+2]&&b[i]==b[i+3])return b[i]}for(let r=0;r<3;r++)for(let c=0;c<7;c++){let i=r*7+c;if(b[i]&&b[i]==b[i+7]&&b[i]==b[i+14]&&b[i]==b[i+21])return b[i]}for(let r=3;r<6;r++)for(let c=0;c<4;c++){let i=r*7+c;if(b[i]&&b[i]==b[i-6]&&b[i]==b[i-12]&&b[i]==b[i-18])return b[i]}for(let r=0;r<3;r++)for(let c=0;c<4;c++){let i=r*7+c;if(b[i]&&b[i]==b[i+8]&&b[i]==b[i+16]&&b[i]==b[i+24])return b[i]}return 0}; const winnerCode = checkWin(board); let winner = null; let moves = activeP4.moves + 1; if(winnerCode !== 0) { winner = winnerCode === 1 ? 'fr' : 'tw'; addDoc(collection(db, "games_p4_history"), { winner: winner, moves: Math.ceil(moves/2), timestamp: serverTimestamp() }); } updateDoc(doc(db,"games","p4_active"),{ board:board, turn:currentUser==='fr'?'tw':'fr', winner:winner, moves:moves }); }
        window.finishP4 = function() {
            updateDoc(doc(db, "games", "p4_active"), { 
                status: 'idle', 
                winner: null,
                board: []
            });
        }
        
        let activeUno = null; let pickingWild = false; let wildCardIndex = -1;
        onSnapshot(doc(db, "games", "uno_active"), (s) => { activeUno = s.exists() ? s.data() : null; if(activeUno) renderUno(activeUno); else document.getElementById('uno-status').innerText = "Aucune partie en cours"; });
        // --- HISTORIQUE UNO (Color√©) ---
        onSnapshot(query(collection(db, "games_uno_history"), orderBy("timestamp", "desc"), limit(50)), (s) => { 
            const list = document.getElementById('uno-history-list'); 
            list.innerHTML = ""; 
            s.forEach(d => { 
                const h = d.data(); 
                const dateStr = h.timestamp ? new Date(h.timestamp.toDate()).toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'}) : ""; 
                const moves = h.moves || "?";
                
                // Logique couleur
                const winName = h.winner === 'fr' ? 'Th√©o' : 'Elise';
                const winColor = h.winner === 'fr' ? 'var(--blue)' : 'var(--pink)';
                
                list.innerHTML += `
                <div class="hist-row">
                    <span>${dateStr} - <b style="color:${winColor}">${winName}</b></span>
                    <span>en ${moves} coups</span>
                </div>`; 
            }); 
        });

        window.initUno = function() {
            const colors = ['red', 'blue', 'green', 'yellow'];
            const values = ['0','1','2','3','4','5','6','7','8','9','p2','s'];
            let deck = [];
            colors.forEach(c => values.forEach(v => { deck.push(`${c}-${v}`); deck.push(`${c}-${v}`); }));
            deck.push("black-w", "black-w", "black-w", "black-w");
            deck.push("black-p4", "black-p4", "black-p4", "black-p4");
            deck.sort(() => Math.random() - 0.5);
            const hand_fr = deck.splice(0, 7); const hand_tw = deck.splice(0, 7); const discard = [deck.shift()];
            setDoc(doc(db, "games", "uno_active"), { deck: deck, discard: discard, hand_fr: hand_fr, hand_tw: hand_tw, turn: currentUser, winner: null, moves: 0, status: 'playing'});
        }
        function renderUno(game) {
            document.getElementById('btn-uno').classList.toggle('is-running', game.status === 'playing');
            const btn = document.getElementById('uno-restart-btn');
            const boardDiv = document.querySelector('.uno-board'); // Pour cacher le jeu
        
            // CAS 1 : Idle / Pas commenc√©
            if (!game.status || game.status === 'idle') {
                document.getElementById('uno-status').innerText = "Pr√™t pour une partie ?";
                boardDiv.style.display = 'none'; // Cache les cartes
                btn.innerText = "Lancer";
                btn.onclick = initUno;
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.background = "var(--blue-dark)";
                return;
            }
        
            // CAS 2 : Partie en cours ou finie (Affiche le plateau)
            boardDiv.style.display = 'block';
        
            if(game.winner) {
                document.getElementById('uno-status').innerText = `GAGNANT : ${game.winner==='fr'?'Th√©o':'Elise'} !`;
                btn.innerText = "Fin de partie";
                btn.onclick = finishUno;
                btn.disabled = false; 
                btn.style.opacity = "1";
                btn.style.background = "var(--pink-dark)"; // Changement de couleur pour "Fin"
            } else {
                document.getElementById('uno-status').innerText = (game.turn === currentUser ? "√Ä toi de jouer !" : "Tour de l'adversaire...");
                btn.innerText = "Partie en cours...";
                btn.disabled = true; 
                btn.style.opacity = "0.5";
            }
            
            document.getElementById('uno-opponent-name').innerText = currentUser==='fr'?'Elise':'Th√©o';
            document.getElementById('uno-opponent-count').innerText = currentUser==='fr' ? game.hand_tw.length : game.hand_fr.length;
            const topCard = game.discard[game.discard.length - 1];
            const [topColor, topVal] = topCard.split('-');
            const pileEl = document.getElementById('uno-discard-pile');
            pileEl.innerHTML = `<div class="uno-card ${topColor}">${formatUnoVal(topVal)}</div>`;
            const myHand = currentUser==='fr' ? game.hand_fr : game.hand_tw;
            const handEl = document.getElementById('uno-player-hand');
            handEl.innerHTML = "";
            myHand.forEach((card, idx) => {
                const [c, v] = card.split('-');
                handEl.innerHTML += `<div class="uno-card ${c}" onclick="playUnoCard(${idx})">${formatUnoVal(v)}</div>`;
            });
        }
        function formatUnoVal(v) { if(v==='p2') return '+2'; if(v==='s') return 'üö´'; if(v==='w') return 'üåà'; if(v==='p4') return '+4'; return v; }
        window.drawUnoCard = function() {
            if(!activeUno || activeUno.winner || activeUno.turn !== currentUser) return;
            if(pickingWild) return;
            let deck = [...activeUno.deck];
            if(deck.length === 0) { alert("Pioche vide !"); return; }
            const card = deck.shift();
            const myHand = currentUser==='fr' ? [...activeUno.hand_fr] : [...activeUno.hand_tw];
            myHand.push(card);
            const moves = activeUno.moves + 1;
            const nextTurn = currentUser==='fr'?'tw':'fr'; 
            updateDoc(doc(db, "games", "uno_active"), { deck: deck, [`hand_${currentUser}`]: myHand, turn: nextTurn, moves: moves });
        }
        window.playUnoCard = function(idx) {
            if(!activeUno || activeUno.winner || activeUno.turn !== currentUser) return;
            if(pickingWild) return;
            const myHand = currentUser==='fr' ? [...activeUno.hand_fr] : [...activeUno.hand_tw];
            const card = myHand[idx];
            const [color, val] = card.split('-');
            const topCard = activeUno.discard[activeUno.discard.length - 1];
            const [topColor, topVal] = topCard.split('-');
            let valid = false;
            if (color === 'black') { wildCardIndex = idx; pickingWild = true; document.getElementById('uno-color-modal').style.display = 'flex'; return; } else if (color === topColor || val === topVal) { valid = true; }
            if (!valid) return;
            executePlay(idx, null);
        }
        window.finishUno = function() {
            updateDoc(doc(db, "games", "uno_active"), { status: 'idle', winner: null });
        }
        window.chooseUnoColor = function(color) { document.getElementById('uno-color-modal').style.display = 'none'; pickingWild = false; executePlay(wildCardIndex, color); }
        function executePlay(idx, chosenColor) {
            const myHand = currentUser==='fr' ? [...activeUno.hand_fr] : [...activeUno.hand_tw];
            const card = myHand[idx];
            const [color, val] = card.split('-');
            myHand.splice(idx, 1);
            let nextDiscard = card;
            if(chosenColor) nextDiscard = `${chosenColor}-${val}`;
            const newDiscard = [...activeUno.discard, nextDiscard];
            const moves = activeUno.moves + 1;
            if (myHand.length === 0) {
                updateDoc(doc(db, "games", "uno_active"), { [`hand_${currentUser}`]: myHand, discard: newDiscard, winner: currentUser, moves: moves });
                addDoc(collection(db, "games_uno_history"), { winner: currentUser, moves: Math.ceil(moves/2), timestamp: serverTimestamp() });
                return;
            }
            let nextTurn = currentUser==='fr'?'tw':'fr';
            let opponentHand = currentUser==='fr' ? [...activeUno.hand_tw] : [...activeUno.hand_fr];
            let deck = [...activeUno.deck];
            if (val === 'p2') {
                if(deck.length>=2) { opponentHand.push(deck.shift()); opponentHand.push(deck.shift()); }
                nextTurn = currentUser==='fr'?'tw':'fr'; 
            } else if (val === 'p4') {
                if(deck.length>=4) { for(let i=0;i<4;i++) opponentHand.push(deck.shift()); }
                nextTurn = currentUser==='fr'?'tw':'fr'; 
            } else if (val === 's') { nextTurn = currentUser; }
            updateDoc(doc(db, "games", "uno_active"), { deck: deck, discard: newDiscard, hand_fr: currentUser==='fr'?myHand:opponentHand, hand_tw: currentUser==='tw'?myHand:opponentHand, turn: nextTurn, moves: moves });
        }

        // --- PETIT BAC (V66) ---
        // La liste compl√®te (17 cat√©gories)
        const allBacCategories = [
            "Pr√©nom F√©minin", "Pr√©nom Masculin", "Ville", "Pays", "Nourriture", "M√©tier", 
            "Animal", "Sport", "Objet", "Personnage Fictif", "Personnalit√© Publique", 
            "Film", "Marque", "Plante", "V√™tement", "Dessin Anim√©", "S√©rie T√©l√©vis√©e"
        ];
        let activeBac = null;
        
        // √âcouteur Firebase Principal
        onSnapshot(doc(db, "games", "bac_active"), (s) => {
            activeBac = s.exists() ? s.data() : null;
            if (activeBac) renderBac(activeBac);
        });
        
        // 1. ACTION : Se mettre pr√™t (Toggle)
        window.bacToggleReady = function() {
            if (!activeBac) { bacReset(); return; }
            if (activeBac.status !== 'waiting') return; // Bloqu√© si jeu lanc√©
        
            const amIReady = activeBac[`ready_${currentUser}`];
            const opponent = currentUser === 'fr' ? 'tw' : 'fr';
            const isOppReady = activeBac[`ready_${opponent}`];
        
            // Si je passe de "Pas pr√™t" √† "Pr√™t"
            if (!amIReady) {
                // Si l'autre est D√âJ√Ä pr√™t, on lance tout de suite !
                if (isOppReady) {
                    const letter = "ABCDEFGHIJKLMNOPRSTUV".charAt(Math.floor(Math.random() * 21));
                    const shuffled = [...allBacCategories].sort(() => 0.5 - Math.random());
                    const selected = shuffled.slice(0, 6); // On garde 6 cat√©gories
        
                    updateDoc(doc(db, "games", "bac_active"), {
                        [`ready_${currentUser}`]: true,
                        status: 'playing',
                        letter: letter,
                        currentCategories: selected,
                        startTime: serverTimestamp()
                    });
                } else {
                    // Sinon j'attends
                    updateDoc(doc(db, "games", "bac_active"), { [`ready_${currentUser}`]: true });
                }
            } else {
                // J'annule mon "Pr√™t"
                updateDoc(doc(db, "games", "bac_active"), { [`ready_${currentUser}`]: false });
            }
        };
        
        // 2. ACTION : R√©initialiser (Relancer)
        window.bacReset = function() {
            setDoc(doc(db, "games", "bac_active"), {
                status: 'waiting',
                ready_fr: false, ready_tw: false,
                skip_fr: false, skip_tw: false,
                review_done_fr: false, review_done_tw: false,
                answers_fr: {}, answers_tw: {},
                scores_fr: {}, scores_tw: {},
                startTime: serverTimestamp()
            });
        };
        
        // 3. MOTEUR D'AFFICHAGE
        function renderBac(game) {
            const isActive = game.status === 'playing' || game.status === 'review';
            document.getElementById('btn-bac').classList.toggle('is-running', isActive);
            const lobby = document.getElementById('bac-lobby');
            const board = document.getElementById('bac-game');
            const review = document.getElementById('bac-review');
            const finished = document.getElementById('bac-finished');
        
            // S√©curit√© : Si un √©l√©ment manque, on arr√™te pour pas faire planter le reste
            if(!lobby || !board || !review || !finished) return;
        
            // Reset visuel
            lobby.style.display = 'none';
            board.style.display = 'none';
            review.style.display = 'none';
            finished.style.display = 'none';
        
            const currentCats = game.currentCategories || [];
        
            // --- A. LOBBY (Attente) ---
            if (game.status === 'waiting') {
                lobby.style.display = 'block';
                
                // Styles pour les ic√¥nes (Cliquable ou pas)
                const frClass = currentUser === 'fr' ? "transform:scale(1.1); border:2px solid var(--blue); cursor:pointer;" : "opacity:0.7;";
                const twClass = currentUser === 'tw' ? "transform:scale(1.1); border:2px solid var(--pink); cursor:pointer;" : "opacity:0.7;";
                
                // Seul l'utilisateur peut cliquer sur SON ic√¥ne
                const frClick = currentUser === 'fr' ? 'onclick="bacToggleReady()"' : '';
                const twClick = currentUser === 'tw' ? 'onclick="bacToggleReady()"' : '';
        
                lobby.innerHTML = `
                    <div style="font-size:1.1rem; font-weight:800; margin-bottom:20px; color:var(--text-main);">Touchez votre ic√¥ne pour valider !</div>
                    
                    <div style="display:flex; justify-content:space-around; margin-bottom:20px; align-items:center;">
                        <div style="text-align:center; padding:10px; border-radius:15px; transition:0.2s; ${frClass}" ${frClick}>
                            <div style="font-size:3.5rem;">${game.ready_fr ? 'ü§¥üèª' : 'üë®üèª'}</div>
                            <div style="font-weight:bold;">Th√©o</div>
                            <div style="font-size:1.5rem;">${game.ready_fr ? '‚úÖ' : '‚è≥'}</div>
                        </div>
        
                        <div style="text-align:center; padding:10px; border-radius:15px; transition:0.2s; ${twClass}" ${twClick}>
                            <div style="font-size:3.5rem;">${game.ready_tw ? 'üë∏üèª' : 'üë©üèª'}</div>
                            <div style="font-weight:bold;">Elise</div>
                            <div style="font-size:1.5rem;">${game.ready_tw ? '‚úÖ' : '‚è≥'}</div>
                        </div>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-sub);">La partie commence quand les deux sont ‚úÖ</div>
                `;
            }
        
            // --- B. JEU (Saisie) ---
            else if (game.status === 'playing') {
                board.style.display = 'block';
                document.getElementById('bac-current-letter').innerText = "Lettre : " + game.letter;
                
                const container = document.getElementById('bac-inputs');
                // On g√©n√®re les inputs SEULEMENT si la liste est vide (pour ne pas effacer ce qu'on √©crit)
                if (container.innerHTML === "" || container.children.length !== currentCats.length) {
                    container.innerHTML = "";
                    currentCats.forEach((cat, i) => {
                        container.innerHTML += `
                            <div class="bac-row">
                                <span class="bac-label">${cat}</span>
                                <input type="text" class="bac-input" id="bac-in-${i}" placeholder="Commence par ${game.letter}...">
                            </div>`;
                    });
                }
        
                // Bouton Skip (Gris√© si d√©j√† cliqu√©)
                const skipBtn = document.getElementById('bac-btn-skip');
                if (game[`skip_${currentUser}`]) {
                    skipBtn.innerText = "En attente...";
                    skipBtn.style.background = "#bdc3c7";
                    skipBtn.disabled = true;
                } else {
                    skipBtn.innerText = "On passe ?";
                    skipBtn.style.background = "#e67e22";
                    skipBtn.disabled = false;
                }
            }
        
            // --- C. CORRECTION (Notation) ---
            else if (game.status === 'review') {
                // Envoi d'urgence des r√©ponses si on √©tait encore sur l'√©cran de jeu
                if (document.getElementById('bac-inputs').innerHTML !== "") { 
                     bacSendAnswers(); 
                     document.getElementById('bac-inputs').innerHTML = ""; 
                }
        
                review.style.display = 'block';
                const opponent = currentUser === 'fr' ? 'tw' : 'fr';
                const oppName = opponent === 'fr' ? 'Th√©o' : 'Elise';
                const oppAnswers = game[`answers_${opponent}`] || {};
                const myGivenScores = game[`scores_${opponent}`] || {}; // Les points que JE donne
        
                const list = document.getElementById('bac-review-list');
                let html = `<div style="text-align:center;margin-bottom:15px;font-style:italic;">Note les r√©ponses de <b style="color:var(--blue-dark)">${oppName}</b></div>`;
                
                currentCats.forEach((cat, i) => {
                    const ans = oppAnswers[i] || "<i>(Rien)</i>";
                    const score = myGivenScores[i]; // 0, 1 ou 2
        
                    html += `
                    <div class="review-item">
                        <div class="bac-label">${cat}</div>
                        <div class="review-ans">${ans}</div>
                        <div class="review-btns">
                            <button class="r-btn r-btn-0 ${score===0?'selected':''}" onclick="bacRate('${opponent}', ${i}, 0)">‚ùå 0</button>
                            <button class="r-btn r-btn-1 ${score===1?'selected':''}" onclick="bacRate('${opponent}', ${i}, 1)">ü§ù 1</button>
                            <button class="r-btn r-btn-2 ${score===2?'selected':''}" onclick="bacRate('${opponent}', ${i}, 2)">‚úÖ 2</button>
                        </div>
                    </div>`;
                });
                list.innerHTML = html;
        
                // Bouton "Fin de partie" (Appara√Æt seulement si TOUT est not√©)
                const actionsDiv = document.getElementById('bac-review-actions');
                const isDone = Object.keys(myGivenScores).length === currentCats.length;
                
                if (game[`review_done_${currentUser}`]) {
                     actionsDiv.innerHTML = `<div style="color:green; text-align:center; font-weight:bold;">‚úÖ Valid√© ! Attente de l'autre...</div>`;
                } else if (isDone) {
                     actionsDiv.innerHTML = `
                        <button onclick="bacConfirmReviewEnd()" class="btn-action" style="width:100%; background:var(--pink-dark); animation:pulse 1s infinite;">
                            Fin de correction
                        </button>`;
                } else {
                     actionsDiv.innerHTML = `<div style="text-align:center; font-size:0.8rem; color:#999;">Note toutes les r√©ponses pour finir.</div>`;
                }
            }
        
            // --- D. R√âSULTATS (Tableau Comparatif) ---
            else if (game.status === 'finished') {
                finished.style.display = 'block';
                
                // Calcul des scores totaux
                let sFr = 0; Object.values(game.scores_fr || {}).forEach(v => sFr += v);
                let sTw = 0; Object.values(game.scores_tw || {}).forEach(v => sTw += v);
        
                // Affiche le vainqueur
                document.getElementById('bac-winner-text').innerText = sFr > sTw ? "Th√©o gagne ! üéâ" : (sTw > sFr ? "Elise gagne ! üéâ" : "√âgalit√© ! ü§ù");
                document.getElementById('bac-winner-icon').innerText = sFr > sTw ? "ü§¥üèª" : (sTw > sFr ? "üë∏üèª" : "‚öñÔ∏è");
                document.getElementById('bac-score-text').innerText = `Th√©o : ${sFr} pts ‚Ä¢ Elise : ${sTw} pts`;
        
                // Construction du tableau d√©taill√©
                let tableHtml = `
                    <table class="bac-res-table">
                        <tr class="bac-res-header"><th>Cat√©gorie</th><th>Th√©o</th><th>Elise</th></tr>
                `;
                
                currentCats.forEach((cat, i) => {
                    const ansFr = (game.answers_fr && game.answers_fr[i]) || "-";
                    const ptsFr = (game.scores_fr && game.scores_fr[i]) !== undefined ? game.scores_fr[i] : "?";
                    
                    const ansTw = (game.answers_tw && game.answers_tw[i]) || "-";
                    const ptsTw = (game.scores_tw && game.scores_tw[i]) !== undefined ? game.scores_tw[i] : "?";
        
                    tableHtml += `
                        <tr class="bac-res-row">
                            <td class="bac-res-cat">${cat}</td>
                            <td>
                                <div class="bac-res-ans">${ansFr}</div>
                                <span class="bac-badge bg-${ptsFr}">${ptsFr} pts</span>
                            </td>
                            <td>
                                <div class="bac-res-ans">${ansTw}</div>
                                <span class="bac-badge bg-${ptsTw}">${ptsTw} pts</span>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `</table>`;
                document.getElementById('bac-results-table-container').innerHTML = tableHtml;
            }
        }
        
        // 4. FONCTIONS UTILITAIRES (Pour les clics)
        window.bacTryFinish = function() {
            let answers = {};
            const cats = activeBac.currentCategories || [];
            cats.forEach((_, i) => {
                const el = document.getElementById(`bac-in-${i}`);
                answers[i] = el ? el.value.trim() : "";
            });
            // On envoie les r√©ponses et on passe en review (ce qui stoppe l'autre)
            updateDoc(doc(db, "games", "bac_active"), {
                [`answers_${currentUser}`]: answers,
                status: 'review' 
            });
        };
        
        window.bacSendAnswers = function() {
            let answers = {};
            const cats = activeBac.currentCategories || [];
            cats.forEach((_, i) => {
                const el = document.getElementById(`bac-in-${i}`);
                answers[i] = el ? el.value.trim() : "";
            });
            updateDoc(doc(db, "games", "bac_active"), { [`answers_${currentUser}`]: answers });
        };
        
        window.bacVoteSkip = function() {
            bacSendAnswers(); // Sauvegarde par s√©curit√©
            updateDoc(doc(db, "games", "bac_active"), { [`skip_${currentUser}`]: true });
            
            // Si l'autre a d√©j√† skip, on passe en review
            const opponent = currentUser === 'fr' ? 'tw' : 'fr';
            if (activeBac[`skip_${opponent}`]) {
                updateDoc(doc(db, "games", "bac_active"), { status: 'review' });
            }
        };
        
        window.bacRate = function(targetUser, index, points) {
            let update = {};
            update[`scores_${targetUser}.${index}`] = points;
            updateDoc(doc(db, "games", "bac_active"), update);
        };
        
        window.bacConfirmReviewEnd = function() {
            updateDoc(doc(db, "games", "bac_active"), { [`review_done_${currentUser}`]: true });
            
            // Si l'autre a aussi fini, on termine
            const opponent = currentUser === 'fr' ? 'tw' : 'fr';
            // On v√©rifie activeBac car on est dans une fonction async/event
            if (activeBac && activeBac[`review_done_${opponent}`]) {
                updateDoc(doc(db, "games", "bac_active"), { status: 'finished' });
                
                // Calcul des scores
                let sFr = 0; Object.values(activeBac.scores_fr || {}).forEach(v => sFr += v);
                let sTw = 0; Object.values(activeBac.scores_tw || {}).forEach(v => sTw += v);
                
                // --- CORRECTION ICI : D√âTERMINER LE GAGNANT ---
                let winner = 'draw'; // Par d√©faut √©galit√©
                if (sFr > sTw) winner = 'fr';
                else if (sTw > sFr) winner = 'tw';
        
                // Ajout √† l'historique AVEC le gagnant
                addDoc(collection(db, "games_bac_history"), {
                    letter: activeBac.letter,
                    score_fr: sFr, 
                    score_tw: sTw,
                    winner: winner, // C'est ce champ qui manquait !
                    timestamp: serverTimestamp()
                });
            }
        };
        
        function endBacGame(game) {
            // Calcul scores
            let sFr = 0; let sTw = 0;
            Object.values(game.scores_fr).forEach(v => sFr += v); // Points donn√©s √Ä Fr
            Object.values(game.scores_tw).forEach(v => sTw += v); // Points donn√©s √Ä Tw
            
            let winner = sFr > sTw ? 'fr' : (sTw > sFr ? 'tw' : 'draw');
            
            // Historique
            addDoc(collection(db, "games_bac_history"), {
                letter: game.letter,
                score_fr: sFr,
                score_tw: sTw,
                winner: winner,
                timestamp: serverTimestamp()
            });
        
            // Reset complet
            updateDoc(doc(db, "games", "bac_active"), { status: 'finished' });
        }
        
        // --- HISTORIQUE PETIT BAC (Harmonis√©) ---
        onSnapshot(query(collection(db, "games_bac_history"), orderBy("timestamp", "desc"), limit(20)), (s) => {
            const list = document.getElementById('bac-history-list');
            list.innerHTML = "";
            s.forEach(d => {
                const h = d.data();
                const dateStr = h.timestamp ? new Date(h.timestamp.toDate()).toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'}) : "";
        
                // Logique Gagnant
                let winName = '√âgalit√©';
                let winColor = 'var(--text-sub)'; // Gris par d√©faut
                
                if (h.winner === 'fr') { winName = 'Th√©o'; winColor = 'var(--blue)'; }
                else if (h.winner === 'tw') { winName = 'Elise'; winColor = 'var(--pink)'; }
        
                list.innerHTML += `
                <div class="hist-row">
                    <span>${dateStr} - <b style="color:${winColor}">${winName}</b></span>
                    
                    <span>Lettre <b>${h.letter}</b> (${h.score_fr}-${h.score_tw})</span>
                </div>`;
            });
        });

        // --- COMMON ---
        function updatePresence() { setDoc(doc(db, "status", "presence"), { [currentUser]: Date.now() }, { merge: true }); }
        setInterval(updatePresence, 5000); updatePresence();
        onSnapshot(doc(db, "status", "presence"), (docSnap) => { 
            if(docSnap.exists()) { 
                const d = docSnap.data(); 
                const now = Date.now(); 
                const isOnlineFr = (now - d.fr) < 60000 && d.fr !== 0; 
                const isOnlineTw = (now - d.tw) < 60000 && d.tw !== 0; 
                document.getElementById('dot-fr').classList.toggle('online', isOnlineFr); 
                document.getElementById('dot-tw').classList.toggle('online', isOnlineTw); 
            } 
        });
        async function updateWeather() { 
            try { 
                const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=45.77,24.99&longitude=3.08,121.30&current_weather=true"); 
                const d = await r.json(); 
                
                // On cible les deux colonnes (0 = France, 1 = Ta√Øwan)
                const cols = document.querySelectorAll('.journey-col');
        
                // --- FRANCE ---
                const tFr = Math.round(d[0].current_weather.temperature);
                const isDayFr = d[0].current_weather.is_day === 1;
                const codeFr = d[0].current_weather.weathercode;
                
                document.getElementById('weather-fr').innerText = `${getWeatherIcon(codeFr, isDayFr)} ${tFr}¬∞C`;
                
                // Appliquer les effets visuels France
                cols[0].classList.toggle('is-night', !isDayFr); // Active 'Nuit' si pas jour
                cols[0].classList.toggle('is-rain', codeFr >= 51); // Active 'Pluie' si code m√©t√©o > 51
        
                // --- TA√èWAN ---
                const tTw = Math.round(d[1].current_weather.temperature);
                const isDayTw = d[1].current_weather.is_day === 1;
                const codeTw = d[1].current_weather.weathercode;
                
                document.getElementById('weather-tw').innerText = `${getWeatherIcon(codeTw, isDayTw)} ${tTw}¬∞C`;
        
                // Appliquer les effets visuels Ta√Øwan
                cols[1].classList.toggle('is-night', !isDayTw);
                cols[1].classList.toggle('is-rain', codeTw >= 51);
        
            } catch(e){ console.log(e); } 
        }

        // (Garde ta fonction getWeatherIcon identique)
        function getWeatherIcon(code, isDay) {
            if (code >= 95) return "‚ö°";
            if (code >= 51) return "üåßÔ∏è";
            if (code >= 71) return "‚ùÑÔ∏è";
            if (!isDay) return "üåô";
            return "‚òÄÔ∏è";
        }
        updateWeather();
        const dateDepart = new Date("2026-02-14T00:00:00+01:00").getTime(); const dateRetour = new Date("2026-07-05T08:00:00+02:00").getTime(); 
        function updateCountdown() { const now=new Date().getTime(); let p=0; if(now>dateDepart && now<dateRetour) p=((now-dateDepart)/(dateRetour-dateDepart))*100; if(now>dateRetour) p=100; const dist=(now<dateDepart?dateDepart:dateRetour)-now; const dDisplay=dist>0?dist:0; const days=Math.floor(dDisplay/(1000*60*60*24)); document.getElementById('days-count').innerText=days; document.getElementById('days-unit').innerText=days<=1?"JOUR":"JOURS"; document.getElementById('sub-count').innerText=`${Math.floor((dDisplay%(1000*60*60*24))/(1000*60*60))} h et ${Math.floor((dDisplay%(1000*60*60))/(1000*60))} min`; document.getElementById('countdown-title').innerText=now<dateDepart?"D√âPART DANS":"RETROUVAILLES DANS"; document.getElementById("prog-fill").style.width=p+"%"; document.getElementById("prog-heart").style.left=p+"%"; } setInterval(updateCountdown,1000);
        function getCurrentTime(role) { return new Date().toLocaleTimeString('fr-FR', { timeZone: role==='fr'?'Europe/Paris':'Asia/Taipei', hour:'2-digit', minute:'2-digit' }); }
        
        function sendNtfy(msg, tag, prio) { 
            const iconUrl = new URL("icon_2.jpg", window.location.href).href; 
            fetch(`https://ntfy.sh/${currentUser==='tw'?"lovetravel-2026-reception-theo":"lovetravel-2026-reception-elise"}`, { method:'POST', body:msg, headers:{'Title':currentUser==='tw'?"Elise":"Theo",'Priority':prio,'Tags':tag,'Icon':iconUrl} }).catch(e=>{}); 
        }

        window.updateMood = function(emoji, text, outfitId) {
            setDoc(doc(db, "status", "moods"), { [currentUser+"_emoji"]: emoji, [currentUser+"_text"]: text, [currentUser+"_outfit"]: (outfitId !== undefined ? outfitId : 5) }, { merge: true });
            sendNtfy(`${emoji} ${text} (${getCurrentTime(currentUser)})`, "partly_sunny", "low");
        }
        window.customMood = function() { const text = prompt("Ta phrase :"); if(text) updateMood("‚ú®", text, 5); }

        // --- GESTION CYCLE ET CLIC ---
        let currentCycleDay = 1;
        
        // 1. AFFICHAGE ET LOGIQUE COULEUR
        onSnapshot(doc(db, "status", "cycle"), (docSnap) => {
            const ring = document.getElementById('cycle-ring');
            const txtDay = document.getElementById('cycle-day');
            const txtIcon = document.getElementById('cycle-icon');
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                const lastStart = data.lastStart ? data.lastStart.toDate() : new Date();
                
                // Calcul jours √©coul√©s
                const now = new Date();
                const diffTime = Math.abs(now - lastStart);
                const rawDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                // Modulo 28
                let dayInCycle = ((rawDays - 1) % 28) + 1;
                currentCycleDay = dayInCycle;
        
                // Est-ce la semaine de r√®gles ? (J1 √† J7)
                const isPeriod = dayInCycle <= 7;
        
                // TEXTE et ICONE
                txtDay.innerText = `J-${dayInCycle}`;
                txtIcon.innerText = isPeriod ? "ü©∏" : "üå∏"; 
        
                // COULEURS DU TEXTE
                if (isPeriod) {
                    txtDay.className = "cycle-red-text";
                } else {
                    txtDay.className = "cycle-normal-text";
                }
        
                // --- C'EST ICI QUE LA MAGIE DES COULEURS OP√àRE ---
                
                // Pourcentage de remplissage du cercle
                const percentage = (dayInCycle / 28) * 100;
                
                let colorStart, colorEnd;
                
                if (isPeriod) {
                    // ROUGE : Rose Tendre -> Rose Vif (Ton pr√©f√©r√©)
                    colorStart = "#ff9a9e"; 
                    colorEnd = "#ff4b6e";
                } else {
                    // BLEU : Bleu Ciel Glac√© -> Bleu Oc√©an Profond (Nouveau !)
                    // Ce fort contraste cr√©e l'effet de relief/d√©grad√© que tu aimes
                    colorStart = "#a0e7ff"; // Tr√®s clair / Lumineux
                    colorEnd = "#0984e3";   // Profond / Intense
                }
        
                // Application du d√©grad√© conique
                ring.style.background = `conic-gradient(
                    ${colorEnd} 0%, 
                    ${colorStart} ${percentage}%, 
                    var(--border) ${percentage}%
                )`;
            }
});
        
        // --- NOUVELLE GESTION CYCLE (MODALES) ---

        // 1. Fonction utilitaire pour afficher la jolie alerte
        window.showAlert = function(title, msg, icon="‚ú®") {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('alert-icon').innerText = icon;
            document.getElementById('custom-alert').style.display = 'flex';
        }
        
        // 2. La fonction principale d√©clench√©e au clic sur le widget
        window.editCycle = function() {
            
            // --- CAS A : C'EST TH√âO (Envoi de soutien) ---
            if (currentUser === 'fr') {
                const today = new Date().toDateString();
                const lastSent = localStorage.getItem('lastCycleNotif');
        
                // Si d√©j√† envoy√© aujourd'hui
                if (lastSent === today) {
                    showAlert("Doucement tigre !", "Tu as d√©j√† envoy√© ton message de soutien aujourd'hui. Reviens demain ! ‚ù§Ô∏è", "‚è≥");
                    return;
                }
        
                // Sinon, envoi du message
                if (currentCycleDay <= 7) {
                    sendNtfy("Courage ma petite ch√©rie ‚ù§Ô∏è Je pense fort √† toi.", "rose", "high");
                    showAlert("Message envoy√© !", "Ton message de courage est parti vers elle üíå", "üöÄ");
                } else {
                    sendNtfy("N'oublie pas ta pilule mon c≈ìur üå∏", "pill", "high");
                    showAlert("Rappel envoy√© !", "La notification pilule est bien partie üíä", "‚úÖ");
                }
        
                localStorage.setItem('lastCycleNotif', today);
                return;
            }
        
            // --- CAS B : C'EST ELISE (Modification) ---
            // On ouvre la modale de modification au lieu du prompt moche
            const modal = document.getElementById('cycle-edit-modal');
            document.getElementById('cycle-input-val').value = currentCycleDay; // On pr√©-remplit avec le jour actuel
            modal.style.display = 'flex';
        }
        
        // 3. Fonctions pour la modale d'Elise
        window.adjustCycleInput = function(amount) {
            const input = document.getElementById('cycle-input-val');
            let val = parseInt(input.value) + amount;
            if(val < 1) val = 28; // Boucle
            if(val > 28) val = 1;
            input.value = val;
        }
        
        window.saveCycleChange = function() {
            const day = parseInt(document.getElementById('cycle-input-val').value);
            if (!isNaN(day) && day >= 1 && day <= 28) {
                // Recalcul de la date de d√©but
                const newStart = new Date();
                newStart.setDate(newStart.getDate() - (day - 1));
                
                setDoc(doc(db, "status", "cycle"), { 
                    lastStart: newStart,
                    type: 'auto'
                }, { merge: true });
                
                document.getElementById('cycle-edit-modal').style.display = 'none';
                showAlert("Cycle mis √† jour", `Le calendrier est maintenant cal√© sur J-${day} !`, "üå∏");
            }
        }
        
        window.resetCycleFull = function() {
            if(confirm("Confirmer que tes r√®gles commencent aujourd'hui ?")) {
                setDoc(doc(db, "status", "cycle"), { 
                    lastStart: serverTimestamp(),
                    type: 'auto'
                }, { merge: true });
                document.getElementById('cycle-edit-modal').style.display = 'none';
                // Petit effet f√™te
                confetti({ particleCount: 50, colors: ['#ff9eb5', '#ff4b6e'] });
            }
        }
        
            
        let allLetters = [];
        const qLetters = query(collection(db, "letters"), orderBy("timestamp", "desc"));
        onSnapshot(qLetters, (snapshot) => {
            allLetters = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            updateMailboxView();
        });
        window.showTab = function(tabName) {
            const tabInbox = document.getElementById('tab-inbox'); const tabSent = document.getElementById('tab-sent');
            if(tabName === 'inbox') {
                tabInbox.classList.add('active'); tabInbox.style.background = 'var(--pink)'; tabInbox.style.color = 'white';
                tabSent.classList.remove('active'); tabSent.style.background = 'transparent'; tabSent.style.color = 'var(--text-main)';
                document.getElementById('list-inbox').style.display='block'; document.getElementById('list-sent').style.display='none';
            } else {
                tabSent.classList.add('active'); tabSent.style.background = 'var(--blue)'; tabSent.style.color = 'white';
                tabInbox.classList.remove('active'); tabInbox.style.background = 'transparent'; tabInbox.style.color = 'var(--text-main)';
                document.getElementById('list-inbox').style.display='none'; document.getElementById('list-sent').style.display='block';
            }
        }
        window.updateMailboxView = function() {
            const listInbox = document.getElementById("list-inbox"); 
            const listSent = document.getElementById("list-sent");
            listInbox.innerHTML = ""; 
            listSent.innerHTML = "";
        
            allLetters.forEach(l => {
                const now = Date.now();
                // C'est verrouill√© si la date est future ET que ce n'est PAS moi l'auteur
                const isLocked = (l.unlockAt && now < l.unlockAt) && l.by !== currentUser;
        
                const div = document.createElement("div"); 
                div.className = `envelope-item ${(!l.read && l.by !== currentUser) ? 'unread' : ''}`;
                
                // 1. L'IC√îNE
                let icon = l.read ? 'üì©' : '‚úâÔ∏è';
                if (isLocked) icon = 'üîí';
        
                // 2. LE TITRE ET LE SOUS-TITRE
                let titleDisplay = l.title;
                let subText = "";
        
                // CAS A : C'est MOI qui ai envoy√© (Envoy√©s)
                if (l.by === currentUser) {
                    // J'affiche la date que j'ai choisie pour m'en souvenir
                    if (l.unlockAt) {
                        const dateObj = new Date(l.unlockAt);
                        // Ex: "Moi ‚Ä¢ Ouvre le 14/02/2026"
                        subText = `Accessible le ${dateObj.toLocaleDateString()}`;
                    } 
                } 
                // CAS B : J'ai RE√áU la lettre (Bo√Æte de r√©ception)
                else {
                    if (isLocked) {
                        // Si c'est bloqu√©, je cache le titre
                        const dateObj = new Date(l.unlockAt);
                        titleDisplay = `√Ä ouvrir le ${dateObj.toLocaleDateString()}`;
                        subText = "üîí Secret...";
                    } else {
                        // Sinon j'affiche de qui √ßa vient
                        subText = l.by==='fr' ? 'De: Th√©o' : 'De: Elise';
                    }
                }
        
                div.innerHTML = `
                    <div style="margin-right:15px; font-size:1.5rem;">${icon}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:0.9rem;">${titleDisplay}</div>
                        <div style="font-size:0.7rem; color:var(--text-sub);">${subText}</div>
                    </div>
                    ${l.by === currentUser ? `<button onclick="deleteLetter('${l.id}', event)" style="border:none;background:none;color:#faa;font-weight:bold;cursor:pointer;padding:5px;">‚úï</button>` : ''}
                `;
                
                div.onclick = (e) => { 
                    if(e.target.tagName === 'BUTTON') return; 
                    if (isLocked) { 
                        alert(`Patience... Cette lettre s'ouvrira le ${new Date(l.unlockAt).toLocaleDateString()} ü§´`); 
                        return; 
                    }
                    openLetterModal(l); 
                };
        
                if(l.by === currentUser) listSent.appendChild(div); else listInbox.appendChild(div);
            });
        }    
        window.showTab('inbox');

        window.addLetter = function() { 
            const t=document.getElementById("letter-title").value; 
            const c=document.getElementById("letter-content").value; 
            const d=document.getElementById("letter-unlock-date").value; // R√©cup date
            
            if(!t||!c)return; 
            
            // On calcule le timestamp de d√©verrouillage (Minuit le jour J)
            let unlockTimestamp = null;
            if(d) unlockTimestamp = new Date(d).getTime();
        
            addDoc(collection(db,"letters"),{
                title:t, content:c, by:currentUser, read:false, 
                unlockAt: unlockTimestamp, // Nouveau champ
                timestamp:serverTimestamp()
            }); 
            
            document.getElementById("letter-title").value="";
            document.getElementById("letter-content").value="";
            document.getElementById("letter-unlock-date").value="";
            sendNtfy("üíå Nouvelle lettre !","email","low"); 
        }
        window.openLetterModal = function(l) { document.getElementById('letter-modal').style.display="flex"; document.getElementById('modal-letter-title').innerText=l.title; document.getElementById('modal-letter-content').innerText=l.content; if(l.by!==currentUser && !l.read) updateDoc(doc(db,"letters",l.id),{read:true}); }
        window.closeLetter = function() { document.getElementById('letter-modal').style.display="none"; }

        // Une image de cadeau minimaliste (fond rose p√¢le + ic√¥ne cadeau)
        const GIFT_PLACEHOLDER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MDAgNTAwIj48cmVjdCB3aWR0PSI1MDAiIGhlaWdodD0iNTAwIiBmaWxsPSIjZmZmMGYzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMjAwIj7wn46BPC90ZXh0Pjwvc3ZnPg==";
        
        const compressImage = async (file) => { const bmp = await createImageBitmap(file); const cvs = document.createElement('canvas'); cvs.width=bmp.width*0.5; cvs.height=bmp.height*0.5; cvs.getContext('2d').drawImage(bmp,0,0,cvs.width,cvs.height); return cvs.toDataURL(file.type,0.6); };
        // --- VARIABLES TEMPORAIRES POUR L'UPLOAD ---
        let tempUploadFile = null;
        let tempUploadRole = null;
        
        // 1. D√âBUT : On s√©lectionne le fichier
        window.handlePhotoUpload = function(inpt, role) { 
            if(role !== currentUser){ alert("Interdit !"); return; } 
            
            const f = inpt.files[0]; 
            if(!f) return; 
        
            // On sauvegarde le fichier pour plus tard
            tempUploadFile = f;
            tempUploadRole = role;
            
            // On vide l'input pour pouvoir s√©lectionner le m√™me fichier si on annule
            inpt.value = ""; 
        
            // On ouvre notre jolie fen√™tre de choix
            document.getElementById('upload-choice-modal').style.display = "flex";
        }
        
        // 2. FIN : On confirme le choix (Oui ou Non)
        window.confirmUpload = async function(isSurprise) {
            // On ferme la fen√™tre
            document.getElementById('upload-choice-modal').style.display = "none";
            document.getElementById('gallery-modal').style.display = "none"; // On ferme aussi la galerie si ouverte
        
            if (!tempUploadFile || !tempUploadRole) return;
        
            // --- LOGIQUE D'UPLOAD CLASSIQUE ---
            const b64 = await compressImage(tempUploadFile); 
            
            await addDoc(collection(db, "photos"), {
                url: b64, 
                by: tempUploadRole, 
                isSurprise: isSurprise,  // Le choix du bouton (Vrai ou Faux)
                scratched: false,
                timestamp: serverTimestamp()
            }); 
            
            const icon = isSurprise ? "gift" : "camera";
            const msg = isSurprise ? "üéÅ Photo Surprise !" : "üì∏ Nouvelle photo !";
            
            sendNtfy(`${msg} (${getCurrentTime(currentUser)})`, icon, "low");
        
            // Reset des variables
            tempUploadFile = null;
            tempUploadRole = null;
        }
        
        // 3. ANNULATION
        window.cancelUpload = function() {
            document.getElementById('upload-choice-modal').style.display = "none";
            tempUploadFile = null;
            tempUploadRole = null;
        }
        // --- GESTION DES POLAROIDS (Avec cachette surprise) ---
        let allPhotos = [];
        
        onSnapshot(query(collection(db, "photos"), orderBy("timestamp", "desc")), (s) => {
            allPhotos = s.docs.map(d => ({id: d.id, ...d.data()}));
            
            // Fonction pour d√©terminer quelle image afficher sur le polaroid
            const getPolaroidSrc = (p) => {
                // C'est cach√© SI : C'est une surprise + Pas encore gratt√© + Ce n'est pas moi l'auteur
                const isHidden = p.isSurprise && !p.scratched && p.by !== currentUser;
                
                if (isHidden) {
                    return GIFT_PLACEHOLDER; // On affiche le cadeau
                } else {
                    return p.url; // On affiche la vraie photo
                }
            };
        
            // 1. Mise √† jour Polaroid TH√âO (fr)
            // On cherche la derni√®re photo post√©e par Th√©o
            const lastFr = allPhotos.find(p => p.by === 'fr');
            if (lastFr) {
                document.getElementById('polaroid-img-fr').src = getPolaroidSrc(lastFr);
            } else {
                // Optionnel : Image vide si aucune photo
                document.getElementById('polaroid-img-fr').src = ""; 
            }
        
            // 2. Mise √† jour Polaroid ELISE (tw)
            // On cherche la derni√®re photo post√©e par Elise
            const lastTw = allPhotos.find(p => p.by === 'tw');
            if (lastTw) {
                document.getElementById('polaroid-img-tw').src = getPolaroidSrc(lastTw);
            } else {
                document.getElementById('polaroid-img-tw').src = "";
            }
        });
        let currentScratchId = null; // Pour savoir quelle photo on gratte

        window.openGallery = function(role) { 
            const m = document.getElementById('gallery-modal'); 
            const g = document.getElementById('modal-grid'); 
            g.innerHTML = ""; 
            
            allPhotos.filter(p => p.by === role).forEach(p => { 
                const dStr = p.timestamp ? new Date(p.timestamp.toDate()).toLocaleDateString('fr-FR') : "";
                
                // LOGIQUE D'AFFICHAGE
                // 1. Est-ce que c'est une surprise ?
                const isSurprise = p.isSurprise === true;
                // 2. Est-ce que c'est D√âJ√Ä gratt√© ?
                const isRevealed = p.scratched === true;
                // 3. Est-ce que c'est MA photo ? (Si oui, je vois tout, pas de suspense pour moi)
                const isMine = p.by === currentUser;
        
                // Condition Finale : Dois-je la cacher ?
                // On cache SEULEMENT SI : C'est une surprise + Pas encore gratt√© + Ce n'est pas moi l'auteur
                const needScratch = isSurprise && !isRevealed && !isMine;
        
                // Style : Flou + Noir et Blanc si cach√©
                const imgStyle = needScratch ? "filter: blur(15px) grayscale(1);" : "";
                
                // Click : Soit on gratte, soit on ouvre la lightbox normale
                const clickAction = needScratch ? `startScratch('${p.id}', '${p.url}')` : `showLightbox('${p.url}')`;
        
                g.innerHTML += `
                <div id="photo-${p.id}" style="position:relative; overflow:hidden; border-radius:5px;">
                    <img src="${p.url}" class="modal-img" style="${imgStyle}" onclick="${clickAction}">
                    
                    <div class="photo-date">${dStr}</div>
                    
                    ${role === currentUser ? `<div style="color:red;font-size:0.8rem;text-align:center;cursor:pointer;" onclick="deletePhoto('${p.id}')">Supprimer</div>` : ''}
                    
                    ${needScratch ? `<div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:2.5rem; pointer-events:none; filter:drop-shadow(0 0 10px rgba(0,0,0,0.5));">üéÅ</div>` : ''}
                </div>`; 
            }); 
            m.style.display = "block"; 
        }
        
        // Fonction utilitaire pour ouvrir la lightbox (plus propre)
        window.showLightbox = function(url) {
            document.getElementById('lightbox').style.display='flex';
            document.getElementById('lightbox-img').src = url;
        }
        
        window.closeGallery = () => document.getElementById('gallery-modal').style.display='none';
        window.closeLightbox = () => document.getElementById('lightbox').style.display='none';

        window.startScratch = function(id, url) {
            currentScratchId = id;
            const modal = document.getElementById('scratch-modal');
            const img = document.getElementById('scratch-img-target');
            const cvs = document.getElementById('scratch-canvas');
            const ctx = cvs.getContext('2d');
        
            modal.style.display = 'flex';
            img.src = url;
        
            // 1. On pr√©pare la zone grise
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = '#b0b0b0'; 
            ctx.fillRect(0, 0, 300, 300);
            
            ctx.fillStyle = '#999';
            ctx.font = "30px Arial";
            ctx.fillText("?", 140, 150);
            ctx.fillText("?", 50, 50);
            ctx.fillText("?", 250, 250);
        
            // 2. Logique du doigt qui gratte
            let isDrawing = false;
            
            const getPos = (e) => {
                const rect = cvs.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
        
            const scratch = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                
                ctx.globalCompositeOperation = 'destination-out'; 
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 25, 0, Math.PI * 2);
                ctx.fill();
                
                checkWin();
            };
        
            cvs.onmousedown = cvs.ontouchstart = (e) => { isDrawing = true; scratch(e); };
            cvs.onmousemove = cvs.ontouchmove = scratch;
            cvs.onmouseup = cvs.ontouchend = () => { isDrawing = false; };
        
            // 3. V√©rification de la victoire
            function checkWin() {
                const imageData = ctx.getImageData(0, 0, 300, 300);
                let transparent = 0;
                for (let i = 3; i < imageData.data.length; i += 4) {
                    if (imageData.data[i] === 0) transparent++;
                }
                const percent = (transparent / (300 * 300)) * 100;
                
                // --- VICTOIRE (Plus de 50% gratt√©) ---
                if (percent > 50) { 
                    // A. Stop le grattage pour √©viter les bugs
                    cvs.onmousemove = null; cvs.ontouchmove = null;
                    
                    // B. Confettis
                    confetti({ particleCount: 100, spread: 70, zIndex: 10000 }); 
                    
                    // C. Sauvegarde Firebase
                    updateDoc(doc(db, "photos", currentScratchId), { scratched: true });
                    
                    // D. MISE √Ä JOUR IMM√âDIATE DE LA GALERIE (Le correctif est ici !)
                    const gridItem = document.getElementById(`photo-${currentScratchId}`);
                    if (gridItem) {
                        // 1. On enl√®ve le flou de l'image en arri√®re-plan
                        const imgEl = gridItem.querySelector('img');
                        if (imgEl) {
                            imgEl.style.filter = "none"; // L'image devient nette
                            // On change le clic : plus de grattage, ouverture directe
                            imgEl.onclick = () => showLightbox(url);
                        }
                        
                        // 2. On supprime l'ic√¥ne cadeau üéÅ qui flotte dessus
                        // On cherche la div qui contient le cadeau (position absolute)
                        const giftIcon = gridItem.querySelector('div[style*="absolute"]');
                        if (giftIcon) giftIcon.remove();
                    }
                    
                    // E. On ferme et on ouvre en grand
                    setTimeout(() => {
                        document.getElementById('scratch-modal').style.display = 'none';
                        showLightbox(img.src);
                    }, 800);
                }
            }
        }
        // --- GESTION PROJETS (Distance vs R√©el) ---

        let currentTodoTab = 'dist'; // 'dist' ou 'real'
        let currentTodoCat = 'visio'; // Cat√©gorie par d√©faut
        
        // CONFIGURATION DES CAT√âGORIES
        const todoConfig = {
            'dist': {
                label: "R√©alisations √† distance",
                cats: [
                    { id: 'visio', icon: 'üíª', color: '#a29bfe', name: 'Date Visio' },
                    { id: 'movie', icon: 'üçø', color: '#ff7675', name: 'Cin√© Sync' },
                    { id: 'game',  icon: 'üéÆ', color: '#74b9ff', name: 'Jeu' },
                    { id: 'call',  icon: 'üìû', color: '#55efc4', name: 'Appel' },
                    { id: 'gift',  icon: 'üì¶', color: '#ffeaa7', name: 'Colis' }
                ]
            },
            'real': {
                label: "R√™ves pour plus tard",
                cats: [
                    { id: 'travel', icon: '‚úàÔ∏è', color: '#a29bfe', name: 'Voyage' },
                    { id: 'food',   icon: 'üçî', color: '#fab1a0', name: 'Resto' },
                    { id: 'home',   icon: 'üè†', color: '#55efc4', name: 'Cocon' },
                    { id: 'date',   icon: '‚ù§Ô∏è', color: '#ff7675', name: 'Love' },
                    { id: 'money',  icon: 'üí∞', color: '#ffeaa7', name: 'Achat' }
                ]
            }
        };
        
        // 1. CHANGEMENT D'ONGLET
        window.switchTodoTab = function(tab) {
            currentTodoTab = tab;
            
            // UI Onglets
            document.getElementById('t-tab-dist').className = `todo-tab tab-dist ${tab==='dist'?'active':''}`;
            document.getElementById('t-tab-real').className = `todo-tab tab-real ${tab==='real'?'active':''}`;
            
            // UI Barre de progression (Couleur)
            const track = document.getElementById('prog-track');
            track.className = `book-progress-track ${tab==='dist'?'progress-dist':'progress-real'}`;
            document.getElementById('prog-label').innerText = todoConfig[tab].label;
        
            // G√©n√©ration des cat√©gories
            renderCategories();
            
            // Rafra√Æchissement de la liste (d√©clench√© par le snapshot mais on force le filtre visuel)
            renderTodoList();
        }
        
        // 2. AFFICHER LES CAT√âGORIES
        function renderCategories() {
            const container = document.getElementById('todo-cat-selector');
            container.innerHTML = "";
            
            const cats = todoConfig[currentTodoTab].cats;
            // On s√©lectionne la premi√®re par d√©faut quand on change d'onglet
            currentTodoCat = cats[0].id; 
            
            cats.forEach(c => {
                // On cr√©e le bouton
                const div = document.createElement('div');
                div.className = `cat-option ${c.id === currentTodoCat ? 'selected' : ''}`;
                div.style.setProperty('--c', c.color);
                div.innerText = c.icon;
                div.onclick = () => {
                    currentTodoCat = c.id;
                    // Visuel s√©lection
                    document.querySelectorAll('.cat-option').forEach(e => e.classList.remove('selected'));
                    div.classList.add('selected');
                };
                container.appendChild(div);
            });
        }
        
        // Initialisation au d√©marrage
        renderCategories();
        
        // 3. AJOUTER UN PROJET
        window.addTodo = function() {
            const t = document.getElementById('todo-input').value;
            if(!t) return;
            
            addDoc(collection(db, "todos"), {
                text: t,
                done: false,
                cat: currentTodoCat,
                tab: currentTodoTab, // On sauvegarde dans quel onglet c'est !
                created: serverTimestamp()
            });
            
            document.getElementById('todo-input').value = "";
            const icon = currentTodoTab === 'dist' ? 'wifi' : 'plane';
            sendNtfy("üìù Nouveau projet ! ("+getCurrentTime(currentUser)+")", icon, "low");
        }
        
        // 4. CHECK & CONFETTIS
        window.toggleTodo = function(id, state) { 
            updateDoc(doc(db, "todos", id), { done: state });
            if (state === true) {
                confetti({
                    particleCount: 50, spread: 60, origin: { y: 0.7 },
                    colors: currentTodoTab === 'dist' ? ['#74b9ff', '#55efc4'] : ['#ff7675', '#a29bfe']
                });
                if(navigator.vibrate) navigator.vibrate(100);
            }
        }
        
        // 5. LISTENER & AFFICHAGE
        let allTodos = []; // Stockage local pour filtrage
        
        onSnapshot(query(collection(db,"todos"), orderBy("created","desc")), s => { 
            allTodos = s.docs.map(d => ({id: d.id, ...d.data()}));
            renderTodoList();
        });
        
        function renderTodoList() {
            const l = document.getElementById('todo-list');
            l.innerHTML = ""; 
            
            // On ne garde que les items de l'onglet actif (ou ceux sans onglet -> 'real' par d√©faut)
            const filtered = allTodos.filter(t => (t.tab === currentTodoTab) || (!t.tab && currentTodoTab === 'real'));
            
            let total = 0;
            let doneCount = 0;
        
            filtered.forEach(t => {
                total++;
                if(t.done) doneCount++;
        
                // On retrouve la config de la cat√©gorie (couleur/icone)
                // On cherche dans les 2 configs au cas o√π
                let catConf = todoConfig['dist'].cats.find(c=>c.id===t.cat) || todoConfig['real'].cats.find(c=>c.id===t.cat);
                // Fallback si cat√©gorie inconnue
                if(!catConf) catConf = { color: '#ccc', icon: 'üìå' };
        
                l.innerHTML += `
                <div class="todo-item ${t.done?'done':''}" style="--cat-color:${catConf.color}">
                    <input type="checkbox" class="todo-check" ${t.done?'checked':''} onchange="toggleTodo('${t.id}', this.checked)">
                    
                    <div class="todo-content">
                        <span class="todo-text ${t.done?'done':''}">
                            <span class="todo-cat-icon">${catConf.icon}</span> ${t.text}
                        </span>
                    </div>
                    
                    <button onclick="deleteTodo('${t.id}')" class="todo-del">‚úï</button>
                </div>`;
            });
        
            // Mise √† jour Barre
            const percent = total === 0 ? 0 : Math.round((doneCount / total) * 100);
            document.getElementById('todo-progress-bar').style.width = percent + "%";
            document.getElementById('todo-percent').innerText = percent + "%";
            
            // Message vide
            if(total === 0) {
                l.innerHTML = `<div style="text-align:center; color:var(--text-sub); font-style:italic; padding:20px;">
                    ${currentTodoTab==='dist' ? "Rien de pr√©vu √† distance... üíª" : "Ajoute tes r√™ves ici ! ‚ú®"}
                </div>`;
            }
        }
        window.addBook=function(){const t=document.getElementById('book-title').value;if(!t)return;addDoc(collection(db,"books"),{title:t,pages_total:parseInt(document.getElementById('book-pages').value)||200,created:serverTimestamp(),page_fr:0,rating_fr:0,page_tw:0,rating_tw:0});document.getElementById('book-title').value="";}
        window.updatePage = function(id, role, val, max, title) { const newPage = parseInt(val); updateDoc(doc(db, "books", id), { ["page_"+role]: newPage }); if(newPage >= max) sendNtfy(`üéâ ${title} termin√© ! (${getCurrentTime(currentUser)})`, "tada", "low"); }
        window.rateBook = function(id, role, rating) { updateDoc(doc(db, "books", id), { ["rating_"+role]: rating }); }
        // Remplace tout le bloc onSnapshot des livres par celui-ci :
        onSnapshot(query(collection(db,"books"),orderBy("created","desc")), s => {
            const l = document.getElementById('book-list');
            l.innerHTML = "";
            
            s.forEach(docSnap => {
                const book = docSnap.data(); 
                const id = docSnap.id; 
                const totalPages = book.pages_total || 200;
                const frPage = book.page_fr || 0; const frRating = book.rating_fr || 0;
                const twPage = book.page_tw || 0; const twRating = book.rating_tw || 0;
                const frPercent = Math.min((frPage / totalPages) * 100, 100); 
                const twPercent = Math.min((twPage / totalPages) * 100, 100);
                
                // --- CORRECTIF ETOILES ---
                const makeStars = (role, currentRating) => {
                    let html = ''; 
                    // 1. Les 5 √©toiles
                    for(let i=1; i<=5; i++) { 
                        const filled = i <= currentRating ? 'filled' : ''; 
                        // Seul le propri√©taire du r√¥le peut cliquer
                        const action = role === currentUser ? `onclick="rateBook('${id}', '${role}', ${i})"` : ''; 
                        const cursor = role === currentUser ? 'pointer' : 'default'; 
                        html += `<span class="star ${filled}" style="cursor:${cursor}" ${action}>‚òÖ</span>`; 
                    }
                    
                    // 2. Le bouton Reset (√ò)
                    // ASTUCE : On l'affiche toujours, mais on le cache avec visibility:hidden si ce n'est pas moi.
                    // Cela garde l'espace occup√© (layout) identique pour les deux lignes.
                    const visibility = role === currentUser ? 'visible' : 'hidden';
                    
                    html += `<span class="star-reset" style="visibility:${visibility};" onclick="rateBook('${id}', '${role}', 0)">√ò</span>`; 
                    
                    return html;
                };
                // -------------------------
        
                const canEditFr = currentUser === 'fr' ? '' : 'disabled'; 
                const canEditTw = currentUser === 'tw' ? '' : 'disabled';
                
                l.innerHTML += `
                <div class="book-item">
                    <div class="book-title">
                        <span>${book.title}</span>
                        <button style="border:none;background:none;color:var(--text-sub);font-size:0.8rem;cursor:pointer;" onclick="deleteBook('${id}')">‚úï</button>
                    </div>
                    <div class="book-total-pages">${totalPages} pages</div>
                    
                    <div class="user-row">
                        <div class="row-header">
                            <span style="color:var(--blue);font-weight:bold;font-size:0.8rem;">TH√âO</span>
                            <div class="star-rating">${makeStars('fr', frRating)}</div>
                        </div>
                        <div class="user-inputs">
                            <input type="number" class="page-input" value="${frPage}" ${canEditFr} onchange="updatePage('${id}', 'fr', this.value, ${totalPages}, '${book.title}')" placeholder="0">
                            <div class="book-progress-track"><div class="book-progress-bar" style="width:${frPercent}%; background:var(--blue);"></div></div>
                        </div>
                    </div>
                    
                    <div class="user-row" style="border:none;">
                        <div class="row-header">
                            <span style="color:var(--pink);font-weight:bold;font-size:0.8rem;">ELISE</span>
                            <div class="star-rating">${makeStars('tw', twRating)}</div>
                        </div>
                        <div class="user-inputs">
                            <input type="number" class="page-input" value="${twPage}" ${canEditTw} onchange="updatePage('${id}', 'tw', this.value, ${totalPages}, '${book.title}')" placeholder="0">
                            <div class="book-progress-track"><div class="book-progress-bar" style="width:${twPercent}%; background:var(--pink);"></div></div>
                        </div>
                    </div>
                </div>`;
            });
        });

        // NOTIF BISOUS RE√áU
        onSnapshot(query(collection(db,"actions"),orderBy("timestamp","desc"),limit(1)),s=>{
            if(!s.empty){const a=s.docs[0].data(); if(a.from!==currentUser && Math.abs(Date.now()-a.timestamp.toMillis())<60000){
                document.getElementById("notif").innerHTML=`üíã <b>${a.from==='fr'?'Th√©o':'Elise'}</b> t'envoie un bisou !`;
                document.getElementById("notif").classList.add("show"); if(navigator.vibrate)navigator.vibrate(200);
                setTimeout(()=>document.getElementById("notif").classList.remove("show"),4000);
            }}
        });
        
        function updateClocks(){
            const now=new Date();
            document.getElementById('clock-fr').innerText=now.toLocaleTimeString('fr-FR',{timeZone:'Europe/Paris',hour:'2-digit',minute:'2-digit'});
            document.getElementById('clock-tw').innerText=now.toLocaleTimeString('fr-FR',{timeZone:'Asia/Taipei',hour:'2-digit',minute:'2-digit'});
        } setInterval(updateClocks,1000); updateClocks();

    </script>
</body>
</html>
