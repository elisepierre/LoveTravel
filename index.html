<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Love Travel">
    <meta name="theme-color" content="#fff0f3">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.jpg">
    <link rel="icon" type="image/jpeg" href="icon.jpg">

    <title>Love Travel ‚úàÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Pacifico&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --pink: #ff9eb5; --pink-dark: #ff4b6e;
            --blue: #8ecae6; --blue-dark: #219ebc;
            --bg-body: #fffbf0; --bg-card: #ffffff;
            --text-main: #4a4a4a; --text-sub: #888888;
            --border: #eeeeee; --input-bg: #fafafa;
            --shadow: rgba(0,0,0,0.05); --dot-pattern: #ffe4e1;
            --voyage-border: linear-gradient(135deg, var(--blue), var(--pink));
            --p-shadow: rgba(0,0,0,0.2);
        }
        body.dark-mode {
            --bg-body: #121212; --bg-card: #1e1e1e;
            --text-main: #e0e0e0; --text-sub: #aaaaaa;
            --border: #333333; --input-bg: #2c2c2c;
            --shadow: rgba(0,0,0,0.5); --dot-pattern: rgba(255,255,255,0.05);
            --p-shadow: rgba(0,0,0,0.5);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background-color: var(--bg-body); background-image: radial-gradient(var(--dot-pattern) 1px, transparent 1px); background-size: 20px 20px; color: var(--text-main); padding-bottom: 120px; transition: background 0.3s, color 0.3s; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 10px 20px; margin-bottom: 10px; }
        .header-btn { background: var(--bg-card); border: 1px solid var(--border); width: 45px; height: 45px; border-radius: 50%; color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; cursor: pointer; box-shadow: 0 4px 10px var(--shadow); transition: 0.2s; }
        .app-title { font-family: 'Pacifico', cursive; font-size: 2.2rem; margin: 0; background: linear-gradient(to right, var(--blue-dark), var(--pink-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 0px rgba(255,255,255,0.2)); padding: 0 10px; line-height: 1.3; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        
        .card { background: var(--bg-card); border-radius: 25px; padding: 25px; margin-bottom: 20px; box-shadow: 0 10px 25px var(--shadow); border: 1px solid var(--border); transition: 0.3s; overflow: hidden; }
        .card.voyage-card { padding: 25px 20px; }
        
        .card-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px dashed var(--border); padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between; gap: 10px; cursor: pointer; user-select: none; }
        .card-title.toggleable::after { content: '‚ñº'; font-size: 0.8rem; color: var(--text-sub); transition: transform 0.3s ease; }
        .card-title.closed::after { transform: rotate(-90deg); }
        .card-title.closed { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }

        /* VOYAGE */
        .journey-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .journey-col { text-align: center; flex: 1; }
        .place-name { display: block; font-size: 0.7rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: var(--text-sub); margin-bottom: 5px; }
        .place-time { display: block; font-size: 1.6rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .place-weather { font-size: 0.8rem; color: var(--text-sub); margin-top: 5px; display: block; }
        .journey-visual { flex: 1; text-align: center; position: relative; padding: 0 10px; }
        .path-line { border-top: 2px dashed var(--text-sub); opacity: 0.3; width: 100%; position: relative; top: -10px; }
        .plane-icon { font-size: 1.5rem; position: relative; top: -24px; color: var(--text-main); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }

        /* INDICATEUR ONLINE */
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-right: 5px; transition:0.3s; vertical-align: middle; }
        .status-dot.online { background: #2ecc71 !important; box-shadow: 0 0 10px #2ecc71; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        /* COMPTEUR */
        .countdown-compact { background: var(--input-bg); border-radius: 15px; padding: 15px; text-align: center; border: 1px solid var(--border); }
        .compact-title { font-size: 0.75rem; color: var(--text-sub); font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 5px; }
        .compact-counter { display: flex; align-items: baseline; justify-content: center; gap: 8px; color: var(--text-main); }
        .big-num { font-size: 2.2rem; font-weight: 800; color: var(--pink-dark); line-height: 1; }
        .unit { font-size: 1rem; font-weight: bold; color: var(--pink-dark); text-transform: uppercase; }
        .small-time { font-size: 1rem; font-weight: 600; color: var(--text-main); }
        .progress-container-modern { margin-top: 15px; position: relative; }
        .dates-row { display: flex; justify-content: space-between; font-size: 0.7rem; font-weight: bold; color: var(--text-sub); margin-bottom: 5px; }
        .prog-bar-mini { height: 8px; background: var(--border); border-radius: 10px; position: relative; width: 100%; }
        .prog-fill-mini { height: 100%; background: linear-gradient(90deg, var(--blue), var(--pink)); border-radius: 10px; width: 0%; transition: width 1s ease; }
        .prog-heart { position: absolute; top: -6px; font-size: 14px; transform: translateX(-50%); transition: left 1s ease; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }

        /* MOODS */
        .mood-container { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        .mood-person { width: 48%; text-align: center; position: relative; }
        .avatar-frame { width: 100%; height: 140px; display: flex; align-items: flex-end; justify-content: center; position: relative; border-bottom: 1px solid var(--border); }
        .avatar-img { height: 95%; width: auto; max-width: 100%; object-fit: contain; }
        .mood-msg { background: var(--bg-card); padding: 8px 12px; border-radius: 15px; font-size: 0.8rem; color: var(--text-main); box-shadow: 0 3px 10px var(--shadow); margin-top: -10px; position: relative; z-index: 2; display: inline-block; max-width: 100%; font-style: italic; border: 1px solid var(--border); }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .mood-btn { background: var(--input-bg); border: 1px solid var(--border); border-radius: 15px; padding: 10px; text-align: center; font-size: 1.5rem; cursor: pointer; transition: 0.2s; }
        .mood-btn:active { transform: scale(0.95); }

        /* ELEMENTS COMMUNS */
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-field { flex: 1; min-width: 120px; padding: 12px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Outfit'; outline: none; background: var(--input-bg); color: var(--text-main); }
        .btn-action { background: var(--blue-dark); color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: bold; cursor: pointer; height: 45px; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; background: var(--text-sub); }
        
        /* QUESTIONS DU JOUR */
        .question-box { background: var(--input-bg); border: 1px solid var(--border); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 15px; }
        .q-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; color:var(--text-sub); font-size:0.8rem; }
        .q-nav { cursor:pointer; font-size:1.2rem; padding:0 10px; user-select: none;}
        .q-nav.disabled { opacity:0.3; cursor:default; }
        .q-text { font-size: 1.1rem; font-weight: bold; color: var(--text-main); margin-bottom: 15px; font-family: 'Dancing Script', cursive; }
        .q-answers { display: flex; flex-direction: column; gap: 10px; text-align: left; }
        .q-bubble { padding: 10px; border-radius: 10px; font-size: 0.9rem; position: relative; }
        .q-blur { filter: blur(5px); user-select: none; opacity: 0.5; cursor: not-allowed; }
        .q-fr { background: #e3f2fd; color: #333; border: 1px solid var(--blue); align-self: flex-start; max-width: 90%; }
        .q-tw { background: #fff0f5; color: #333; border: 1px solid var(--pink); align-self: flex-end; max-width: 90%; }
        .q-actions { display: flex; gap: 5px; justify-content: flex-end; margin-top: 5px; }
        .q-action-btn { font-size: 0.7rem; border: none; background: none; cursor: pointer; text-decoration: underline; color: #555; }

        /* JEUX */
        .game-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .game-btn { 
            flex: 1; padding: 12px; border-radius: 15px; border: 1px solid var(--border); 
            background: var(--bg-card); color: var(--text-main); font-weight: bold; cursor: pointer; 
            transition: 0.2s; text-align: center; font-size: 0.9rem;
            box-shadow: 0 4px 5px rgba(0,0,0,0.05);
        }
        .game-btn:active { transform:scale(0.95); }
        .game-btn.active-game { border: 2px solid var(--pink-dark); background: #fff0f5; color: var(--pink-dark); }
        .stop-btn { color:#ff4b6e; border-color:#ff4b6e; background: #fff0f5; }

        .game-block { display: none; background: var(--input-bg); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 20px; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }
        .game-title-text { font-weight: 800; text-transform: uppercase; color: var(--text-main); display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .game-close-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-sub); }
        
        .score-pill { background: var(--bg-card); border: 1px solid var(--border); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; color: var(--pink-dark); }
        .status-msg { text-align: center; font-style: italic; color: var(--text-sub); margin: 10px 0; font-size: 0.9rem; min-height: 20px; }

        .history-box { margin-top: 15px; max-height: 100px; overflow-y: auto; font-size: 0.75rem; border-top: 1px solid var(--border); padding-top: 10px; }
        .hist-row { display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--text-sub); }
        .hist-win { color: #2ecc71; font-weight: bold; }
        .hist-loose { color: #e74c3c; font-weight: bold; }

        #pendu-canvas { display: block; margin: 0 auto; border-bottom: 2px solid var(--text-main); margin-bottom: 10px; width: 200px; height: 150px; }
        .pendu-word { font-size: 1.5rem; letter-spacing: 5px; font-weight: bold; margin: 15px 0; color: var(--text-main); text-align: center; }
        .keyboard { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
        .key-btn { width: 30px; height: 35px; border: 1px solid var(--border); border-radius: 5px; background: white; cursor: pointer; font-weight: bold; color: #333; }
        .key-btn:disabled { opacity: 0.3; background: #ddd; }
        
        .p4-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; background: #34495e; padding: 10px; border-radius: 10px; max-width: 300px; margin: 0 auto; }
        .p4-cell { aspect-ratio: 1/1; background: var(--bg-body); border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.1); transition: 0.2s; }
        .p4-cell.p1 { background: var(--blue); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        .p4-cell.p2 { background: var(--pink); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }

        /* LETTRES */
        .mailbox-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .mailbox-tab { flex: 1; padding: 10px; text-align: center; border-radius: 12px; font-size: 0.8rem; font-weight: bold; cursor: pointer; opacity: 0.5; transition: 0.3s; color: var(--text-main); border: 1px solid var(--border); }
        .mailbox-tab.active { opacity: 1; color: white; border: none; box-shadow: 0 4px 10px var(--shadow); }
        .envelope-item { background: var(--input-bg); border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; align-items: center; cursor: pointer; transition: 0.3s; border-left: 5px solid #ccc; margin-bottom: 10px; }
        .envelope-item.unread { border-left-color: var(--pink-dark); background: rgba(255, 75, 110, 0.1); }
        #letter-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .real-letter { background: #fffdf0; width: 100%; max-width: 400px; max-height: 80vh; display: flex; flex-direction: column; padding: 30px; border-radius: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; background-image: radial-gradient(#e0e0e0 1px, transparent 1px); background-size: 20px 20px; transform: rotate(-1deg); }
        .real-letter h2 { font-family: 'Pacifico', cursive; margin-top: 0; color: var(--pink-dark); margin-right: 30px; flex-shrink: 0; }
        #modal-letter-content { font-family: 'Dancing Script', cursive; font-size: 1.6rem; line-height: 1.6; color: #333; white-space: pre-wrap; overflow-y: auto; flex: 1; padding-right: 10px; margin-bottom: 20px; }
        .letter-close { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; color: #aaa; background: none; border: none; cursor: pointer; z-index: 10; }
        .letter-stamp { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; border: 2px double #d4af37; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #d4af37; font-size: 0.7rem; font-weight: bold; transform: rotate(-15deg); opacity: 0.7; text-align: center; pointer-events: none; }

        /* GALERIE */
        .polaroid-container { display: flex; justify-content: space-around; }
        .polaroid { background: white; padding: 10px 10px 30px 10px; position: relative; box-shadow: 0 5px 15px var(--p-shadow); transform: rotate(-2deg); width: 45%; text-align: center; cursor: pointer; transition: 0.3s; border-radius:0; }
        .polaroid:nth-child(2) { transform: rotate(3deg); }
        .polaroid:active { transform: scale(1.05) rotate(0deg); z-index: 10; }
        .polaroid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; margin-bottom: 5px; }
        .polaroid-label { font-family: 'Dancing Script', cursive; font-size: 1.2rem; color: #555; }
        .add-photo-btn { display: none; margin-top: 5px; font-size: 0.7rem; color: #888; border: 1px dashed #ccc; padding: 5px; border-radius: 5px; }
        .photo-date { font-size: 0.7rem; color: #888; margin-top: 5px; display: block; text-align: center; font-weight: bold; }

        /* MODAL GALERIE */
        #gallery-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; padding: 20px; overflow-y:auto; }
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 7000; justify-content: center; align-items: center; padding: 0; }
        #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-header { display: flex; justify-content: space-between; color: white; margin-bottom: 20px; align-items: center; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .modal-img { width: 100%; border-radius: 5px; cursor: zoom-in; transition: 0.2s; }
        .modal-img:hover { opacity: 0.8; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 2rem; background: none; border: none; cursor: pointer; }

        /* PROJETS & LIVRES */
        .todo-item { display: flex; align-items: center; background: var(--input-bg); padding: 10px; margin-bottom: 8px; border-radius: 10px; border: 1px solid var(--border); justify-content: space-between; }
        .todo-check { width: 20px; height: 20px; margin-right: 10px; accent-color: var(--pink-dark); }
        .todo-text { flex: 1; font-size: 0.9rem; margin-right: 10px; color: var(--text-main); }
        .todo-text.done { text-decoration: line-through; color: var(--text-sub); }
        .todo-del { background: none; border: none; color: #faa; cursor: pointer; font-size: 1.2rem; margin-left: auto; }
        .book-item { background: var(--input-bg); padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border); }
        .book-title { font-weight: 800; font-size: 1rem; color: var(--text-main); margin-bottom: 5px; display:flex; justify-content:space-between; }
        .book-total-pages { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 10px; font-weight: 500; }
        .user-row { display: flex; flex-direction: column; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 10px; }
        .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .user-inputs { display: flex; align-items: center; gap: 10px; width: 100%; }
        .page-input { width: 50px; padding: 4px; border-radius: 6px; border: 1px solid var(--border); text-align: center; font-weight: bold; font-size: 0.9rem; background: var(--bg-card); color: var(--text-main); }
        .star-rating { display: flex; gap: 1px; }
        .star { cursor: pointer; font-size: 1.1rem; color: #ddd; transition: 0.2s; }
        .star.filled { color: #ffb84d; }
        .star-reset { font-size: 0.7rem; color: var(--text-sub); cursor: pointer; margin-left: 5px; padding: 2px;}
        .book-progress-track { flex: 1; height: 6px; background: var(--border); border-radius: 4px; overflow: hidden; margin-left: 10px; }
        .book-progress-bar { height: 100%; width: 0%; transition: width 0.5s ease; border-radius: 4px; }

        /* FOOTER & UTILS */
        .app-footer { text-align: center; padding: 20px; margin-top: 30px; opacity: 0.8; }
        .footer-logo { width: 50px; height: 50px; border-radius: 50%; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* FAB */
        #bisou-btn { position: fixed; bottom: 30px; right: 25px; width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--pink), var(--pink-dark)); color: white; border: none; font-size: 30px; box-shadow: 0 10px 25px rgba(255, 75, 110, 0.4); cursor: pointer; z-index: 1000; animation: pulse 3s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0.6); } 70% { box-shadow: 0 0 0 15px rgba(255, 75, 110, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 110, 0); } }
        #notif { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 10px 20px; border-radius: 30px; z-index: 9999; transition: 0.3s; display:flex; align-items:center; gap:10px; }
        #notif.show { transform: translateX(-50%) translateY(0); }
        .hidden { display: none; }
        .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ccc; margin-right: 6px; }
        .status-dot.online { background: #2ecc71; box-shadow: 0 0 8px #2ecc71; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="notif">üíã Bisou re√ßu !</div>

    <div id="letter-modal" style="display:none;"><div class="real-letter"><button class="letter-close" onclick="closeLetter()">‚úï</button><h2 id="modal-letter-title"></h2><p id="modal-letter-content"></p><div class="letter-stamp">POSTE<br>AMOUR</div></div></div>
    <div id="gallery-modal"><div class="modal-header"><h2 style="color:white;font-family:'Outfit'">Galerie</h2><button onclick="closeGallery()" style="background:none;border:none;color:white;font-size:2rem;">‚úï</button></div><div class="modal-grid" id="modal-grid"></div></div>
    <div id="lightbox" onclick="closeLightbox()"><button class="lightbox-close">‚úï</button><img id="lightbox-img" src=""></div>

    <header>
        <button class="header-btn" id="user-toggle-btn" onclick="switchUser()">üáπüáº</button>
        <h1 class="app-title">Love Travel</h1>
        <button class="header-btn" onclick="toggleTheme()">üåó</button>
    </header>

    <div class="container">

        <div class="card voyage-card" id="card-voyage">
            <div class="card-content">
                <div class="journey-row">
                    <div class="journey-col"><span class="place-name"><span id="dot-fr" class="status-dot"></span> France</span><span class="place-time" id="clock-fr">--:--</span><span class="place-weather" id="weather-fr">--¬∞C</span></div>
                    <div class="journey-visual"><div class="plane-icon">‚úàÔ∏è</div><div class="path-line"></div></div>
                    <div class="journey-col"><span class="place-name"><span id="dot-tw" class="status-dot"></span> Ta√Øwan</span><span class="place-time" id="clock-tw">--:--</span><span class="place-weather" id="weather-tw">--¬∞C</span></div>
                </div>
                <div class="countdown-compact">
                    <div id="countdown-title" class="compact-title">D√âPART DANS</div>
                    <div class="compact-counter"><span id="days-count" class="big-num">--</span> <span class="unit" id="days-unit">JOURS</span><span class="separator">‚Ä¢</span><span id="sub-count" class="small-time">-- h et -- min</span></div>
                    <div class="progress-container-modern"><div class="dates-row"><span>14 F√©v</span><span>05 Juil</span></div><div class="prog-bar-mini"><div class="prog-fill-mini" id="prog-fill"></div><div class="prog-heart" id="prog-heart">ü©∑</div></div></div>
                </div>
            </div>
        </div>

        <div class="card" id="card-music">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üéß</span> Vibe</div></div>
            <div class="card-content">
                <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M?utm_source=generator&theme=0" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
            </div>
        </div>

        <div class="card" id="card-mood">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>‚òÅÔ∏è</span> Nos Moods</div></div>
            <div class="card-content">
                <div class="mood-container">
                    <div class="mood-person"><div class="avatar-frame"><img src="" id="mood-img-fr" class="avatar-img"></div><div class="mood-msg" id="mood-msg-fr">...</div></div>
                    <div class="mood-person"><div class="avatar-frame"><img src="" id="mood-img-tw" class="avatar-img"></div><div class="mood-msg" id="mood-msg-tw">...</div></div>
                </div>
                <div class="mood-grid">
                    <div class="mood-btn" onclick="updateMood('ü•∞', 'Tu me manques !', 0)">ü•∞</div>
                    <div class="mood-btn" onclick="updateMood('ü§ì', 'Je suis en cours', 1)">ü§ì</div>
                    <div class="mood-btn" onclick="updateMood('üò¥', 'Zzz Zzz', 2)">üò¥</div>
                    <div class="mood-btn" onclick="updateMood('üòã', 'Je mange, miam !', 3)">üòã</div>
                    <div class="mood-btn" onclick="updateMood('ü•µ', 'Envie de toi...', 4)">ü•µ</div>
                    <div class="mood-btn" onclick="customMood()" style="color:var(--pink);">‚úèÔ∏è</div>
                </div>
            </div>
        </div>

        <div class="card" id="card-question">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üí¨</span> Question du Jour</div></div>
            <div class="card-content">
                <div class="question-box">
                    <div class="q-header"><span class="q-nav" id="q-nav-prev" onclick="changeQDate(-1)">‚Üê</span><span id="q-date-label">Aujourd'hui</span><span class="q-nav" id="q-nav-next" onclick="changeQDate(1)">‚Üí</span></div>
                    <div class="q-text" id="q-text">Chargement...</div>
                    <div class="q-answers" id="q-answers-area"></div>
                </div>
                <div class="input-group" id="q-input-group"><input type="text" id="q-input" class="input-field" placeholder="Ta r√©ponse..."><button onclick="sendAnswer()" class="btn-action">Envoyer</button></div>
            </div>
        </div>

        <div class="card" id="card-letter">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üíå</span> Bo√Æte aux Lettres</div></div>
            <div class="card-content">
                <div class="mailbox-tabs"><div class="mailbox-tab active" id="tab-inbox" style="background:var(--pink);color:white;" onclick="showTab('inbox')">Re√ßus</div><div class="mailbox-tab" id="tab-sent" style="background:transparent;color:var(--text-main);" onclick="showTab('sent')">Envoy√©s</div></div>
                <div class="input-group"><input type="text" id="letter-title" class="input-field" placeholder="Ouvrir quand..."><button onclick="addLetter()" class="btn-action" style="background:var(--pink-dark)">+</button></div>
                <textarea id="letter-content" class="input-field" placeholder="Ecris ta lettre ici..." style="width:100%;height:80px;resize:none;margin-bottom:15px;"></textarea>
                <div id="list-inbox" class="letter-list"></div><div id="list-sent" class="letter-list hidden"></div>
            </div>
        </div>

        <div class="card" id="card-album">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üì∏</span> Nos Albums</div></div>
            <div class="card-content">
                <div class="polaroid-container">
                    <div class="polaroid" onclick="openGallery('fr')"><img id="polaroid-img-fr" class="polaroid-img"><div class="polaroid-label">Th√©o</div><div id="btn-add-fr" class="add-photo-btn" onclick="event.stopPropagation();document.getElementById('file-fr').click()">+ Ajouter photo</div><input type="file" id="file-fr" accept="image/*" onchange="handlePhotoUpload(this,'fr')" style="display:none;"></div>
                    <div class="polaroid" onclick="openGallery('tw')"><img id="polaroid-img-tw" class="polaroid-img"><div class="polaroid-label">Elise</div><div id="btn-add-tw" class="add-photo-btn" onclick="event.stopPropagation();document.getElementById('file-tw').click()">+ Ajouter photo</div><input type="file" id="file-tw" accept="image/*" onchange="handlePhotoUpload(this,'tw')" style="display:none;"></div>
                </div>
            </div>
        </div>

        <div class="card" id="card-todo">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üìù</span> Nos Projets</div></div>
            <div class="card-content"><div class="input-group"><input type="text" id="todo-input" class="input-field" placeholder="Manger une raclette..."><button onclick="addTodo()" class="btn-action">OK</button></div><div id="todo-list"></div></div>
        </div>

        <div class="card" id="card-books">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üìö</span> Lectures Communes</div></div>
            <div class="card-content"><div class="input-group"><input type="text" id="book-title" class="input-field" placeholder="Titre..."><input type="number" id="book-pages" class="input-field" style="width:80px;" placeholder="Total P."><button onclick="addBook()" class="btn-action">+</button></div><div id="book-list"></div></div>
        </div>

        <div class="card" id="card-games">
            <div class="card-title toggleable" onclick="toggleCard(this)"><div style="display:flex; align-items:center; gap:10px;"><span>üéÆ</span> Salle de Jeux</div></div>
            <div class="card-content">
                
                <div class="game-selector">
                    <button onclick="toggleGame('pendu')" class="game-btn">Pendu</button>
                    <button onclick="toggleGame('p4')" class="game-btn">Puissance 4</button>
                    <button onclick="initGame('none')" class="game-btn stop-btn">Arr√™ter</button>
                </div>
                
                <div id="pendu-box" class="game-block">
                    <div class="game-header">
                        <div class="game-title-text">üî§ Pendu</div>
                        <button class="game-close-btn" onclick="toggleGame('pendu')">‚úï</button>
                    </div>
                    
                    <canvas id="pendu-canvas" width="200" height="150"></canvas>
                    <div id="pendu-word-display" class="pendu-word">_ _ _ _ _</div>
                    <div id="pendu-status" class="status-msg">En attente...</div>
                    <div id="pendu-setup" style="margin-top:10px;">
                        <input type="text" id="pendu-secret" class="input-field" placeholder="Mot secret (sans accent)">
                        <button onclick="startPendu()" class="btn-action" style="width:100%;margin-top:5px;">Lancer</button>
                    </div>
                    <div id="pendu-restart-area" style="display:none;margin-top:10px;">
                        <button onclick="startPenduSetup()" class="btn-action" style="background:var(--blue-dark);width:100%;">Rejouer</button>
                    </div>
                    <div id="pendu-keyboard" class="keyboard" style="display:none;"></div>
                    <div class="history-box" id="pendu-history-list"></div>
                </div>

                <div id="p4-box" class="game-block">
                    <div class="game-header">
                        <div class="game-title-text">üî¥ Puissance 4</div>
                        <div class="score-pill" id="score-p4">üèÜ Th√©o: 0 | Elise: 0</div>
                        <button class="game-close-btn" onclick="toggleGame('p4')">‚úï</button>
                    </div>
                    <div id="p4-status" class="status-msg">En attente...</div>
                    <button id="p4-restart-btn" onclick="initP4()" class="btn-action" style="width:100%;margin-bottom:10px;background:var(--pink);" disabled>Nouvelle Partie</button>
                    <div class="p4-grid" id="p4-grid"></div>
                    <div class="history-box" id="p4-history-list"></div>
                </div>

            </div>
        </div>

        <div class="app-footer"><img src="icon.jpg" class="footer-logo"><div style="font-size:0.7rem;color:var(--text-sub);margin-top:5px;">Love Travel v45 ‚Ä¢ janvier 2026</div></div>
    </div>

    <button id="bisou-btn" onclick="sendBisou()">üíã</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, orderBy, limit, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA7ZNlC1ILS9-W3bgxWogUA6ak4c29a4Ns", authDomain: "lovetravel-35285.firebaseapp.com", projectId: "lovetravel-35285", storageBucket: "lovetravel-35285.firebasestorage.app", messagingSenderId: "189902268760", appId: "1:189902268760:web:b461ce15d8c396be479d2d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = localStorage.getItem('userRole') || 'tw';
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        window.toggleTheme = function() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); }
        window.switchUser = function() { currentUser = (currentUser === 'tw') ? 'fr' : 'tw'; localStorage.setItem('userRole', currentUser); alert(currentUser==='fr'?"Th√©o üá´üá∑":"Elise üáπüáº"); updateIdentityUI(); updateMailboxView(); }
        function updateIdentityUI() { 
            document.getElementById('user-toggle-btn').innerText = currentUser === 'tw' ? 'üáπüáº' : 'üá´üá∑';
            document.getElementById('btn-add-fr').style.display = currentUser === 'fr' ? 'block' : 'none';
            document.getElementById('btn-add-tw').style.display = currentUser === 'tw' ? 'block' : 'none';
        }
        updateIdentityUI();

        window.toggleCard = function(header) {
            if(header.parentElement.id === 'card-voyage') return;
            const content = header.nextElementSibling;
            const isClosed = content.style.display === "none";
            content.style.display = isClosed ? "block" : "none";
            header.classList.toggle("closed", !isClosed);
            localStorage.setItem('card_' + header.parentElement.id, isClosed ? 'open' : 'closed');
        }
        document.querySelectorAll('.card[id]').forEach(c => { if(c.id!=='card-voyage' && localStorage.getItem('card_'+c.id)==='closed') { c.querySelector('.card-content').style.display='none'; c.querySelector('.card-title').classList.add('closed'); }});

        // REPARATION BOUTONS
        window.deleteTodo = function(id) { deleteDoc(doc(db,"todos",id)); }
        window.deleteBook = function(id) { if(confirm("Supprimer ?")) deleteDoc(doc(db,"books",id)); }
        window.deletePhoto = async function(id) { 
            if(confirm("Supprimer ?")) {
                const el = document.getElementById(`photo-${id}`);
                if(el) el.remove(); 
                await deleteDoc(doc(db,"photos",id));
            }
        }
        window.deleteLetter = function(id, e) { e.stopPropagation(); if(confirm("Supprimer ?")) deleteDoc(doc(db,"letters",id)); }

        // --- QUESTION DU JOUR ---
        const questionsList = ["Quel est ton meilleur souvenir de nous ?", "Quelle qualit√© pr√©f√®res-tu chez moi ?", "O√π veux-tu qu'on aille manger en premier ?", "Quelle chanson te fait penser √† moi ?", "D√©cris notre relation en 3 mots.", "Quel est ton r√™ve pour nous ?", "Si on pouvait partir demain, on irait o√π ?", "Qu'est-ce qui te manque le plus ?", "Raconte notre premi√®re rencontre vue par toi."]; 
        const baseQuestions = [ "Quel est ton meilleur souvenir de nous ?", "Quelle qualit√© pr√©f√®res-tu chez moi ?", "O√π veux-tu qu'on aille manger en premier ?", "Quelle chanson te fait penser √† moi ?", "D√©cris notre relation en 3 mots.", "Quel est ton r√™ve pour nous ?", "Si on pouvait partir demain, on irait o√π ?", "Qu'est-ce qui te manque le plus ?", "Raconte notre premi√®re rencontre vue par toi." ]; 
        function getFrenchDate() { return new Date(new Date().toLocaleString("en-US", {timeZone: "Europe/Paris"})); }
        let currentQDate = getFrenchDate();

        function updateQuestionView() {
            const today = getFrenchDate();
            if (currentQDate > today) currentQDate = today;
            
            const y = currentQDate.getFullYear(); const m = String(currentQDate.getMonth() + 1).padStart(2, '0'); const d = String(currentQDate.getDate()).padStart(2, '0');
            const dateKey = `${y}-${m}-${d}`; const todayStr = today.toISOString().split('T')[0];
            const start = new Date("2026-02-14").getTime(); const qTime = currentQDate.getTime(); const diffDays = Math.floor((qTime - start) / (1000 * 60 * 60 * 24));
            
            document.getElementById('q-date-label').innerText = (dateKey === todayStr) ? "Aujourd'hui (France)" : currentQDate.toLocaleDateString();
            document.getElementById('q-nav-next').classList.toggle('disabled', dateKey >= todayStr);
            document.getElementById('q-nav-next').onclick = (dateKey >= todayStr) ? null : () => changeQDate(1);

            let qIndex = diffDays; if(qIndex < 0) qIndex = 0; 
            document.getElementById('q-text').innerText = baseQuestions[Math.abs(qIndex) % baseQuestions.length] || "Question surprise";

            onSnapshot(doc(db, "daily_answers", dateKey), (docSnap) => {
                const data = docSnap.exists() ? docSnap.data() : {};
                const frAns = data.fr || ""; const twAns = data.tw || "";
                const area = document.getElementById('q-answers-area'); area.innerHTML = "";
                const bothAnswered = frAns && twAns;
                const myAnswer = (currentUser === 'fr' ? frAns : twAns);

                const makeBubble = (user, txt, role) => {
                    const isMe = currentUser === role;
                    const blurClass = (!isMe && !bothAnswered) ? "q-blur" : "";
                    const content = (!isMe && !bothAnswered) ? "R√©ponse cach√©e..." : txt;
                    let actions = "";
                    if(isMe && dateKey === todayStr) actions = `<div class="q-actions"><button class="q-action-btn" onclick="editQ('${dateKey}')">Modif</button><button class="q-action-btn" onclick="deleteQ('${dateKey}')">Supp</button></div>`;
                    return `<div class="q-bubble q-${role} ${blurClass}"><b>${user}:</b> ${content} ${actions}</div>`;
                };
                if(frAns) area.innerHTML += makeBubble("Th√©o", frAns, 'fr');
                if(twAns) area.innerHTML += makeBubble("Elise", twAns, 'tw');
                if(dateKey === todayStr && !myAnswer) document.getElementById('q-input-group').style.display = 'flex'; else document.getElementById('q-input-group').style.display = 'none';
                if(!frAns && !twAns) area.innerHTML = "<div style='text-align:center;font-style:italic;font-size:0.8rem;color:#aaa'>Aucune r√©ponse.</div>";
            });
        }
        window.changeQDate = function(offset) { currentQDate.setDate(currentQDate.getDate() + offset); updateQuestionView(); }
        updateQuestionView();
        window.sendAnswer = function() { const txt = document.getElementById('q-input').value; if(!txt) return; const y = currentQDate.getFullYear(); const m = String(currentQDate.getMonth() + 1).padStart(2, '0'); const d = String(currentQDate.getDate()).padStart(2, '0'); const key = `${y}-${m}-${d}`; setDoc(doc(db, "daily_answers", key), { [currentUser]: txt }, { merge: true }); document.getElementById('q-input').value = ""; sendNtfy(`üí¨ R√©ponse √† la question ! (${getCurrentTime(currentUser)})`, "speech_balloon", "low"); }
        window.deleteQ = function(key) { updateDoc(doc(db, "daily_answers", key), { [currentUser]: "" }); }
        window.editQ = function(key) { getDoc(doc(db, "daily_answers", key)).then(snap => { if(snap.exists()) { document.getElementById('q-input').value = snap.data()[currentUser]; deleteQ(key); } }); }

        // --- JEUX ---
        window.toggleGame = function(game) {
            const el = document.getElementById(game + '-box');
            if (el.style.display === 'block') el.style.display = 'none';
            else el.style.display = 'block';
        }

        // PENDU
        let activePendu = null;
        onSnapshot(doc(db, "games", "pendu_active"), (s) => { activePendu = s.exists() ? s.data() : { state:'setup' }; renderPendu(activePendu); });
        
        onSnapshot(query(collection(db, "games_pendu_history"), orderBy("timestamp", "desc"), limit(5)), (s) => {
            const list = document.getElementById('pendu-history-list'); list.innerHTML = "";
            s.forEach(d => {
                const h = d.data();
                const resClass = h.result === 'win' ? 'hist-win' : 'hist-loose';
                const setter = h.setter === 'fr' ? 'Th√©o' : 'Elise';
                list.innerHTML += `<div class="hist-row"><span>${setter} : <b>${h.word}</b></span><span class="${resClass}">${h.result==='win'?'Trouv√©':'Rat√©'}</span></div>`;
            });
        });

        function renderPendu(game) {
            const ctx=document.getElementById('pendu-canvas').getContext('2d'); const status = document.getElementById('pendu-status');
            const mainColor = getComputedStyle(document.body).getPropertyValue('--blue-dark');
            const pinkColor = getComputedStyle(document.body).getPropertyValue('--pink-dark');
            
            ctx.clearRect(0,0,200,150); ctx.lineWidth=3; ctx.beginPath();
            
            // POTENCE (BLEU)
            ctx.strokeStyle = mainColor;
            if(game.mistakes>0){ctx.moveTo(20,140);ctx.lineTo(180,140);} 
            if(game.mistakes>1){ctx.moveTo(50,140);ctx.lineTo(50,20);} 
            if(game.mistakes>2){ctx.lineTo(130,20);} 
            if(game.mistakes>3){ctx.moveTo(130,20);ctx.lineTo(130,40);}
            ctx.stroke(); 
            
            // BONHOMME (ROSE)
            ctx.beginPath(); ctx.strokeStyle = pinkColor;
            if(game.mistakes>4){ctx.beginPath();ctx.arc(130,55,15,0,Math.PI*2);ctx.stroke();} 
            if(game.mistakes>5){ctx.beginPath();ctx.moveTo(130,70);ctx.lineTo(130,110);ctx.stroke();} 
            ctx.beginPath(); 
            if(game.mistakes>6){ctx.moveTo(130,80);ctx.lineTo(110,95);} 
            if(game.mistakes>7){ctx.moveTo(130,80);ctx.lineTo(150,95);} 
            if(game.mistakes>8){ctx.moveTo(130,110);ctx.lineTo(115,135);} 
            if(game.mistakes>9){ctx.moveTo(130,110);ctx.lineTo(145,135);} 
            ctx.stroke();
            if(game.mistakes>10){ctx.font="14px Arial"; ctx.fillStyle=pinkColor; ctx.textAlign="center"; ctx.fillText("x x",130,60);} 
            
            const restartArea = document.getElementById('pendu-restart-area');
            const setupArea = document.getElementById('pendu-setup');
            const keyboard = document.getElementById('pendu-keyboard');

            if(game.state==='setup'){ 
                status.innerText="En attente d'un mot..."; setupArea.style.display='block'; keyboard.style.display='none'; restartArea.style.display='none'; document.getElementById('pendu-word-display').innerText="???"; 
            } else { 
                setupArea.style.display='none'; 
                let d=""; for(let c of game.word) d+=(game.guessed.includes(c)?c:"_")+" "; document.getElementById('pendu-word-display').innerText=d; 
                const isCreator = game.creator === currentUser;
                
                if(game.state==='playing') { 
                    status.innerText = isCreator ? "L'autre devine..." : "Devine !";
                    keyboard.style.display = 'flex'; restartArea.style.display='none';
                    let k=""; "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('').forEach(l=>{ const disabled = isCreator || game.guessed.includes(l) ? "disabled" : ""; k+=`<button class="key-btn" onclick="playPenduMove('${l}')" ${disabled}>${l}</button>`; }); 
                    keyboard.innerHTML=k; 
                }
                else {
                    status.innerText = game.state==='win' ? "GAGN√â ! üéâ" : ("PERDU... Le mot √©tait : "+game.word);
                    keyboard.style.display='none';
                    restartArea.style.display='block';
                }
            }
        }
        window.startPendu=function(){const w=document.getElementById('pendu-secret').value.toUpperCase().trim(); if(w) setDoc(doc(db,"games","pendu_active"),{state:'playing',word:w,guessed:[],mistakes:0, creator:currentUser});}
        window.startPenduSetup=function(){ setDoc(doc(db,"games","pendu_active"),{state:'setup',word:"",guessed:[],mistakes:0, creator:""}); }
        window.playPenduMove=async function(l){ 
            if(!activePendu||activePendu.state!=='playing')return; const ng=[...activePendu.guessed,l]; let nm=activePendu.mistakes; if(!activePendu.word.includes(l))nm++; 
            let ns='playing'; let save=false;
            if(nm>=11) { ns='loose'; save=true; } else if(activePendu.word.split('').every(c=>ng.includes(c))) { ns='win'; save=true; }
            await updateDoc(doc(db,"games","pendu_active"),{guessed:ng,mistakes:nm,state:ns});
            if(save) addDoc(collection(db, "games_pendu_history"), { word: activePendu.word, setter: activePendu.creator, result: ns, timestamp: serverTimestamp() });
        }

        // P4
        let activeP4 = null;
        onSnapshot(doc(db, "games", "p4_active"), (s) => { activeP4 = s.exists() ? s.data() : null; if(activeP4) renderP4(activeP4); else document.getElementById('p4-status').innerText = "Aucune partie en cours"; });
        onSnapshot(doc(db, "games", "p4_scores"), (s) => { const sc = s.exists() ? s.data() : {fr:0, tw:0}; document.getElementById('score-p4').innerText = `üèÜ Th√©o: ${sc.fr} | Elise: ${sc.tw}`; });
        onSnapshot(query(collection(db, "games_p4_history"), orderBy("timestamp", "desc"), limit(5)), (s) => {
            const list = document.getElementById('p4-history-list'); list.innerHTML = "";
            s.forEach(d => { const h = d.data(); list.innerHTML += `<div class="hist-row"><span>${h.winner==='fr'?'Th√©o':'Elise'} a gagn√©</span><span>en ${h.moves} coups</span></div>`; });
        });

        window.initP4 = function() { setDoc(doc(db, "games", "p4_active"), { board: Array(42).fill(0), turn: currentUser, winner: null, moves: 0, starter: currentUser }); }

        function renderP4(game) {
            const grid=document.getElementById('p4-grid'); grid.innerHTML="";
            const status = document.getElementById('p4-status');
            const btn = document.getElementById('p4-restart-btn');
            
            if(game.winner) {
                status.innerText = game.winner === 'fr' ? "üèÜ BRAVO TH√âO !" : "üèÜ BRAVO ELISE !";
                btn.disabled = false; btn.style.opacity = "1";
            } else {
                status.innerText = (game.turn === 'fr' ? "Au tour de Th√©o (Bleu)" : "Au tour d'Elise (Rose)");
                btn.disabled = true; btn.style.opacity = "0.5";
            }
            
            for(let i=0; i<42; i++) { 
                const c=document.createElement('div'); c.className="p4-cell "+(game.board[i]===1?'p1':(game.board[i]===2?'p2':'')); 
                c.onclick=()=>playP4(i%7); grid.appendChild(c); 
            }
        }

        window.playP4 = async function(col) {
            if(!activeP4||activeP4.winner) return;
            if(activeP4.turn !== currentUser) { alert("Attends ton tour !"); return; }
            let board=[...activeP4.board]; let row=5; while(row>=0){ if(board[row*7+col]===0){ board[row*7+col]=(currentUser==='fr'?1:2); break; } row--; }
            if(row<0) return;
            const checkWin=b=>{for(let r=0;r<6;r++)for(let c=0;c<4;c++){let i=r*7+c;if(b[i]&&b[i]==b[i+1]&&b[i]==b[i+2]&&b[i]==b[i+3])return b[i]}for(let r=0;r<3;r++)for(let c=0;c<7;c++){let i=r*7+c;if(b[i]&&b[i]==b[i+7]&&b[i]==b[i+14]&&b[i]==b[i+21])return b[i]}for(let r=3;r<6;r++)for(let c=0;c<4;c++){let i=r*7+c;if(b[i]&&b[i]==b[i-6]&&b[i]==b[i-12]&&b[i]==b[i-18])return b[i]}for(let r=0;r<3;r++)for(let c=0;c<4;c++){let i=r*7+c;if(b[i]&&b[i]==b[i+8]&&b[i]==b[i+16]&&b[i]==b[i+24])return b[i]}return 0};
            const winnerCode = checkWin(board); let winner = null; let moves = activeP4.moves + 1;
            if(winnerCode !== 0) { 
                winner = winnerCode === 1 ? 'fr' : 'tw'; 
                const scoreRef = doc(db, "games", "p4_scores"); const scoreSnap = await getDoc(scoreRef);
                const scores = scoreSnap.exists() ? scoreSnap.data() : {fr:0, tw:0}; scores[winner]++; setDoc(scoreRef, scores);
                addDoc(collection(db, "games_p4_history"), { winner: winner, moves: Math.ceil(moves/2), timestamp: serverTimestamp() });
            }
            updateDoc(doc(db,"games","p4_active"),{ board:board, turn:currentUser==='fr'?'tw':'fr', winner:winner, moves:moves });
        }

        // --- BASICS ---
        function updatePresence() { setDoc(doc(db, "status", "presence"), { [currentUser]: Date.now() }, { merge: true }); }
        setInterval(updatePresence, 5000); updatePresence();
        onSnapshot(doc(db, "status", "presence"), (docSnap) => {
            if(docSnap.exists()) {
                const d = docSnap.data(); const now = Date.now();
                const isOnlineFr = (now - d.fr) < 15000 && d.fr !== 0; 
                const isOnlineTw = (now - d.tw) < 15000 && d.tw !== 0;
                document.getElementById('dot-fr').classList.toggle('online', isOnlineFr);
                document.getElementById('dot-tw').classList.toggle('online', isOnlineTw);
            }
        });
        
        async function updateWeather() { try { const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=45.77,24.99&longitude=3.08,121.30&current_weather=true"); const d=await r.json(); document.getElementById('weather-fr').innerText=`‚òÄÔ∏è ${Math.round(d[0].current_weather.temperature)}¬∞C`; document.getElementById('weather-tw').innerText=`‚òÄÔ∏è ${Math.round(d[1].current_weather.temperature)}¬∞C`; } catch(e){} }
        updateWeather();
        const dateDepart = new Date("2026-02-14T00:00:00+01:00").getTime(); const dateRetour = new Date("2026-07-05T08:00:00+02:00").getTime(); 
        function updateCountdown() {
            const now=new Date().getTime(); let p=0;
            if(now>dateDepart && now<dateRetour) p=((now-dateDepart)/(dateRetour-dateDepart))*100; if(now>dateRetour) p=100;
            const dist=(now<dateDepart?dateDepart:dateRetour)-now; const dDisplay=dist>0?dist:0;
            const days=Math.floor(dDisplay/(1000*60*60*24));
            document.getElementById('days-count').innerText=days; document.getElementById('days-unit').innerText=days<=1?"JOUR":"JOURS";
            document.getElementById('sub-count').innerText=`${Math.floor((dDisplay%(1000*60*60*24))/(1000*60*60))} h et ${Math.floor((dDisplay%(1000*60*60))/(1000*60))} min`;
            document.getElementById('countdown-title').innerText=now<dateDepart?"D√âPART DANS":"RETROUVAILLES DANS";
            document.getElementById("prog-fill").style.width=p+"%"; document.getElementById("prog-heart").style.left=p+"%";
        } setInterval(updateCountdown,1000);

        function getCurrentTime(role) { return new Date().toLocaleTimeString('fr-FR', { timeZone: role==='fr'?'Europe/Paris':'Asia/Taipei', hour:'2-digit', minute:'2-digit' }); }
        function sendNtfy(msg, tag, prio) { 
            const iconUrl = new URL("icon.jpg", window.location.href).href; 
            fetch(`https://ntfy.sh/${currentUser==='tw'?"lovetravel-2026-reception-theo":"lovetravel-2026-reception-elise"}`, { method:'POST', body:msg, headers:{'Title':currentUser==='tw'?"Elise":"Theo",'Priority':prio,'Tags':tag,'Icon':iconUrl} }).catch(e=>{}); 
        }

        window.sendBisou = function() {
            addDoc(collection(db, "actions"), { type: 'bisou', from: currentUser, timestamp: serverTimestamp() });
            sendNtfy(`üíã Bisou envoy√© ! (${getCurrentTime(currentUser)})`, "kiss,heart", "urgent");
            const n = document.getElementById("notif"); n.classList.add("show"); setTimeout(()=>n.classList.remove("show"),3000);
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }
        onSnapshot(doc(db, "status", "moods"), (doc) => {
            if (doc.exists()) {
                const d = doc.data();
                document.getElementById("mood-img-fr").src = `theo_${d.fr_outfit || 0}.png`; document.getElementById("mood-msg-fr").innerText = d.fr_text || "";
                document.getElementById("mood-img-tw").src = `elise_${d.tw_outfit || 0}.png`; document.getElementById("mood-msg-tw").innerText = d.tw_text || "";
            } else { setDoc(doc(db, "status", "moods"), { fr_outfit:0, tw_outfit:0 }); }
        });
        window.updateMood = function(emoji, text, outfitId) {
            setDoc(doc(db, "status", "moods"), { [currentUser+"_emoji"]: emoji, [currentUser+"_text"]: text, [currentUser+"_outfit"]: (outfitId !== undefined ? outfitId : 5) }, { merge: true });
            sendNtfy(`${emoji} ${text} (${getCurrentTime(currentUser)})`, "partly_sunny", "low");
        }
        window.customMood = function() { const text = prompt("Ta phrase :"); if(text) updateMood("‚ú®", text, 5); }

        let allLetters = [];
        const qLetters = query(collection(db, "letters"), orderBy("timestamp", "desc"));
        onSnapshot(qLetters, (snapshot) => {
            allLetters = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            updateMailboxView();
        });
        window.showTab = function(tabName) {
            const tabInbox = document.getElementById('tab-inbox'); const tabSent = document.getElementById('tab-sent');
            if(tabName === 'inbox') {
                tabInbox.classList.add('active'); tabInbox.style.background = 'var(--pink)'; tabInbox.style.color = 'white';
                tabSent.classList.remove('active'); tabSent.style.background = 'transparent'; tabSent.style.color = 'var(--text-main)';
                document.getElementById('list-inbox').style.display='block'; document.getElementById('list-sent').style.display='none';
            } else {
                tabSent.classList.add('active'); tabSent.style.background = 'var(--blue)'; tabSent.style.color = 'white';
                tabInbox.classList.remove('active'); tabInbox.style.background = 'transparent'; tabInbox.style.color = 'var(--text-main)';
                document.getElementById('list-inbox').style.display='none'; document.getElementById('list-sent').style.display='block';
            }
        }
        window.updateMailboxView = function() {
            const listInbox = document.getElementById("list-inbox"); const listSent = document.getElementById("list-sent");
            listInbox.innerHTML = ""; listSent.innerHTML = "";
            allLetters.forEach(l => {
                const div = document.createElement("div"); div.className = `envelope-item ${(!l.read && l.by !== currentUser) ? 'unread' : ''}`;
                div.innerHTML = `<div style="margin-right:15px; font-size:1.5rem;">${l.read ? 'üì©' : '‚úâÔ∏è'}</div><div style="flex:1;"><div style="font-weight:bold; font-size:0.9rem;">${l.title}</div><div style="font-size:0.7rem; color:var(--text-sub);">${l.by === currentUser ? 'Envoy√© √† l\'autre' : 'De: ' + (l.by==='fr'?'Th√©o':'Elise')}</div></div>${l.by === currentUser ? `<button onclick="deleteLetter('${l.id}', event)" style="border:none;background:none;color:#faa;">‚úï</button>` : ''}`;
                div.onclick = (e) => { if(e.target.tagName === 'BUTTON') return; openLetterModal(l); };
                if(l.by === currentUser) listSent.appendChild(div); else listInbox.appendChild(div);
            });
        }
        window.showTab('inbox');

        window.addLetter = function() { const t=document.getElementById("letter-title").value; const c=document.getElementById("letter-content").value; if(!t||!c)return; addDoc(collection(db,"letters"),{title:t,content:c,by:currentUser,read:false,timestamp:serverTimestamp()}); document.getElementById("letter-title").value="";document.getElementById("letter-content").value=""; sendNtfy("üíå Nouvelle lettre ! ("+getCurrentTime(currentUser)+")","email","low"); }
        window.openLetterModal = function(l) { document.getElementById('letter-modal').style.display="flex"; document.getElementById('modal-letter-title').innerText=l.title; document.getElementById('modal-letter-content').innerText=l.content; if(l.by!==currentUser && !l.read) updateDoc(doc(db,"letters",l.id),{read:true}); }
        window.closeLetter = function() { document.getElementById('letter-modal').style.display="none"; }
        
        const compressImage = async (file) => { const bmp = await createImageBitmap(file); const cvs = document.createElement('canvas'); cvs.width=bmp.width*0.5; cvs.height=bmp.height*0.5; cvs.getContext('2d').drawImage(bmp,0,0,cvs.width,cvs.height); return cvs.toDataURL(file.type,0.6); };
        window.handlePhotoUpload = async function(inpt, role) { if(role!==currentUser){alert("Interdit !");return;} const f = inpt.files[0]; if(!f)return; document.getElementById('gallery-modal').style.display="none"; const b64 = await compressImage(f); await addDoc(collection(db,"photos"),{url:b64,by:role,timestamp:serverTimestamp()}); sendNtfy("üì∏ Nouvelle photo ! ("+getCurrentTime(currentUser)+")","camera","low"); }
        let allPhotos=[];
        onSnapshot(query(collection(db,"photos"),orderBy("timestamp","desc")), s=>{
            allPhotos=s.docs.map(d=>({id:d.id,...d.data()}));
            const lastFr=allPhotos.find(p=>p.by==='fr'); if(lastFr)document.getElementById('polaroid-img-fr').src=lastFr.url;
            const lastTw=allPhotos.find(p=>p.by==='tw'); if(lastTw)document.getElementById('polaroid-img-tw').src=lastTw.url;
        });
        window.openGallery = function(role) { const m=document.getElementById('gallery-modal'); const g=document.getElementById('modal-grid'); g.innerHTML=""; allPhotos.filter(p=>p.by===role).forEach(p=>{ 
            const dStr = p.timestamp ? new Date(p.timestamp.toDate()).toLocaleDateString() : "";
            g.innerHTML+=`<div><img src="${p.url}" class="modal-img" onclick="document.getElementById('lightbox').style.display='flex';document.getElementById('lightbox-img').src='${p.url}'"><div class="photo-date">${dStr}</div>${role===currentUser?`<div style="color:red;font-size:0.8rem;text-align:center;margin-top:5px;cursor:pointer;" onclick="deletePhoto('${p.id}')">Supprimer</div>`:''}</div>`; 
        }); m.style.display="block"; }
        window.closeGallery = () => document.getElementById('gallery-modal').style.display='none';
        window.closeLightbox = () => document.getElementById('lightbox').style.display='none';

        window.addTodo=function(){const t=document.getElementById('todo-input').value;if(!t)return;addDoc(collection(db,"todos"),{text:t,done:false,created:serverTimestamp()});document.getElementById('todo-input').value="";sendNtfy("üìù Projet ! ("+getCurrentTime(currentUser)+")","clipboard","low");}
        window.toggleTodo = function(id, state) { updateDoc(doc(db, "todos", id), { done: state }); }
        onSnapshot(query(collection(db,"todos"),orderBy("created","desc")),s=>{ const l=document.getElementById('todo-list');l.innerHTML=""; s.forEach(d=>{const t=d.data();l.innerHTML+=`<div class="todo-item"><input type="checkbox" class="todo-check" ${t.done?'checked':''} onchange="toggleTodo('${d.id}',this.checked)"><span class="todo-text ${t.done?'done':''}">${t.text}</span><button onclick="deleteTodo('${d.id}')" class="todo-del">‚úï</button></div>`;}); });

        window.addBook=function(){const t=document.getElementById('book-title').value;if(!t)return;addDoc(collection(db,"books"),{title:t,pages_total:parseInt(document.getElementById('book-pages').value)||200,created:serverTimestamp(),page_fr:0,rating_fr:0,page_tw:0,rating_tw:0});document.getElementById('book-title').value="";}
        window.updatePage = function(id, role, val, max, title) { const newPage = parseInt(val); updateDoc(doc(db, "books", id), { ["page_"+role]: newPage }); if(newPage >= max) sendNtfy(`üéâ ${title} termin√© ! (${getCurrentTime(currentUser)})`, "tada", "low"); }
        window.rateBook = function(id, role, rating) { updateDoc(doc(db, "books", id), { ["rating_"+role]: rating }); }
        onSnapshot(query(collection(db,"books"),orderBy("created","desc")),s=>{
             const l=document.getElementById('book-list');l.innerHTML="";
             s.forEach(docSnap=>{
                 const book = docSnap.data(); const id = docSnap.id; const totalPages = book.pages_total || 200;
                 const frPage = book.page_fr || 0; const frRating = book.rating_fr || 0;
                 const twPage = book.page_tw || 0; const twRating = book.rating_tw || 0;
                 const frPercent = Math.min((frPage / totalPages) * 100, 100); const twPercent = Math.min((twPage / totalPages) * 100, 100);
                 const makeStars = (role, currentRating) => {
                    let html = ''; for(let i=1; i<=5; i++) { const filled = i <= currentRating ? 'filled' : ''; const action = role === currentUser ? `onclick="rateBook('${id}', '${role}', ${i})"` : ''; const cursor = role === currentUser ? 'pointer' : 'default'; html += `<span class="star ${filled}" style="cursor:${cursor}" ${action}>‚òÖ</span>`; }
                    if(role === currentUser) html += `<span class="star-reset" onclick="rateBook('${id}', '${role}', 0)">√ò</span>`; return html;
                 };
                 const canEditFr = currentUser === 'fr' ? '' : 'disabled'; const canEditTw = currentUser === 'tw' ? '' : 'disabled';
                 l.innerHTML+=`<div class="book-item"><div class="book-title"><span>${book.title}</span><button style="border:none;background:none;color:var(--text-sub);font-size:0.8rem;cursor:pointer;" onclick="deleteBook('${id}')">‚úï</button></div><div class="book-total-pages">${totalPages} pages</div><div class="user-row"><div class="row-header"><span style="color:var(--blue);font-weight:bold;font-size:0.8rem;">TH√âO</span><div class="star-rating">${makeStars('fr', frRating)}</div></div><div class="user-inputs"><input type="number" class="page-input" value="${frPage}" ${canEditFr} onchange="updatePage('${id}', 'fr', this.value, ${totalPages}, '${book.title}')" placeholder="0"><div class="book-progress-track"><div class="book-progress-bar" style="width:${frPercent}%; background:var(--blue);"></div></div></div></div><div class="user-row" style="border:none;"><div class="row-header"><span style="color:var(--pink);font-weight:bold;font-size:0.8rem;">ELISE</span><div class="star-rating">${makeStars('tw', twRating)}</div></div><div class="user-inputs"><input type="number" class="page-input" value="${twPage}" ${canEditTw} onchange="updatePage('${id}', 'tw', this.value, ${totalPages}, '${book.title}')" placeholder="0"><div class="book-progress-track"><div class="book-progress-bar" style="width:${twPercent}%; background:var(--pink);"></div></div></div></div></div>`;
             });
        });

        // NOTIF BISOUS RE√áU
        onSnapshot(query(collection(db,"actions"),orderBy("timestamp","desc"),limit(1)),s=>{
            if(!s.empty){const a=s.docs[0].data(); if(a.from!==currentUser && Math.abs(Date.now()-a.timestamp.toMillis())<60000){
                document.getElementById("notif").innerHTML=`üíã <b>${a.from==='fr'?'Th√©o':'Elise'}</b> t'envoie un bisou !`;
                document.getElementById("notif").classList.add("show"); if(navigator.vibrate)navigator.vibrate([100,50,100]);
                setTimeout(()=>document.getElementById("notif").classList.remove("show"),4000);
            }}
        });
        
        function updateClocks(){
            const now=new Date();
            document.getElementById('clock-fr').innerText=now.toLocaleTimeString('fr-FR',{timeZone:'Europe/Paris',hour:'2-digit',minute:'2-digit'});
            document.getElementById('clock-tw').innerText=now.toLocaleTimeString('fr-FR',{timeZone:'Asia/Taipei',hour:'2-digit',minute:'2-digit'});
        } setInterval(updateClocks,1000); updateClocks();

    </script>
</body>
</html>
