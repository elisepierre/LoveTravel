<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Love Travel - TEST PIXEL</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f4f7f6; padding: 20px; padding-bottom: 200px; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button { padding: 15px; width: 100%; margin: 5px 0; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-role { background: #ddd; color: #333; }
        .btn-role.active { background: #4a90e2; color: white; border: 2px solid #2c3e50; }
        #bisou-btn { background: #ff4b6e; color: white; font-size: 24px; height: 80px; width: 80px; border-radius: 50%; position: fixed; bottom: 30px; right: 30px; box-shadow: 0 5px 15px rgba(255, 75, 110, 0.4); }
        
        /* BOITE NOIRE DE DEBUG */
        #console { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 180px; 
            background: #000; color: #0f0; font-family: monospace; font-size: 11px; 
            overflow-y: scroll; text-align: left; padding: 10px; border-top: 2px solid #333; z-index: 9999;
        }
        .log-time { color: #888; }
        .log-warn { color: yellow; }
        .log-err { color: red; }
        .log-success { color: #00ff00; font-weight: bold; }
    </style>
</head>
<body>

    <h2>üõ†Ô∏è MODE DIAGNOSTIC</h2>

    <div class="card">
        <h3>1. Identit√© (Sur le Pixel)</h3>
        <p>Tu dois √™tre ELISE pour recevoir.</p>
        <button id="btn-tw" class="btn-role" onclick="setRole('tw')">JE SUIS ELISE (TW)</button>
        <button id="btn-fr" class="btn-role" onclick="setRole('fr')">JE SUIS TH√âO (FR)</button>
        <div id="role-display" style="margin-top:5px; font-weight:bold;">...</div>
    </div>

    <div class="card">
        <h3>2. Test Mat√©riel</h3>
        <button onclick="testVibration()" style="background:orange; color:white;">TESTER VIBRATION</button>
        <p style="font-size:12px; color:#666;">Si √ßa ne vibre pas ici, le Pixel est en silencieux ou bloqu√©.</p>
    </div>

    <button id="bisou-btn" onclick="sendBisou()">üíã</button>

    <div id="console">D√©marrage du syst√®me...<br></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA7ZNlC1ILS9-W3bgxWogUA6ak4c29a4Ns", authDomain: "lovetravel-35285.firebaseapp.com", projectId: "lovetravel-35285", storageBucket: "lovetravel-35285.firebasestorage.app", messagingSenderId: "189902268760", appId: "1:189902268760:web:b461ce15d8c396be479d2d" };
        
        function log(msg, type='') {
            const c = document.getElementById('console');
            const t = new Date().toLocaleTimeString();
            let colorClass = '';
            if(type==='err') colorClass='log-err';
            if(type==='success') colorClass='log-success';
            c.innerHTML = `<span class="log-time">[${t}]</span> <span class="${colorClass}">${msg}</span><br>` + c.innerHTML;
        }

        log("Connexion Firebase...");
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        log("Firebase initialis√©.");

        let role = localStorage.getItem('role') || 'tw';
        updateUI();

        window.setRole = function(r) {
            role = r;
            localStorage.setItem('role', r);
            updateUI();
            log(`R√¥le chang√© : ${role === 'tw' ? 'ELISE' : 'TH√âO'}`);
        }

        function updateUI() {
            document.getElementById('btn-tw').className = role === 'tw' ? 'btn-role active' : 'btn-role';
            document.getElementById('btn-fr').className = role === 'fr' ? 'btn-role active' : 'btn-role';
            document.getElementById('role-display').innerText = "Tu es : " + (role === 'tw' ? 'ELISE' : 'TH√âO');
        }

        window.testVibration = function() {
            log("Tentative vibration locale...");
            if(!navigator.vibrate) {
                log("ERREUR: Navigateur ne supporte pas la vibration.", 'err');
                return;
            }
            const result = navigator.vibrate([200, 100, 200]);
            if(result) log("Vibration envoy√©e au syst√®me (Tu as senti ?)", 'success');
            else log("Vibration bloqu√©e par le syst√®me (Mode silencieux ?)", 'err');
        }

        window.sendBisou = function() {
            log("Envoi d'un bisou vers le Cloud...");
            addDoc(collection(db, "actions"), {
                type: 'bisou',
                from: role,
                timestamp: Date.now()
            });
        }

        // √âCOUTE
        log("Mise sur √©coute de la fr√©quence 'Bisou'...");
        const q = query(collection(db, "actions"), orderBy("timestamp", "desc"), limit(1));
        
        onSnapshot(q, (snapshot) => {
            if(snapshot.metadata.fromCache) {
                log("‚ö†Ô∏è ATTENTION: Donn√©es venant du Cache (Pas d'internet ?)", 'err');
            }

            if(!snapshot.empty) {
                const data = snapshot.docs[0].data();
                const diff = Date.now() - data.timestamp;

                // On loggue TOUT ce qu'on re√ßoit pour comprendre
                log(`Signal re√ßu: De ${data.from} (il y a ${Math.round(diff/1000)}s)`);

                if(diff < 60000) { // Moins de 1 minute
                    if(data.from !== role) {
                        log(">>> BISOU VALID√â ! VIBRATION !", 'success');
                        if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
                        else log("Pas de moteur de vibration d√©tect√©", 'err');
                    } else {
                        log("Ignor√©: C'est moi l'exp√©diteur");
                    }
                } else {
                    log("Ignor√©: Trop vieux");
                }
            }
        }, (error) => {
            log("ERREUR CRITIQUE FIREBASE: " + error.message, 'err');
        });

    </script>
</body>
</html>
