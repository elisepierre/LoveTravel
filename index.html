<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, orderBy, limit, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyA7ZNlC1ILS9-W3bgxWogUA6ak4c29a4Ns", authDomain: "lovetravel-35285.firebaseapp.com", projectId: "lovetravel-35285", storageBucket: "lovetravel-35285.firebasestorage.app", messagingSenderId: "189902268760", appId: "1:189902268760:web:b461ce15d8c396be479d2d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentUser = localStorage.getItem('userRole') || 'tw'; 
        updateIdentityUI();

        window.setUser = function(role) { currentUser = role; localStorage.setItem('userRole', role); updateIdentityUI(); }
        function updateIdentityUI() { document.getElementById('btn-user-fr').classList.remove('active'); document.getElementById('btn-user-tw').classList.remove('active'); document.getElementById('btn-user-' + currentUser).classList.add('active'); }

        window.testVibration = function() {
            if(navigator.vibrate) { 
                navigator.vibrate([200]); 
                alert("Ã‡a vibre !");
            } else {
                alert("Pas de vibration dÃ©tectÃ©e sur ce navigateur.");
            }
        }

        // --- ECOUTE BISOUS (CORRIGÃ‰ AVEC HEURE SERVEUR) ---
        const qBisou = query(collection(db, "actions"), orderBy("timestamp", "desc"), limit(1));
        
        onSnapshot(qBisou, (snapshot) => {
            if(!snapshot.empty) {
                const action = snapshot.docs[0].data();
                
                // IMPORTANT : Si le message vient d'Ãªtre envoyÃ©, le timestamp serveur peut Ãªtre null quelques millisecondes
                // On attend qu'il soit validÃ©.
                if (!action.timestamp) return;

                // On convertit le Timestamp Google en millisecondes
                const actionTime = action.timestamp.toMillis();
                const now = Date.now();
                const diff = Math.abs(now - actionTime); // On utilise la valeur absolue pour Ã©viter les bugs d'horloge nÃ©gatifs
                
                // On accepte les messages de moins de 60 secondes
                if (diff < 60000) {
                    if (action.from !== currentUser) {
                        triggerBisouEffect(action.from);
                    }
                }
            }
        });

        function triggerBisouEffect(fromWho) {
            const senderName = fromWho === 'fr' ? "ThÃ©o" : "Elise";
            
            const notif = document.getElementById("notif");
            notif.innerHTML = `ðŸ’‹ <b>${senderName}</b> t'envoie un bisou !`;
            notif.style.display = "block";
            setTimeout(() => notif.classList.add("show"), 10);
            
            if(navigator.vibrate) {
                // SÃ©quence de vibration "CÅ“ur qui bat"
                navigator.vibrate([200, 100, 200, 500, 200, 100, 200]);
            }
            
            setTimeout(() => { notif.classList.remove("show"); setTimeout(() => notif.style.display = "none", 300); }, 4000);
        }

        window.sendBisou = function() {
            const btn = document.getElementById('bisou-btn');
            btn.style.transform = "scale(1.3)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
            
            // ICI LE CHANGEMENT : On utilise serverTimestamp() au lieu de Date.now()
            // C'est Google qui dÃ©cide de l'heure, pas le tÃ©lÃ©phone.
            addDoc(collection(db, "actions"), { 
                type: 'bisou', 
                from: currentUser, 
                timestamp: serverTimestamp() 
            });

            const notif = document.getElementById("notif");
            notif.innerText = "ðŸ’‹ Bisou envoyÃ© !";
            notif.style.display = "block";
            setTimeout(() => notif.classList.add("show"), 10);
            setTimeout(() => { notif.classList.remove("show"); setTimeout(() => notif.style.display = "none", 300); }, 2000);
        }

        // --- RESTE DU CODE (STATUS, LIVRES...) ---
        onSnapshot(doc(db, "status", "moods"), (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                document.getElementById("mood-display-fr").innerText = data.fr || "ðŸ˜¶";
                document.getElementById("mood-display-tw").innerText = data.tw || "ðŸ˜¶";
            } else { setDoc(doc(db, "status", "moods"), { fr: "â¤ï¸", tw: "â¤ï¸" }); }
        });
        window.updateMood = function(emoji) { setDoc(doc(db, "status", "moods"), { [currentUser]: emoji }, { merge: true }); }
        
        const qBooks = query(collection(db, "books"), orderBy("created", "desc"));
        onSnapshot(qBooks, (snapshot) => {
            const list = document.getElementById("book-list"); list.innerHTML = "";
            snapshot.forEach((doc) => {
                const book = doc.data();
                const div = document.createElement('div'); div.className = "book-item";
                div.innerHTML = `<div><div class="book-title">${book.title}</div><div class="book-prog">AjoutÃ© par ${book.by === 'fr' ? 'ThÃ©o' : 'Elise'}</div></div><button class="btn-del">âœ•</button>`;
                div.querySelector('.btn-del').onclick = () => { if(confirm("Supprimer ?")) deleteDoc(doc.ref); };
                list.appendChild(div);
            });
        });
        window.addBook = function() { const input = document.getElementById("book-input"); if (!input.value) return; addDoc(collection(db, "books"), { title: input.value, by: currentUser, created: serverTimestamp() }); input.value = ""; }

        const startDate = new Date("2026-02-14T00:00:00").getTime();
        const endDate = new Date("2026-07-10T00:00:00").getTime();
        function updateCountdown() {
            const now = new Date().getTime(); const total = endDate - startDate; const current = now - startDate;
            let percent = (current / total) * 100; if (percent < 0) percent = 0; if (percent > 100) percent = 100;
            document.getElementById("prog-fill").style.width = percent + "%";
            document.getElementById("plane").style.left = `calc(${percent}% - 14px)`;
            const dist = endDate - now;
            const days = Math.floor(dist / (1000 * 60 * 60 * 24)); const hours = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const display = document.getElementById("countdown");
            if (now < startDate) display.innerText = "DÃ©collage le 14 FÃ©vrier... â³";
            else if (dist < 0) display.innerText = "Retrouvailles ! â¤ï¸";
            else display.innerText = `${days} jours et ${hours}h restants`;
        }
        setInterval(updateCountdown, 1000); updateCountdown();
    </script>
