<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Love Travel - DEBUG</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: 'Montserrat', sans-serif; background-color: #f4f7f6; padding-bottom: 250px; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        .header { background: #ff4b6e; color: white; padding: 15px; text-align: center; border-radius: 0 0 20px 20px; margin-bottom: 20px;}
        
        /* BOUTONS */
        .btn { width: 100%; padding: 15px; margin-bottom: 10px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-perm { background: #333; color: white; }
        .btn-role { background: #ddd; color: #333; }
        .btn-role.active { background: #4a90e2; color: white; border: 2px solid #000; }
        
        #bisou-btn { position: fixed; bottom: 160px; right: 20px; width: 80px; height: 80px; border-radius: 50%; background: #ff4b6e; color: white; font-size: 30px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100;}

        /* CONSOLE VISUELLE (Pour voir ce qui se passe) */
        #logs { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 150px; 
            background: black; color: #00ff00; font-family: monospace; font-size: 12px; 
            overflow-y: scroll; padding: 10px; border-top: 4px solid #333; z-index: 1000;
        }
        .log-line { margin-bottom: 2px; border-bottom: 1px solid #333; }
        .log-err { color: red; background: #220000; }
        .log-succ { color: yellow; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h2>üõ†Ô∏è MODE R√âPARATION</h2>
        <p>Regarde les logs en bas üëá</p>
    </div>

    <div class="container">
        <button class="btn btn-perm" onclick="askPerm()">1. CLIQUER ICI POUR ACTIVER VIBRATION</button>
        <button class="btn btn-perm" onclick="testVib()">2. TESTER VIBRATION (BZZZ)</button>

        <hr>

        <p>Qui es-tu ? (V√©rifie bien !)</p>
        <button id="btn-tw" class="btn btn-role" onclick="setRole('tw')">JE SUIS ELISE (TW)</button>
        <button id="btn-fr" class="btn btn-role" onclick="setRole('fr')">JE SUIS TH√âO (FR)</button>

        <hr>
        <p>Dernier message re√ßu : <span id="last-msg">Aucun</span></p>
    </div>

    <button id="bisou-btn" onclick="sendBisou()">üíã</button>

    <div id="logs">D√©marrage du syst√®me...<br></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- FONCTION D'ECRITURE DANS LA BOITE NOIRE ---
        function log(msg, type="") {
            const box = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            let color = type === 'err' ? 'log-err' : (type === 'succ' ? 'log-succ' : '');
            box.innerHTML = `<div class="log-line ${color}">[${time}] ${msg}</div>` + box.innerHTML;
        }

        log("Initialisation Firebase...");

        const firebaseConfig = { apiKey: "AIzaSyA7ZNlC1ILS9-W3bgxWogUA6ak4c29a4Ns", authDomain: "lovetravel-35285.firebaseapp.com", projectId: "lovetravel-35285", storageBucket: "lovetravel-35285.firebasestorage.app", messagingSenderId: "189902268760", appId: "1:189902268760:web:b461ce15d8c396be479d2d" };
        
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            log("Firebase connect√© OK.");
        } catch (e) {
            log("ERREUR FIREBASE: " + e.message, "err");
        }

        // GESTION ROLE
        let role = localStorage.getItem('role') || 'tw';
        updateRoleUI();
        window.setRole = function(r) { role = r; localStorage.setItem('role', r); updateRoleUI(); log("R√¥le chang√©: " + r); }
        function updateRoleUI() {
            document.getElementById('btn-tw').className = role === 'tw' ? 'btn btn-role active' : 'btn btn-role';
            document.getElementById('btn-fr').className = role === 'fr' ? 'btn btn-role active' : 'btn btn-role';
        }

        // PERMISSIONS
        window.askPerm = function() {
            log("Demande permission...");
            Notification.requestPermission().then(p => {
                log("Permission notif: " + p);
                if (navigator.vibrate) log("Navigateur supporte vibration: OUI");
                else log("Navigateur supporte vibration: NON", "err");
            });
        }

        window.testVib = function() {
            log("Tentative vibration...");
            if(navigator.vibrate) {
                navigator.vibrate([500]);
                log("Ordre vibration envoy√© ! Tu as senti ?", "succ");
            } else {
                log("Erreur: Vibrate non disponible", "err");
            }
        }

        // --- LE COEUR DU SYSTEME (HARCELEUR) ---
        // On ne s'arr√™te jamais. Toutes les 2 secondes, on force la lecture.
        let lastId = localStorage.getItem('lastId') || "";

        setInterval(async () => {
            // log("V√©rification..."); // Je le commente pour pas spammer l'√©cran, d√©commente si besoin
            
            try {
                const q = query(collection(db, "actions"), orderBy("timestamp", "desc"), limit(1));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const docSnap = snapshot.docs[0];
                    const data = docSnap.data();
                    const id = docSnap.id;

                    // Afficher pour debug
                    document.getElementById('last-msg').innerText = `${data.type} de ${data.from}`;

                    // Si c'est un nouveau message
                    if (id !== lastId) {
                        log(`NOUVEAU MESSAGE D√âTECT√â ! (De ${data.from})`, "succ");
                        lastId = id;
                        localStorage.setItem('lastId', id);

                        // Si c'est pas moi qui l'ai envoy√©
                        if (data.from !== role) {
                            log(">>> C'EST POUR MOI ! VIBRATION !", "succ");
                            
                            // 3 m√©thodes de vibration pour √™tre s√ªr
                            if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);
                            
                            if(Notification.permission === "granted") {
                                new Notification("üíã BISOU !", { body: `De ${data.from === 'fr' ? 'Th√©o' : 'Elise'}`, vibrate: [500, 200, 500] });
                            }
                        } else {
                            log("Ignor√©: C'est moi l'envoyeur.");
                        }
                    }
                }
            } catch (e) {
                log("ERREUR DE LECTURE: " + e.message, "err");
            }

        }, 2000); // Toutes les 2 secondes

        // ENVOI
        window.sendBisou = async function() {
            log("Envoi en cours...");
            try {
                await addDoc(collection(db, "actions"), { type: 'bisou', from: role, timestamp: Date.now() });
                log("Bisou envoy√© avec succ√®s !", "succ");
            } catch (e) {
                log("ECHEC ENVOI: " + e.message, "err");
            }
        }

    </script>
</body>
</html>
